<!DOCTYPE html>
<html>
    <head>
        <title>FootViz - Fantasy</title>
        
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
        <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
        <style>
        /* --- Estilos Base y Layout Principal --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a1a2e; /* Azul oscuro de fondo */
            color: #e0e0e0;
            padding: 20px;
        }
        .dashboard-container {
            display: grid;
            grid-template-areas:
                "header header header"
                "main-left main-right main-right"
                "main-left mvp graph";
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            min-height: calc(100vh - 40px);
        }

        /* --- Ubicaci칩n de secciones --- */
        .fantasy-header { grid-area: header; }
        .main-left-column { grid-area: main-left; display: flex; flex-direction: column; gap: 20px; }
        .main-right-column { grid-area: main-right; display: flex; flex-direction: column; gap: 20px; }
        #mvp-section { grid-area: mvp; }
        #graph-section { grid-area: graph; }

        /* --- Estilos de Tarjetas --- */
        .card {
            background-color: #1e1e3f;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        h2, h3 { color: #ffffff; margin-bottom: 15px; }

        /* --- Estilos de Header --- */
        .fantasy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            margin-bottom: 20px;
        }
        .user-profile-summary { display: flex; align-items: center; gap: 15px; }
        .user-level-xp { text-align: right; }
        .user-icons { display: flex; gap: 10px; font-size: 1.5rem; }
        .user-icons ion-icon { cursor: pointer; }

        /* --- Estilos de Secciones --- */
        #stadium-banner img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; }
        #points-chart { max-width: 100%; background-color: #2a2a4a; border-radius: 8px; }
        .league-table table { width: 100%; text-align: center; }
        .league-table th, .league-table td { padding: 5px; }
        #fixtures-list button { background-color: #4a69ff; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-bottom: 10px; }
        #fixtures-list li { list-style: none; margin-bottom: 5px; }

        /* --- Estilos para la lista de MVPs --- */
        #mvp-list {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .mvp-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2a2a4a;
            font-size: 0.9rem;
        }
        .mvp-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .mvp-rank {
            font-weight: 700;
            font-size: 1.1rem;
            color: #ffffff;
            width: 25px;
            text-align: center;
        }
        .mvp-player-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .mvp-player-info {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .mvp-club-img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
        }
        .mvp-points {
            font-weight: 700;
            font-size: 1.1rem;
            color: #4a69ff;
        }

        /* --- 游녢 NUEVOS ESTILOS PARA EL CAMPO DE F칔TBOL 游녢 --- */
        #team-display-visual {
            position: relative; /* Para posicionar a los jugadores */
            height: 400px; /* Altura del campo */
            background-color: #132972; /* Verde campo */
            
            background-size: 50px 50px; /* Tama침o de las rayas */
            border-radius: 8px;
            overflow: hidden; /* Asegura que los jugadores no se salgan */
            padding: 10px; /* Un peque침o padding interior */

            /* Organiza las 4 filas (POR, DEF, MED, DEL) verticalmente */
            display: flex;
            flex-direction: column; 
            justify-content: space-around;
        }   
        .pitch-row {
            display: flex;
            /* Centra y espacia a los jugadores horizontalmente */
            justify-content: space-around; 
            align-items: center;
        }
        

        /* Jugador individual en el campo */
        .player-on-field {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            color: #ffffff;
            font-size: 0.7rem;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            padding: 5px;
            width: 60px; /* Damos un ancho fijo para que no se peguen */
        }

        .player-on-field img {
            width: 50px; /* Tama침o de la imagen del jugador */
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #4a69ff; /* Borde de color para destacar */
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            margin-bottom: 3px;
        }

        .player-on-field.captain img {
            border-color: gold; /* Borde dorado para el capit치n */
            box-shadow: 0 0 10px rgba(255,215,0,0.8);
        }
        /* Posicionamiento para las diferentes l칤neas */
        /* Portero */
        .player-on-field.pos-G { top: 85%; left: 50%; transform: translateX(-50%); }
        /* Defensas */
        .player-on-field.pos-D.slot-1 { top: 65%; left: 15%; }
        .player-on-field.pos-D.slot-2 { top: 65%; left: 35%; }
        .player-on-field.pos-D.slot-3 { top: 65%; left: 65%; }
        .player-on-field.pos-D.slot-4 { top: 65%; left: 85%; }
        /* Mediocampistas */
        .player-on-field.pos-M.slot-1 { top: 40%; left: 15%; }
        .player-on-field.pos-M.slot-2 { top: 40%; left: 35%; }
        .player-on-field.pos-M.slot-3 { top: 40%; left: 65%; }
        .player-on-field.pos-M.slot-4 { top: 40%; left: 85%; }
        /* Delanteros */
        .player-on-field.pos-F.slot-1 { top: 15%; left: 30%; }
        .player-on-field.pos-F.slot-2 { top: 15%; left: 70%; }
        /* Fallback para m치s de 4 defensas/mediocampistas o 2 delanteros */
        .player-on-field.pos-D:nth-child(5) { top: 70%; left: 50%; transform: translateX(-50%); }
        .player-on-field.pos-M:nth-child(5) { top: 45%; left: 50%; transform: translateX(-50%); }
        .player-on-field.pos-F:nth-child(3) { top: 20%; left: 50%; transform: translateX(-50%); }


        /* --- Responsividad B치sica --- */
        @media (max-width: 900px) {
            .dashboard-container {
                grid-template-areas:
                    "header"
                    "main-left"
                    "main-right"
                    "mvp"
                    "graph";
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }
            .main-right-column { flex-direction: row; flex-wrap: wrap; }
            .league-table { flex-basis: calc(50% - 10px); }
        }
         @media (max-width: 600px) {
            .main-right-column { flex-direction: column; }
            .league-table { flex-basis: 100%; }
            .fantasy-header { flex-direction: column; gap: 10px; }
            #team-display-visual { height: 300px; } /* Ajustar altura en m칩viles */
            .player-on-field img { width: 40px; height: 40px; }
            .player-on-field { font-size: 0.6rem; }
         }
        </style>
    </head>
    <body>
        <div class="dashboard-container">

            <header class="fantasy-header">
                <div class="user-profile-summary">
                    <ion-icon name="extension-puzzle-outline" title="Mis Piezas"></ion-icon>
                    <div class="user-level-xp"> 
                        <div>
                            Nivel <strong id="user-level">7</strong>
                        </div>
                        <div>
                            <span id="user-xp">179</span>
                        </div>
                    </div>
                    <h2 id="username-display">Nombre</h2>
                </div>
                <div class="user-icons">
                    <ion-icon name="trophy-outline" title="Mis Logros"></ion-icon>
                    <ion-icon name="person-circle-outline" title="Mi Perfil"></ion-icon>
                </div>
            </header>

            <div class="main-left-column">
                <section id="stadium-banner" class="card">
                    <img src="placeholder-stadium.jpg" alt="Banner Estadio">
                </section>

                <section id="my-team-section" class="card">
                    <h3>Mi Equipo</h3> 
                    <div id="team-display-visual">
                        <p id="verificar-equipo-text">Aqui aparecera el equipo</p>
                    </div>
                    <div id="team-controls" style="margin-top: 15px; text-align: center;">
                        <span>Presupuesto: <strong id="budget-remaining">-- M</strong></span> |
                        <span>Fichajes Restantes: <strong id="transfers-remaining">--</strong></span>
                        <p>Deadline: <strong id="deadline-timer">Jueves 23:59 (hora centro de Mexico)</strong></p> 
                        <button onclick="window.location.href='mi-equipo.html'" id="manage-team-button">Gestionar Equipo</button>
                    </div>
                </section>
            </div>

            <div class="main-right-column">
                <section id="fixtures-section" class="card">
                    <button id="view-all-fixtures-btn" onclick="window.location.href='predicciones.html'">Predicciones</button>
                    <h3>Proximos Partidos</h3> 
                    <ul id="fixtures-list">
                        <li>Barcelona vs Osasuna</li>
                        <li>Real Madrid vs Cadiz</li>
                    </ul>
                </section>

                <div class="league-table card" id="global-league">
                    <h3>Liga Global</h3> 
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nombre</th>
                                <th>Pts</th>
                            </tr>
                        </thead>
                        <tbody id="global-league-ranking">
                            <tr>
                                <td>132</td>
                                <td>Usuario Pepito</td>
                                <td>82</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="league-table card" id="local-league">
                    <h3>Liga Local (<span id="local-league-country">Pa칤s</span>)</h3> <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nombre</th>
                                <th>Pts</th>
                            </tr>
                        </thead>
                        <tbody id="local-league-ranking">
                            <tr>
                                <td>12</td>
                                <td>Uusario Pepito</td>
                                <td>82</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <section id="mvp-section" class="card">
                <h2>MVPs de la Jornada <span id="mvp-gameweek"></span></h2>
                <ol id="mvp-list"></ol>
            </section>
            <section id="graph-section" class="card">
                <h2>Puntuaci칩n en las 칰ltimas jornadas</h2> 
                <canvas id="points-chart"></canvas>
                <p id="points-graph-placeholder" style="display: none;">(Gr치fica aparecer치 aqu칤)</p>
            </section>
            <section id="graph-section" class="card">
                <h2>Puntuaci칩n en las 칰ltimas jornadas</h2> 
                <canvas id="points-chart"></canvas>
                <p id="points-graph-placeholder" style="display: none;">(Gr치fica aparecer치 aqu칤)</p>
            </section>

        </div>

        <script>
            presupuestoRestante = document.getElementById('budget-remaining');
            fichajesRestantes = document.getElementById('transfers-remaining');
            async function cargarDatosDashboard() { 
                try {
                    const response = await fetch('/api/fantasy-dashboard'); // El navegador env칤a la cookie

                    if (response.status === 401 || response.status === 403) {
                        // 춰Sesi칩n inv치lida o expirada!
                        alert("Tu sesi칩n ha expirado. Por favor, inicia sesi칩n de nuevo.");
                        window.location.href = '/login.html'; // Redirigir al login
                        return;
                    }

                    if (!response.ok) {
                        throw new Error('Error al cargar los datos del dashboard.');
                    }
                    
                    const data = await response.json();
                    userData = data.userData;
                    username = document.getElementById('username-display');
                    username.innerHTML =`${userData.username}`;
                    userXp = document.getElementById('user-xp');
                    userXp.innerHTML = `${userData.xp_total} XP`;
                    nivel = document.getElementById('user-level');
                    nivel.innerHTML = `${userData.nivel}`;

                    equipoData = data.equipoData;
                    textoVerifiacion = document.getElementById('verificar-equipo-text');
                    botonManejador = document.getElementById('manage-team-button');
                    const teamDisplayVisual = document.getElementById('team-display-visual'); // Referencia al campo
                    if (equipoData) {
                        textoVerifiacion.style.display = 'none'; // Ocultar el texto
                        botonManejador.innerHTML = "Gestionar Equipo";
                        botonManejador.onclick = function() { window.location.href='mi-equipo.html' };
                        presupuestoRestante.innerHTML=`$${equipoData.presupuesto_restante}M`;
                        fichajesRestantes.innerHTML=`${equipoData.fichajes_jornada_restantes}`;

                        // --- 游녢 NUEVO: Renderizar plantilla en el campo 游녢 ---
                        if (data.plantillaConDetalles && data.plantillaConDetalles.length > 0) {
                            renderizarPlantillaEnCampo(data.plantillaConDetalles, teamDisplayVisual);
                        } else {
                            teamDisplayVisual.innerHTML = "<p style='color:#fff; text-align:center;'>No hay jugadores en tu plantilla titular.</p>";
                        }
                        // --- 游녡 FIN NUEVO ---

                    } else {
                        textoVerifiacion.style.display = 'block'; // Mostrar el texto
                        textoVerifiacion.innerHTML = "A칰n no has creado un equipo.";
                        botonManejador.innerHTML = "Crear Equipo";
                        botonManejador.onclick = function() { window.location.href='crear-equipo.html' };
                        presupuestoRestante.innerHTML = "N/A";
                        fichajesRestantes.innerHTML = "N/A";
                        teamDisplayVisual.innerHTML = "<p style='color:#fff; text-align:center;'>Accede a Crear Equipo</p>"; // Mensaje si no hay equipo
                    }
                    

                    


                } catch (error) {
                    console.error("Error:", error);
                }

                
                
            } 

            function renderizarPlantillaEnCampo(plantilla, container) {
                container.innerHTML = ''; // Limpia el <p> "Cargando equipo..."

                const titulares = plantilla.filter(p => p.es_titular === 1);

                if (titulares.length === 0) {
                    container.innerHTML = "<p style='color:#fff; text-align:center;'>No hay jugadores titulares en tu plantilla.</p>";
                    return;
                }

                // 1. Crear las 4 filas de la cancha
                const rowG = document.createElement('div');
                rowG.className = 'pitch-row';
                rowG.id = 'pitch-row-G'; // Para Porteros

                const rowD = document.createElement('div');
                rowD.className = 'pitch-row';
                rowD.id = 'pitch-row-D'; // Para Defensas

                const rowM = document.createElement('div');
                rowM.className = 'pitch-row';
                rowM.id = 'pitch-row-M'; // Para Medios

                const rowF = document.createElement('div');
                rowF.className = 'pitch-row';
                rowF.id = 'pitch-row-F'; // Para Delanteros
                
                // 2. A침adir las filas al contenedor del campo en el orden visual
                container.appendChild(rowF); // Delanteros arriba
                container.appendChild(rowM);
                container.appendChild(rowD);
                container.appendChild(rowG); // Portero abajo

                // 3. Iterar sobre los 11 titulares y a침adir cada uno a su fila
                titulares.forEach(player => {
                    let targetRow;
                    
                    // Asigna el jugador a la fila correcta
                    switch(player.posicion) {
                        case 'G': targetRow = rowG; break;
                        case 'D': targetRow = rowD; break;
                        case 'M': targetRow = rowM; break;
                        case 'F': targetRow = rowF; break;
                        default:  targetRow = rowM; // Fallback por si acaso
                    }

                    const playerDiv = document.createElement('div');
                    playerDiv.classList.add('player-on-field'); // Ya no necesita 'pos-X' o 'slot-X'
                    
                    if (player.es_capitan === 1) {
                        playerDiv.classList.add('captain');
                    }

                    // Usamos un fallback por si la imagen del jugador es null
                    const playerImgSrc = player.url_imagen_jugador || 'placeholder-player-face.png';
                    
                    // Mostramos solo el primer nombre para que quepa
                    const firstName = player.nombre_jugador; 

                    playerDiv.innerHTML = `
                        <img src="${playerImgSrc}" alt="${player.nombre_jugador}">
                        <span>${firstName}</span> 
                    `;
                    targetRow.appendChild(playerDiv);
                });
            }

            function cargarProximosPartidos() {
                const fixturesList = document.getElementById('fixtures-list');
    
                fetch(`/api/fantasy/proximos-partidos`)
                    .then(res => {
                        if (!res.ok) throw new Error('Error al cargar pr칩ximos partidos');
                        return res.json();
                    })
                    .then(data => {
                        fixturesList.innerHTML = ""; // Limpiar la lista de placeholders

                        if (data.length === 0) {
                            fixturesList.innerHTML = "<li>No hay partidos programados.</li>";
                            return;
                        }

                        
                        

                        // Creamos un <li> para cada partido
                        data.forEach(partido => {
                            const li = document.createElement('li');
                            
                            // A침adimos estilos para que se vea bien, como en tu maqueta
                            li.style.display = 'flex';
                            li.style.alignItems = 'center';
                            li.style.justifyContent = 'center';
                            li.style.gap = '10px';
                            li.style.padding = '5px 0';

                            // Usamos 'data-partido-id' para poder hacerlos clicables en el futuro
                            li.dataset.partidoId = partido.id_partido; 
                            
                            li.innerHTML = `
                                <span style="display: flex; align-items: center; gap: 8px;">
                                    <img src="${partido.escudo_local}" alt="${partido.nombre_local}" style="width: 24px; height: 24px; border-radius: 50%;">
                                    ${partido.nombre_local}
                                </span>
                                <span style="font-weight: 600;">vs</span>
                                <span style="display: flex; align-items: center; gap: 8px;">
                                    ${partido.nombre_visitante}
                                    <img src="${partido.escudo_visitante}" alt="${partido.nombre_visitante}" style="width: 24px; height: 24px; border-radius: 50%;">
                                </span>
                            `;
                            fixturesList.appendChild(li);
                        });
                    })
                    .catch(err => {
                        console.error("Error cargando pr칩ximos partidos:", err);
                        fixturesList.innerHTML = "<li>Error al cargar partidos.</li>";
                    });
            }

            function cargarMVP() {
                const mvpList = document.getElementById('mvp-list'); // 1. Obtener el contenedor de la lista

                fetch(`/api/fantasy/mvp-de-la-jornada`)
                .then(res => {
                    if (!res.ok) throw new Error('Error al cargar MVP');
                    return res.json();
                })
                .then(data => {
                    mvpList.innerHTML = ""; // Limpiar lista

                    if (data.length === 0) {
                        mvpList.innerHTML = "<p>A칰n no disponible.</p>"; // Mensaje si est치 vac칤o
                        return; 
                    }
                    
                    // 2. Iterar sobre los jugadores (hasta 5)
                    data.forEach((player, index) => {
                        const li = document.createElement('li');
                        li.classList.add('mvp-item'); // A침adir clase para el estilo

                        // 3. Construir el HTML para cada jugador
                        li.innerHTML = `
                            <span class="mvp-rank">${index + 1}</span>
                            <img src="${player.url_imagen_jugador || 'placeholder-player-face.png'}" alt="${player.nombre_jugador}" class="mvp-player-img">
                            <div class="mvp-player-info">
                                <span class="mvp-player-name">${player.nombre_jugador}</span>
                                <img src="${player.img_equipo}" alt="${player.nombre_equipo}" class="mvp-club-img" title="${player.nombre_equipo}">
                            </div>
                            <span class="mvp-points">${player.puntos_fantasy} Pts</span>
                        `;
                        mvpList.appendChild(li);
                    });

                    // 4. L칩gica de la jornada
                    const nextGameweekEl = document.getElementById('current-gameweek-fixtures');
                    
                })
                .catch(err => {
                    console.error("Error cargando MVP:", err);
                    mvpList.innerHTML = "<li>Error al cargar.</li>";
                });
            }

            
            cargarDatosDashboard();
            cargarMVP();
            cargarProximosPartidos();
            
        </script>

    </body>
</html>