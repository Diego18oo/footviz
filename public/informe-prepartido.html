<!DOCTYPE html>
<html>
    <head>
        <title>FootViz - PrePartido</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: 'Poppins', sans-serif;
                background-color: #1a1a2e;
                color: #e0e0e0;
                padding: 20px;
                transition: background-color 0.3s, color 0.3s;
            }
            /* --- Cabecera A√±adida --- */
            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                max-width: 1240px;
                margin: 0 auto 30px auto;
                padding-bottom: 20px;
                border-bottom: 1px solid #2a2a4a;
                transition: border-bottom-color 0.3s;
            }
            .header h1 { font-size: 2rem; color: #ffffff; font-weight: 700; cursor: pointer;}
            .theme-toggle-button {
                background: #2a2a4a; border: 1px solid #4a4a6a; color: #fff; width: 42px; height: 42px;
                padding: 10px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;
                display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;
            }
            .theme-toggle-button:hover { background: #3a3a5a; transform: scale(1.1); }
            h2 {
                font-size: 1.2rem; font-weight: 600; color: #ffffff; margin-bottom: 20px;
                padding-bottom: 10px; border-bottom: 1px solid #4a4a6a; text-align: center;
                transition: color 0.3s, border-bottom-color 0.3s;
            }
            .card {
                background-color: #1e1e3f; border-radius: 12px; padding: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); width: 100%; max-width: 1240px; margin: 20px auto;
                transition: background-color 0.3s, box-shadow 0.3s;
            }
            /* --- Info General del Partido --- */
            #info-general { display: flex; justify-content: space-between; align-items: center; }
            .info-partido { text-align: center; }
            .info-partido p { margin: 5px 0; font-size: 1.1em; color: #ffffff; font-weight: 600; }
            .info-partido p:first-child, .info-partido p:last-child { font-size: 0.9em; color: #a0a0c0; font-weight: 400; }
            .equipo img { width: 100px; height: auto; cursor: pointer;}
            /* --- Alineaciones --- */
            .alineaciones-wrapper { display: flex; justify-content: space-between; max-width: 1240px; margin: 20px auto; gap: 20px; flex-wrap: wrap; }
            .alineacion-container { flex: 1; min-width: 400px; text-align: center; }
            #formacion-local-titulo, #formacion-visitante-titulo { font-size: 1em; color: #a0a0c0; margin-top: 0; margin-bottom: 15px; font-weight: 400; }
            #campo-local, #campo-visitante { border-radius: 8px; max-width: 100%; height: auto; }
            /* --- Dashboard --- */
            .dashboard-wrapper { display: flex; align-items: flex-start; gap: 20px; max-width: 1240px; margin: 20px auto; }
            .dashboard-column-left, .dashboard-column-right { display: flex; flex-direction: column; gap: 20px; }
            .dashboard-column-left { flex: 2; }
            .dashboard-column-right { flex: 2; }
            /* --- √öltimos Enfrentamientos --- */
            #ultimos-enfrentamientos p { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #2a2a4a; font-size: 0.9rem; transition: border-bottom-color 0.3s; }
            #ultimos-enfrentamientos p:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
            #ultimos-enfrentamientos img { width: 30px; border-radius: 50%; }
            /* --- Comparaci√≥n de Estad√≠sticas --- */
            .stat-comparison { margin-bottom: 20px; }
            .stat-comparison:last-child { margin-bottom: 0; }
            .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 14px; }
            .stat-label { font-weight: bold; color: #e0e0e0; }
            .stat-value-local, .stat-value-visitor { padding: 4px 10px; border-radius: 12px; color: white; font-weight: bold; min-width: 40px; text-align: center; }
            .stat-value-local { background-color: #007bff; }
            .stat-value-visitor { background-color: #ff4d4d; }
            .stat-bar-container { width: 100%; height: 10px; background-color: #ff4d4d; border-radius: 5px; overflow: hidden; }
            .stat-bar-local { height: 100%; background-color: #007bff; border-radius: 5px; transition: width 0.5s ease-in-out; }

            /* ------------------------- */
            /* --- ESTILOS MODO LUZ --- */
            /* ------------------------- */
            body.light-mode { background-color: #f4f4f9; color: #333333; }
            body.light-mode .header { border-bottom-color: #e0e0e0; }
            body.light-mode .header h1, body.light-mode h2, body.light-mode .info-partido p { color: #1a1a2e; }
            body.light-mode .theme-toggle-button { background: #ffffff; border-color: #d1d1d1; color: #333; }
            body.light-mode .theme-toggle-button:hover { background: #f0f0f0; }
            body.light-mode .card { background-color: #ffffff; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
            body.light-mode h2 { border-bottom-color: #e0e0e0; }
            body.light-mode .info-partido p:first-child, body.light-mode .info-partido p:last-child, body.light-mode #formacion-local-titulo, body.light-mode #formacion-visitante-titulo { color: #666; }
            body.light-mode .stat-label { color: #333; }
            body.light-mode #ultimos-enfrentamientos p { border-bottom-color: #e0e0e0; }
            .popular-picks-bar {
                display: flex; height: 25px; border-radius: 5px; overflow: hidden; background-color: #1a1a2e;
                font-size: 0.8rem; color: white;
            }
            .popular-picks-bar div {
                height: 100%; transition: width 0.5s;
                display: flex; align-items: center; justify-content: center;
            }
            .popular-local { background-color: #007bff; }
            .popular-empate { background-color: #6b7280; }
            .popular-visitante { background-color: #ff4d4d; }
            /* Estilos para la nueva tabla */
            #prob-matrix-container table {
                width: 100%;
                min-width: 600px;
                border-collapse: collapse;
                text-align: center;
            }
            #prob-matrix-container th, #prob-matrix-container td {
                padding: 8px;
                font-size: 0.8rem;
                border: 1px solid #2a2a4a;
            }
            #prob-matrix-container th {
                background-color: #2a2a4a;
                color: #fff;
            }
            #prob-matrix-container .header-local { background-color: #004a99; }
            #prob-matrix-container .header-visitante { background-color: #992c2c; }
            #prob-matrix-container td {
                background-color: #1e1e3f;
                color: #a0a0c0;
                font-weight: 600;
            }
            #prob-matrix-container td.prob-high { /* M√°s probable */
                background-color: #388e3c;
                color: #fff;
            }
            #prob-matrix-container td.prob-mid { /* Probable */
                background-color: #f5d34a;
                color: #1a1a2e;
            }

            .shot-maps-container {
                display: flex;
                flex-wrap: wrap;
                gap: 30px; /* Espacio entre los dos mapas */
                justify-content: center;
                margin-top: 20px;
            }

            /* Envoltorio de cada mapa (t√≠tulo + campo) */
            .shot-maps-container > div {
                flex: 1;
                min-width: 300px; /* Evita que se hagan muy angostos en m√≥vil */
                max-width: 500px; /* Evita que se hagan gigantes en monitores grandes */
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .shot-maps-container h3 {
                color: #a0a0c0;
                margin-bottom: 15px;
                font-size: 1.1rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            /* El contenedor del Canvas (El Campo) */
            .pitch-container {
                position: relative;
                width: 100%;
                /* Definimos una altura fija o un aspect-ratio vertical */
                height: 500px; 
                background-color: #2a5f2a; /* Color base mientras carga el JS */
                border-radius: 12px;
                overflow: hidden; /* Para que las l√≠neas no se salgan de las esquinas redondeadas */
                border: 2px solid #4a4a6a; /* Borde del campo */
                box-shadow: inset 0 0 30px rgba(0,0,0,0.3); /* Sombra interna para profundidad */
            }

            .pitch-container canvas {
                width: 100%;
                height: 100%;
                display: block;
            }

            /* Estilo del Tooltip (Flotante) */
            #shot-tooltip {
                position: absolute;
                background: rgba(20, 20, 35, 0.95); /* Fondo oscuro semi-transparente */
                color: #fff;
                padding: 10px 15px;
                border-radius: 8px;
                border: 1px solid #4a69ff;
                pointer-events: none; /* Importante para que el mouse no se "choque" con √©l */
                font-size: 0.85rem;
                z-index: 1000;
                box-shadow: 0 8px 20px rgba(0,0,0,0.5);
                transition: opacity 0.2s;
            }
        </style>
    </head>
    <body>
        <header class="header">
            <h1 onclick="window.location='index.html'">FootViz</h1>
            <h1>Informe Pre-Partido</h1>
            <button id="theme-toggle" class="theme-toggle-button">‚òÄÔ∏è</button>
        </header>
        <div id="info-general" class="card">
            
        </div>

        <div class="alineaciones-wrapper">
            <div class="card alineacion-container" id="id-alineacion-local-container">
                <h2>Posible Alineaci√≥n Local</h2>
                <h3 id="formacion-local-titulo"></h3> 
                <canvas id="campo-local" width="500" height="700"></canvas>
            </div>

            <div class="card alineacion-container" id="id-alineacion-visitante-container">
                <h2>Posible Alineaci√≥n Visitante</h2>
                <h3 id="formacion-visitante-titulo"></h3> 
                <canvas id="campo-visitante" width="500" height="700"></canvas>
            </div>
        </div>

        

        <div class="dashboard-wrapper">

            <!-- Columna Izquierda (m√°s ancha) -->
            <div class="dashboard-column-left">
                <div class="card" id="stats-comparison-container">
                    <!-- El contenido de la Comparativa de Estad√≠sticas se carga aqu√≠ -->
                </div>
            </div>

            <!-- Columna Derecha (contiene los otros dos elementos) -->
            <div class="dashboard-column-right">
                <div class="card">
                    <h2>Ultimos Enfrentamientos</h2>
                    <div id="ultimos-enfrentamientos">
                        <!-- El contenido se carga aqu√≠ -->
                    </div>
                </div>

                <div class="card">
                    <h2>Evoluci√≥n en la Temporada</h2>
                    <canvas id="evolucionChart"></canvas>
                </div>
            </div>

        </div>

        <div class="full-width-wrapper"> 
            <div class="card">
                <h2 class="card-title">Mapa de Disparos en la Temporada</h2>
                <p id="label-equipo" style="text-align: center; color: #a0a0c0; margin-bottom: 15px; font-size: 0.9rem;">
                    Pasa el mouse sobre los puntos para ver detalles.
                </p>
                
                <div class="shot-maps-container" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
                    <div style="flex: 1; min-width: 300px; text-align: center;">
                        <h3 id="shot-title-local">Local</h3>
                        <div class="pitch-container" style="position: relative; height: 600px; width: 100%;">
                            <canvas id="shot-map-local"></canvas>
                        </div>
                    </div>

                    <div style="flex: 1; min-width: 300px; text-align: center;">
                        <h3 id="shot-title-visitante">Visitante</h3>
                        <div class="pitch-container" style="position: relative; height: 600px; width: 100%;">
                            <canvas id="shot-map-visitante"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="shot-tooltip" style="display: none; position: absolute; background: rgba(20, 20, 35, 0.95); color: #fff; padding: 8px 12px; border-radius: 6px; border: 1px solid #4a69ff; pointer-events: none; font-size: 0.8rem; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5);"></div>

        <div class.card>
            <h2>Probabilidades de Marcador</h2>
            <p style="font-size: 0.9rem; color: #a0a0c0; margin-bottom: 15px;">Probabilidades calculadas usando un modelo de Poisson basado en el rendimiento de la temporada.</p>
            
            <div id="prob-resultado-bar" class="popular-picks-bar" style="margin-bottom: 20px; height: 25px; font-weight: 600;">
            </div>

            <div id="prob-matrix-container" style="overflow-x: auto;"></div>
        </div>

 
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const params = new URLSearchParams(window.location.search);
                const partidoParam = params.get("partido");
                let evolucionChartInstance = null;
                let equiposEvolucion = {}; 
                let shotsDataLocal = [];
                let shotsDataVisitante = [];
                let clickablePlayersLocal = [];     
                let clickablePlayersVisitante = [];
                
                const themeToggleButton = document.getElementById('theme-toggle');
                const body = document.body;

                const darkLineOptions = { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#e0e0e0' } }, title: { display: false } }, scales: { y: { reverse: true, min: 1, title: { display: true, text: 'Posici√≥n', color: '#e0e0e0' }, ticks: { color: '#a0a0c0', stepSize: 2 } }, x: { ticks: { color: '#a0a0c0' }, title: { display: true, text: 'Jornada', color: '#e0e0e0' } } } };
                const lightLineOptions = { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#333' } }, title: { display: false } }, scales: { y: { reverse: true, min: 1, title: { display: true, text: 'Posici√≥n', color: '#333' }, ticks: { color: '#666', stepSize: 2 } }, x: { ticks: { color: '#666' }, title: { display: true, text: 'Jornada', color: '#333' } } } };

                const applyTheme = (theme) => {
                    if (theme === 'light') {
                        body.classList.add('light-mode');
                        themeToggleButton.textContent = 'üåô';
                    } else {
                        body.classList.remove('light-mode');
                        themeToggleButton.textContent = '‚òÄÔ∏è';
                    }
                    if (partidoParam) {
                        cargarAlineacionLocal(partidoParam);
                        cargarAlineacionVisitante(partidoParam);
                        if(equiposEvolucion.local && equiposEvolucion.visitante){
                           cargarEvolucionEquipos(equiposEvolucion.local, equiposEvolucion.visitante, equiposEvolucion.total);
                        }
                    }
                };

                const savedTheme = localStorage.getItem('theme') || 'dark';
                if (savedTheme === 'light') { body.classList.add('light-mode'); themeToggleButton.textContent = 'üåô'; } 
                else { body.classList.remove('light-mode'); themeToggleButton.textContent = '‚òÄÔ∏è'; }

                themeToggleButton.addEventListener('click', () => {
                    const newTheme = body.classList.contains('light-mode') ? 'dark' : 'light';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                });
                
                const FORMACIONES = {
                    "4-4-2": [
                        [0.5, 0.9],   // Portero
                        // Defensas: LD, DFC, DFC, LI
                        [0.9, 0.7], [0.63, 0.7], [0.37, 0.7], [0.1, 0.7], 
                        // Medios: MD, MC, MC, MI
                        [0.9, 0.45], [0.63, 0.45], [0.37, 0.45], [0.1, 0.45], 
                        // Delanteros
                        [0.63, 0.2], [0.37, 0.2]  
                    ],
                    "4-2-3-1": [
                        [0.5, 0.9],   // Portero
                        // Defensas: LD, DFC, DFC, LI
                        [0.9, 0.7], [0.63, 0.7], [0.37, 0.7], [0.1, 0.7],
                        // Medios defensivos (2)
                        [0.63, 0.55], [0.37, 0.55], 
                        // Medios ofensivos: MD, MCO, MI
                        [0.85, 0.35], [0.5, 0.35], [0.15, 0.35], 
                        // Delantero
                        [0.5, 0.15]   
                    ],
                    "4-3-3": [
                        [0.5, 0.9],   // Portero
                        // Defensas: LD, DFC, DFC, LI
                        [0.9, 0.7], [0.63, 0.7], [0.37, 0.7], [0.1, 0.7], 
                        // Medios: Interior Derecho, Pivote, Interior Izquierdo
                        [0.75, 0.5], [0.5, 0.45], [0.25, 0.5], 
                        // Delanteros: Extremo Derecho, DC, Extremo Izquierdo
                        [0.8, 0.2], [0.5, 0.15], [0.2, 0.2]  
                    ],
                    "3-5-2": [
                        [0.5, 0.9], // Portero
                        // Defensas (3): Central Derecho, L√≠bero, Central Izquierdo
                        [0.75, 0.7], [0.5, 0.7], [0.25, 0.7], 
                        // Medios (5): Carrilero Derecho, Interior, Pivote, Interior, Carrilero Izquierdo
                        [0.9, 0.45], [0.7, 0.5], [0.5, 0.4], [0.3, 0.5], [0.1, 0.45], 
                        // Delanteros (2)
                        [0.63, 0.2], [0.37, 0.2] 
                    ],
                    "3-4-2-1": [
                        [0.5, 0.9], // Portero
                        // Defensas (3): Central Derecho, L√≠bero, Central Izquierdo
                        [0.75, 0.7], [0.5, 0.7], [0.25, 0.7], 
                        // Medios (4): Carrilero Derecho, Pivote Derecho, Pivote Izquierdo,  Carrilero Izquierdo
                        [0.9, 0.45], [0.63, 0.50], [0.37, 0.50], [0.1, 0.45],  
                        //Medios Ofensivos(2)
                        [0.63, 0.3], [0.37, 0.3],
                        // Delanteros (1)
                        [0.50, 0.2] 
                    ]

                };
                
                let nombreLocal = 'Equipo Local';
                let nombreVisitante = 'Equipo Visitante';

                // RQF1
                function cargarInfoPartido(partido){
                    fetch(`/api/info-prepartido/${partido}`).then(r => r.json()).then(data => {
                        if (!data) return;
                       
                        equiposEvolucion = { local: data.id_local, visitante: data.id_visitante, total: data.total_equipos_liga };
                        let infoPrincipal = document.getElementById("info-general");
                        const fechaParaMostrar = new Date(data.fecha).toISOString().split('T')[0];
                        const arbitro = data.arbitro_nombre || 'No asignado';
                        let momiosHTML = data.momio_local ? `${data.momio_local} | ${data.momio_empate} | ${data.momio_visitante}`: 'No disponibles';
                        
                        infoPrincipal.innerHTML = `
                            <div class="equipo"><img src="${data.escudo_local}" id="clubImgLocal"></div>
                            <div class="info-partido">
                                <p>${fechaParaMostrar}</p>
                                <p>${data.estadio_nombre}</p> 
                                <p>${arbitro}</p>
                                <p>${momiosHTML}</p> 
                            </div> 
                            <div class="equipo"><img src="${data.escudo_visitante}" id="clubImgVisitante"></div>`;

                        
                        // RQF8
                        document.getElementById("clubImgLocal").addEventListener("click", () => window.location.href = `club.html?id=${data.id_local}`);
                        document.getElementById("clubImgVisitante").addEventListener("click", () => window.location.href = `club.html?id=${data.id_visitante}`);

                        cargarEvolucionEquipos(data.id_local, data.id_visitante, data.total_equipos_liga);
                        cargarComparacionStats(data.id_local, data.id_visitante);
                        document.getElementById('shot-title-local').textContent = data.local_nombre; 
                        document.getElementById('shot-title-visitante').textContent = data.visitante_nombre;
                        cargarMapaDisparos(data.id_local, 'shot-map-local', shotsDataLocal);
                        cargarMapaDisparos(data.id_visitante, 'shot-map-visitante', shotsDataVisitante);
                    });  

                    
                }
                
                function dibujarCampo(ctx) {
                    const w = ctx.canvas.width;
                    const h = ctx.canvas.height;
                    const isLight = document.body.classList.contains('light-mode');

                    // Pasto
                    ctx.fillStyle = isLight ? '#d4e9d4' : '#2a5f2a';
                    ctx.fillRect(0, 0, w, h);

                    // Lineas
                    ctx.strokeStyle = isLight ? 'rgba(0,0,0,0.2)' : 'rgba(255,255,255,0.3)';
                    ctx.lineWidth = 2;

                    // Contorno
                    const margin = 15;
                    ctx.strokeRect(margin, margin, w - margin*2, h - margin*2);

                    // Area Grande 
                    ctx.strokeRect(w * 0.22, margin, w * 0.56, h * 0.16);
                    // Area Chica 
                    ctx.strokeRect(w * 0.37, margin, w * 0.26, h * 0.06);
                    // Porteria
                    ctx.strokeRect(w * 0.45, margin - 5, w * 0.1, 5);

                    // Medio Campo
                    ctx.beginPath();
                    ctx.moveTo(margin, h / 2);
                    ctx.lineTo(w - margin, h / 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(w / 2, h / 2, w * 0.1, 0, Math.PI * 2);
                    ctx.stroke();

                    // Area Grande 
                    ctx.strokeRect(w * 0.22, h - margin - (h * 0.16), w * 0.56, h * 0.16);
                    // Area Chica 
                    ctx.strokeRect(w * 0.37, h - margin - (h * 0.06), w * 0.26, h * 0.06);
                }

                function dibujarDisparo(ctx, shot, width, height) {
                    const margin = 15;
                    const fieldW = width - margin*2;
                    const fieldH = height - margin*2;

                    
                    const canvasX = margin + ((100 - shot.pitch_y) / 100) * fieldW;
                    const canvasY = margin + fieldH - ((shot.pitch_x / 80) * fieldH);

                    const radio = Math.max(3, Math.min(15, shot.xg * 20));

                    ctx.beginPath();
                    ctx.arc(canvasX, canvasY, radio, 0, Math.PI * 2);
                    
                    if (shot.resultado === 'goal') {
                        ctx.fillStyle = '#ffd700'; // Oro para Goles
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.4)';
                        ctx.lineWidth = 2;
                    } else if (shot.resultado === 'save' || shot.resultado === 'block') {
                        ctx.fillStyle = '#3b82f6'; // Azul para paradas/bloqueos
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.4)';
                    } else {
                        ctx.fillStyle = '#ef4444'; // Rojo para fallos
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.4)';
                    }
                    
                    ctx.fill();
                    if (shot.resultado === 'goal') ctx.stroke();

                    return { x: canvasX, y: canvasY, r: radio, data: shot };
                }

                // RQF2
                function cargarAlineacionLocal(partido){
                    fetch(`/api/alineaciones/${partido}`)
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('id-alineacion-local-container');
                        if (!data || !data.nombre1) {
                            console.warn("Los datos de la alineaci√≥n no est√°n disponibles.");
                            container.innerHTML = `
                                <h2>Posible Alineaci√≥n Local</h2>
                                <p style="padding: 40px 0; color: #a0a0c0;">
                                    Las alineaciones a√∫n no est√°n disponibles.
                                </p>
                            `;
                            return; 
                        }
                        const canvas = document.getElementById('campo-local');
                        if (!canvas.getContext) return;
                        const ctx = canvas.getContext('2d');

                        const jugadores = [];
                        for (let i = 1; i <= 11; i++) {
                            const dorsal = data[`dorsal${i}`] || data[`drosal${i}`];
                            jugadores.push({
                                id: data[`id${i}`],
                                nombre: data[`nombre${i}`],
                                imgUrl: data[`img${i}`]
                            });
                        }

                   
                        const formacionKey = data.formacion_local || "4-4-2";

                        document.getElementById('formacion-local-titulo').innerText = `Formaci√≥n: ${formacionKey}`;

                     
                        const formacionCoordenadas = FORMACIONES[formacionKey] || FORMACIONES["4-4-2"];

                        precargarImagenesYDibujar(ctx, jugadores, formacionCoordenadas, clickablePlayersLocal);
                    })
                    .catch(error => console.error('Error al cargar las alineaciones:', error));
                }

                async function cargarMapaDisparos(equipoId, canvasId, storeArray) {
                    const canvas = document.getElementById(canvasId);
                    if (!canvas) return;
                    
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                    const ctx = canvas.getContext('2d');

                    dibujarCampo(ctx);

                    try {
                        const res = await fetch(`/api/mapa-disparos/${equipoId}`); 
                        const disparos = await res.json();
                        
                        storeArray.length = 0;

                        if (!disparos || disparos.length === 0) {
                            ctx.fillStyle = "#a0a0c0";
                            ctx.font = "14px Poppins";
                            ctx.textAlign = "center";
                            ctx.fillText("No hay datos de disparos", canvas.width/2, canvas.height/2);
                            return;
                        }

                        disparos.forEach(shot => {
                            const shotData = dibujarDisparo(ctx, shot, canvas.width, canvas.height);
                            storeArray.push(shotData);
                        });

                        setupCanvasHover(canvas, storeArray);

                    } catch (e) {
                        console.error("Error cargando mapa de disparos:", e);
                    }
                }

                function setupCanvasHover(canvas, dataArray) {
                    const tooltip = document.getElementById('shot-tooltip');
                    
                    canvas.addEventListener('mousemove', (e) => {
                        const rect = canvas.getBoundingClientRect();
                        const mouseX = e.clientX - rect.left;
                        const mouseY = e.clientY - rect.top;
                        
                        let found = null;
                        
                        
                        for (let i = dataArray.length - 1; i >= 0; i--) {
                            const s = dataArray[i];
                            const dist = Math.sqrt((mouseX - s.x)**2 + (mouseY - s.y)**2);
                            if (dist <= s.r + 2) { 
                                found = s;
                                break;
                            }
                        }

                        if (found) {
                            tooltip.style.display = 'block';
                            tooltip.style.left = (e.pageX + 15) + 'px';
                            tooltip.style.top = (e.pageY + 15) + 'px';
                            
                            tooltip.innerHTML = `
                                <strong>${found.data.nombre}</strong><br>
                                <span style="color: #a0a0c0">${found.data.resultado.toUpperCase()}</span><br>
                                xG: <strong>${parseFloat(found.data.xg).toFixed(2)}</strong>
                            `;
                        } else {
                            tooltip.style.display = 'none';
                        }
                    });

                    canvas.addEventListener('mouseleave', () => {
                        tooltip.style.display = 'none';
                    });
                }

                function precargarImagenesYDibujar(ctx, jugadores, formacion, clickablePlayersArray) {
                    const promesasDeImagenes = jugadores.map(jugador => {

                        return new Promise((resolve, reject) => {
                            if (!jugador.imgUrl) {
                                resolve(null);
                                return;
                            }
                            const img = new Image();

                            img.crossOrigin = "Anonymous"; 

                            img.onload = () => resolve(img);

                            img.onerror = () => resolve(null);

                            img.src = jugador.imgUrl;

                        });

                    });
                    Promise.all(promesasDeImagenes)
                        .then(imagenesCargadas => {
                            jugadores.forEach((jugador, index) => {
                                jugador.imagenCargada = imagenesCargadas[index];
                            });
                            
                            dibujarAlineacion(ctx, jugadores, formacion, clickablePlayersArray);
                        });
                }
                
                    
                // RQF2
                function cargarAlineacionVisitante(partido){
                    fetch(`/api/alineaciones/${partido}`)
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('id-alineacion-visitante-container');
                        if (!data || !data.nombre1) {
                            console.warn("Los datos de la alineaci√≥n no est√°n disponibles.");
                            container.innerHTML = `
                                <h2>Posible Alineaci√≥n Local</h2>
                                <p style="padding: 40px 0; color: #a0a0c0;">
                                    Las alineaciones a√∫n no est√°n disponibles.
                                </p>
                            `;
                            return; 
                        }
                        const canvas = document.getElementById('campo-visitante');
                        if (!canvas.getContext) return;
                        const ctx = canvas.getContext('2d');

                        const jugadores = [];
                        for (let i = 12; i <= 22; i++) {
                            const dorsal = data[`dorsal${i}`] || data[`drosal${i}`];
                            jugadores.push({
                                id: data[`id${i}`],
                                nombre: data[`nombre${i}`],
                                imgUrl: data[`img${i}`]
                            });
                        }

                        const formacionKey = data.formacion_visitante || "4-4-2";

                        document.getElementById('formacion-visitante-titulo').innerText = `Formaci√≥n: ${formacionKey}`;

                        const formacionCoordenadas = FORMACIONES[formacionKey] || FORMACIONES["4-4-2"];
                        precargarImagenesYDibujar(ctx, jugadores, formacionCoordenadas, clickablePlayersVisitante);
                    })
                    .catch(error => console.error('Error al cargar las alineaciones:', error));
                }
                

                function dibujarAlineacion(ctx, jugadores, formacion, clickablePlayersArray) {
                    const canvas = ctx.canvas;
                    const width = canvas.width, height = canvas.height;
                    clickablePlayersArray.length = 0;
                    const isLight = body.classList.contains('light-mode');
                    ctx.fillStyle = isLight ? '#d4e9d4' : '#2a5f2a';
                    ctx.fillRect(0, 0, width, height);
                    ctx.strokeStyle = isLight ? 'rgba(0, 0, 0, 0.3)' : 'rgba(255, 255, 255, 0.3)';
                    jugadores.forEach((jugador, index) => {
                        if (formacion[index]) {
                            const x = formacion[index][0] * width;
                            const y = formacion[index][1] * height;
                            const radio = 22; 

                            clickablePlayersArray.push({
                                id: jugador.id,
                                x: x,
                                y: y,
                                radio: radio + 5 
                            });
                            
                            dibujarJugador(ctx, x, y, jugador, radio);
                        }
                    });
                }

                function dibujarJugador(ctx, x, y, jugador, radio) {
                    const isLight = body.classList.contains('light-mode');
                    ctx.save();
                    ctx.beginPath(); ctx.arc(x, y, radio, 0, 2 * Math.PI); ctx.clip();
                    if (jugador.imagenCargada) {
                        ctx.drawImage(jugador.imagenCargada, x - radio, y - radio, radio * 2, radio * 2);
                    } else {
                        ctx.fillStyle = isLight ? '#cce' : '#3a3a5a'; 
                        ctx.fill();
                    }
                    ctx.restore();
                    ctx.beginPath(); ctx.arc(x, y, radio, 0, 2 * Math.PI);
                    ctx.strokeStyle = isLight ? '#333' : '#FFFFFF';
                    ctx.lineWidth = 2; ctx.stroke();
                    ctx.fillStyle = isLight ? '#333' : '#FFFFFF';
                    ctx.font = 'bold 14px Poppins';
                    ctx.textAlign = 'center';
                    ctx.shadowColor = isLight ? 'rgba(255,255,255,0.5)' : 'black';
                    ctx.shadowBlur = 4;
                    ctx.fillText(jugador.nombre, x, y + radio + 14);
                    ctx.shadowBlur = 0;
                }

                // RQF6
                function cargarUltimosEnfrentamientos(partido){
                    const ultimosEnfrentamientos = document.getElementById('ultimos-enfrentamientos');
                    ultimosEnfrentamientos.innerHTML="";
                    fetch(`/api/ultimos-enfrentamientos/${partido}`)
                    .then(response => response.json())
                    .then(data => {
                        //RQNF3
                        if(data.length == 0){
                            const match = document.createElement("div");
                            match.innerHTML=`
                                <p>No hay enfrentamientos previos entre los equipos</p>    
                            `;
                        } else {
                            data.forEach((partido) => {
                                const fechaPartidoNormalizada = new Date(partido.fecha);
                                fechaPartidoNormalizada.setHours(0, 0, 0, 0);
                                const anio = fechaPartidoNormalizada.getFullYear();
                                const mesFormateado = String(fechaPartidoNormalizada.getMonth() + 1).padStart(2, '0');
                                const diaFormateado = String(fechaPartidoNormalizada.getDate()).padStart(2, '0');
                                const fechaParaMostrar = `${anio}-${mesFormateado}-${diaFormateado}`;
                                const match = document.createElement("div");
                                match.innerHTML=`
                                    <p>
                                        <img src="${partido.escudo_local}" alt="Escudo">
                                        ${partido.goles_local} - ${partido.goles_visitante}  
                                        <img src="${partido.escudo_visitante}" alt="Escudo">
                                        ${fechaParaMostrar}
                                    </p>    
                                `;
                                ultimosEnfrentamientos.appendChild(match);
                            })
                        }
                        
                    })
                }

                // RQF5
                function cargarComparacionStats(equipoLocal, equipoVisitante){
                    fetch(`/api/comparacion-estadisticas-equipos/${equipoLocal}/${equipoVisitante}`)
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('stats-comparison-container');
                        if (!data || data.length < 2) {
                            container.innerHTML = "<h2>Comparativa de Estad√≠sticas</h2><p>Estad√≠sticas no disponibles.</p>";
                            return;
                        }

                        const localStats = data[0];
                        const visitorStats = data[1];

                        const statsToShow = [
                            { key: 'posicion', label: 'Posicion' },
                            { key: 'puntos', label: 'Puntos' },
                            { key: 'victorias', label: 'Victorias' },
                            { key: 'goles_anotados', label: 'Goles Anotados' },
                            { key: 'goles_recibidos', label: 'Goles en Contra' },
                            { key: 'disparos', label: 'Disparos' },
                            { key: 'disparos_a_puerta', label: 'Disparos a Puerta' },
                            { key: 'pases_completados', label: 'Pases Completados' },
                            { key: 'tiros_de_esquina', label: 'Tiros de Esquina' },
                            { key: 'faltas', label: 'Faltas' },
                            { key: 'tarjetas_amarillas', label: 'Tarjetas Amarillas' },
                            { key: 'tarjetas_rojas', label: 'Tarjetas Rojas' }
                        ];

                        let finalHTML = '<h2>Comparativa de Estad√≠sticas</h2>';
                        statsToShow.forEach(stat => {
                            const localValue = parseFloat(localStats[stat.key]) || 0;
                            const visitorValue = parseFloat(visitorStats[stat.key]) || 0;
                            const total = localValue + visitorValue;

                            
                            let localPercentage = 50;
                            if (total > 0) {
                                localPercentage = (localValue / total) * 100;
                            }
                            
                            finalHTML += `
                                <div class="stat-comparison">
                                    <div class="stat-header">
                                        <span class="stat-value-local">${localValue}</span>
                                        <span class="stat-label">${stat.label}</span>
                                        <span class="stat-value-visitor">${visitorValue}</span>
                                    </div>
                                    <div class="stat-bar-container">
                                        <div class="stat-bar-local" style="width: ${localPercentage}%;"></div>
                                    </div>
                                </div>
                            `;
                        });
                        container.innerHTML = finalHTML;


                    })
                    .catch(error => {
                        console.error("Error al cargar las estad√≠sticas comparativas:", error);
                        document.getElementById('stats-comparison-container').innerHTML = "<h2>Comparativa de Estad√≠sticas</h2><p>No se pudieron cargar las estad√≠sticas.</p>";
                    });
                }
                
                //RQF4
                function cargarEvolucionEquipos(equipoLocal, equipoVisitante, totalEquiposLiga){
                    fetch(`/api/comparacion-evoluciones/${equipoLocal}/${equipoVisitante}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data || data.length < 2) {
                            console.warn("Datos de evoluci√≥n insuficientes.");
                            return;
                        }
                        const evolucionLocal = data.find(e => e.equipo === equipoLocal);
                        const evolucionVisitante = data.find(e => e.equipo === equipoVisitante);

                        if (!evolucionLocal || !evolucionVisitante) {
                            console.warn("No se encontraron los datos de evoluci√≥n para ambos equipos.");
                            return;
                        }
                        const datosLocal = [];
                        const datosVisitante = [];
                        let ultimaJornadaValida = 0;

                        
                        for (let i = 1; i <= 38; i++) {
                            const posLocal = evolucionLocal[`jornada${i}`];
                            const posVisitante = evolucionVisitante[`jornada${i}`];

                            
                            if (posLocal > 0 || posVisitante > 0) {
                                ultimaJornadaValida = i;
                            }
                            datosLocal.push(posLocal > 0 ? posLocal : null); 
                            datosVisitante.push(posVisitante > 0 ? posVisitante : null);
                        }
                        const labels = [];
                        for (let i = 1; i <= ultimaJornadaValida; i++) {
                            labels.push(`J${i}`);
                        }
                        const datosLocalRecortados = datosLocal.slice(0, ultimaJornadaValida);
                        const datosVisitanteRecortados = datosVisitante.slice(0, ultimaJornadaValida);

                        const ctx = document.getElementById('evolucionChart').getContext('2d');
                        const currentOptions = body.classList.contains('light-mode') ? lightLineOptions : darkLineOptions;
                        currentOptions.scales.y.max = totalEquiposLiga;
                        if (evolucionChartInstance) evolucionChartInstance.destroy();
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: nombreLocal, 
                                    data: datosLocalRecortados,
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    tension: 0.3,
                                    fill: false
                                }, {
                                    label: nombreVisitante, 
                                    data: datosVisitanteRecortados,
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    tension: 0.3,
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true, 
                                plugins: {
                                    legend: { position: 'top', labels: { color: '#e0e0e0' } },
                                    title: { display: false } 
                                },
                                scales: {
                                    y: {
                                        reverse: true, 
                                        min: 1,
                                        max: totalEquiposLiga,
                                        title: {
                                            display: true,
                                            text: 'Posici√≥n',
                                            color: '#e0e0e0'
                                        },
                                        ticks: { color: '#a0a0c0', stepSize: 2 },
                                    },
                                    x: {
                                        ticks: { color: '#a0a0c0' },
                                        title: {
                                            display: true,
                                            text: 'Jornada',
                                            color: '#e0e0e0'
                                        }
                                    }
                                }
                            }
                        });
                    })
                }

                function factorial(n) {
                    if (n === 0 || n === 1) return 1;
                    let result = 1;
                    for (let i = n; i > 1; i--) {
                        result *= i;
                    }
                    return result;
                }

                function poisson(lambda, k) {
                    return (Math.exp(-lambda) * Math.pow(lambda, k)) / factorial(k);
                }

                async function cargarProbabilidades(partidoId) {
                    const MAX_GOLES = 10; 
                    const container = document.getElementById('prob-matrix-container');
                    const resultadoBar = document.getElementById('prob-resultado-bar');
                    container.innerHTML = "<p>Calculando probabilidades...</p>";

                    try {
                        const res = await fetch(`/api/fantasy/partido-probabilidades/${partidoId}`);
                        const stats = await res.json();

                        const lambdaLocal = stats.poder_ataque_local * stats.poder_defensa_visitante * stats.avg_liga_casa;
                        const lambdaVisitante = stats.poder_ataque_visitante * stats.poder_defensa_local * stats.avg_liga_visita;
                        console.log(lambdaLocal, lambdaVisitante);

                        let probLocal = [];
                        let probVisitante = [];
                        for (let k = 0; k <= MAX_GOLES; k++) {
                            probLocal[k] = poisson(lambdaLocal, k);
                            probVisitante[k] = poisson(lambdaVisitante, k);
                        }

                        let htmlTabla = '<table>';
                        let probTotalLocal = 0;
                        let probTotalEmpate = 0;
                        let probTotalVisitante = 0;

                        htmlTabla += '<thead><tr><th class="header-local">Local / Visitante</th>';
                        for (let j = 0; j <= MAX_GOLES; j++) {
                            htmlTabla += `<th class="header-visitante">${j}</th>`;
                        }
                        htmlTabla += '</tr></thead><tbody>';

                        for (let i = 0; i <= MAX_GOLES; i++) { 
                            htmlTabla += `<tr><th class="header-local">${i}</th>`;
                            for (let j = 0; j <= MAX_GOLES; j++) { 
                                const probMarcador = probLocal[i] * probVisitante[j];
                                
                                if (i > j) probTotalLocal += probMarcador;
                                else if (i === j) probTotalEmpate += probMarcador;
                                else probTotalVisitante += probMarcador;
                                
                                let cellClass = '';
                                if (probMarcador > 0.08) cellClass = 'prob-high';
                                else if (probMarcador > 0.04) cellClass = 'prob-mid';

                                htmlTabla += `<td class="${cellClass}">${(probMarcador * 100).toFixed(1)}%</td>`;
                            }
                            htmlTabla += '</tr>';
                        }
                        htmlTabla += '</tbody></table>';
                        container.innerHTML = htmlTabla;

                        const sumaTotal = probTotalLocal + probTotalEmpate + probTotalVisitante;
                        

                        const pLocal = (probTotalLocal / sumaTotal) * 100;
                        const pEmpate = (probTotalEmpate / sumaTotal) * 100;
                        const pVisitante = (probTotalVisitante / sumaTotal) * 100;
                        console.log(pLocal, pEmpate, pVisitante);
                        resultadoBar.innerHTML = `
                            <div class="popular-local" style="width: ${pLocal}%" title="Victoria Local">${pLocal.toFixed(1)}%</div>
                            <div class="popular-empate" style="width: ${pEmpate}%" title="Empate">${pEmpate.toFixed(1)}%</div>
                            <div class="popular-visitante" style="width: ${pVisitante}%" title="Victoria Visitante">${pVisitante.toFixed(1)}%</div>
                        `;

                    } catch (error) {
                        console.error("Error al cargar probabilidades:", error);
                        container.innerHTML = "<p style='color: #dc2626;'>No se pudieron calcular las probabilidades.</p>";
                    }
                }

                cargarInfoPartido(partidoParam);
                cargarAlineacionLocal(partidoParam);
                cargarAlineacionVisitante(partidoParam);
                cargarUltimosEnfrentamientos(partidoParam);
                cargarProbabilidades(partidoParam);

                const canvasLocal = document.getElementById('campo-local');
                const canvasVisitante = document.getElementById('campo-visitante');

                function handleCanvasClick(event, clickablePlayers) {
                    const canvas = event.currentTarget;
                    const rect = canvas.getBoundingClientRect();
                    
                    
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    const mouseX = (event.clientX - rect.left) * scaleX;
                    const mouseY = (event.clientY - rect.top) * scaleY;

                    for (const player of clickablePlayers) {
                        const distanceSquared = Math.pow(mouseX - player.x, 2) + Math.pow(mouseY - player.y, 2);
                        
                        if (distanceSquared < Math.pow(player.radio, 2)) {
                            if (!player.id) {
                                console.warn("Este jugador no tiene ID:", player.nombre);
                                return;
                            }
                            
                            console.log(`Clic en jugador ID: ${player.id}`);
                            window.location.href = `jugador.html?id=${player.id}`;
                            return; 
                        }
                    }
                }

                // RQF7
                canvasLocal.addEventListener('click', (event) => {
                    handleCanvasClick(event, clickablePlayersLocal);
                });

                // RQF7
                canvasVisitante.addEventListener('click', (event) => {
                    handleCanvasClick(event, clickablePlayersVisitante);
                });

            });
            
            
        </script>
    </body>
</html>