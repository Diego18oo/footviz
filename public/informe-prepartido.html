<!DOCTYPE html>
<html>
    <head>
        <title>FootViz - PrePartido</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: 'Poppins', sans-serif;
                background-color: #1a1a2e;
                color: #e0e0e0;
                padding: 20px;
                transition: background-color 0.3s, color 0.3s;
            }
            /* --- Cabecera A√±adida --- */
            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                max-width: 1240px;
                margin: 0 auto 30px auto;
                padding-bottom: 20px;
                border-bottom: 1px solid #2a2a4a;
                transition: border-bottom-color 0.3s;
            }
            .header h1 { font-size: 2rem; color: #ffffff; font-weight: 700; }
            .theme-toggle-button {
                background: #2a2a4a; border: 1px solid #4a4a6a; color: #fff; width: 42px; height: 42px;
                padding: 10px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;
                display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;
            }
            .theme-toggle-button:hover { background: #3a3a5a; transform: scale(1.1); }
            h2 {
                font-size: 1.2rem; font-weight: 600; color: #ffffff; margin-bottom: 20px;
                padding-bottom: 10px; border-bottom: 1px solid #4a4a6a; text-align: center;
                transition: color 0.3s, border-bottom-color 0.3s;
            }
            .card {
                background-color: #1e1e3f; border-radius: 12px; padding: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); width: 100%; max-width: 1240px; margin: 20px auto;
                transition: background-color 0.3s, box-shadow 0.3s;
            }
            /* --- Info General del Partido --- */
            #info-general { display: flex; justify-content: space-between; align-items: center; }
            .info-partido { text-align: center; }
            .info-partido p { margin: 5px 0; font-size: 1.1em; color: #ffffff; font-weight: 600; }
            .info-partido p:first-child, .info-partido p:last-child { font-size: 0.9em; color: #a0a0c0; font-weight: 400; }
            .equipo img { width: 100px; height: auto; cursor: pointer;}
            /* --- Alineaciones --- */
            .alineaciones-wrapper { display: flex; justify-content: space-between; max-width: 1240px; margin: 20px auto; gap: 20px; flex-wrap: wrap; }
            .alineacion-container { flex: 1; min-width: 400px; text-align: center; }
            #formacion-local-titulo, #formacion-visitante-titulo { font-size: 1em; color: #a0a0c0; margin-top: 0; margin-bottom: 15px; font-weight: 400; }
            #campo-local, #campo-visitante { border-radius: 8px; max-width: 100%; height: auto; }
            /* --- Dashboard --- */
            .dashboard-wrapper { display: flex; align-items: flex-start; gap: 20px; max-width: 1240px; margin: 20px auto; }
            .dashboard-column-left, .dashboard-column-right { display: flex; flex-direction: column; gap: 20px; }
            .dashboard-column-left { flex: 2; }
            .dashboard-column-right { flex: 2; }
            /* --- √öltimos Enfrentamientos --- */
            #ultimos-enfrentamientos p { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #2a2a4a; font-size: 0.9rem; transition: border-bottom-color 0.3s; }
            #ultimos-enfrentamientos p:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
            #ultimos-enfrentamientos img { width: 30px; border-radius: 50%; }
            /* --- Comparaci√≥n de Estad√≠sticas --- */
            .stat-comparison { margin-bottom: 20px; }
            .stat-comparison:last-child { margin-bottom: 0; }
            .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 14px; }
            .stat-label { font-weight: bold; color: #e0e0e0; }
            .stat-value-local, .stat-value-visitor { padding: 4px 10px; border-radius: 12px; color: white; font-weight: bold; min-width: 40px; text-align: center; }
            .stat-value-local { background-color: #007bff; }
            .stat-value-visitor { background-color: #ff4d4d; }
            .stat-bar-container { width: 100%; height: 10px; background-color: #ff4d4d; border-radius: 5px; overflow: hidden; }
            .stat-bar-local { height: 100%; background-color: #007bff; border-radius: 5px; transition: width 0.5s ease-in-out; }

            /* ------------------------- */
            /* --- ESTILOS MODO LUZ --- */
            /* ------------------------- */
            body.light-mode { background-color: #f4f4f9; color: #333333; }
            body.light-mode .header { border-bottom-color: #e0e0e0; }
            body.light-mode .header h1, body.light-mode h2, body.light-mode .info-partido p { color: #1a1a2e; }
            body.light-mode .theme-toggle-button { background: #ffffff; border-color: #d1d1d1; color: #333; }
            body.light-mode .theme-toggle-button:hover { background: #f0f0f0; }
            body.light-mode .card { background-color: #ffffff; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
            body.light-mode h2 { border-bottom-color: #e0e0e0; }
            body.light-mode .info-partido p:first-child, body.light-mode .info-partido p:last-child, body.light-mode #formacion-local-titulo, body.light-mode #formacion-visitante-titulo { color: #666; }
            body.light-mode .stat-label { color: #333; }
            body.light-mode #ultimos-enfrentamientos p { border-bottom-color: #e0e0e0; }
        </style>
    </head>
    <body>
        <header class="header">
            <h1>Informe Pre-Partido</h1>
            <button id="theme-toggle" class="theme-toggle-button">‚òÄÔ∏è</button>
        </header>
        <div id="info-general" class="card">
            
        </div>

        <div class="alineaciones-wrapper">
            <div class="card alineacion-container" id="id-alineacion-local-container">
                <h2>Posible Alineaci√≥n Local</h2>
                <h3 id="formacion-local-titulo"></h3> 
                <canvas id="campo-local" width="500" height="700"></canvas>
            </div>

            <div class="card alineacion-container" id="id-alineacion-visitante-container">
                <h2>Posible Alineaci√≥n Visitante</h2>
                <h3 id="formacion-visitante-titulo"></h3> 
                <canvas id="campo-visitante" width="500" height="700"></canvas>
            </div>
        </div>

        

        <div class="dashboard-wrapper">

            <!-- Columna Izquierda (m√°s ancha) -->
            <div class="dashboard-column-left">
                <div class="card" id="stats-comparison-container">
                    <!-- El contenido de la Comparativa de Estad√≠sticas se carga aqu√≠ -->
                </div>
            </div>

            <!-- Columna Derecha (contiene los otros dos elementos) -->
            <div class="dashboard-column-right">
                <div class="card">
                    <h2>Ultimos Enfrentamientos</h2>
                    <div id="ultimos-enfrentamientos">
                        <!-- El contenido se carga aqu√≠ -->
                    </div>
                </div>

                <div class="card">
                    <h2>Evoluci√≥n en la Temporada</h2>
                    <canvas id="evolucionChart"></canvas>
                </div>
            </div>

        </div>

 
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // --- DECLARACI√ìN DE VARIABLES ---
                const params = new URLSearchParams(window.location.search);
                const partidoParam = params.get("partido");
                let evolucionChartInstance = null;
                let equiposEvolucion = {}; // Para guardar IDs y redibujar
                
                // --- L√ìGICA DE TEMA ---
                const themeToggleButton = document.getElementById('theme-toggle');
                const body = document.body;

                const darkLineOptions = { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#e0e0e0' } }, title: { display: false } }, scales: { y: { reverse: true, min: 1, title: { display: true, text: 'Posici√≥n', color: '#e0e0e0' }, ticks: { color: '#a0a0c0', stepSize: 2 } }, x: { ticks: { color: '#a0a0c0' }, title: { display: true, text: 'Jornada', color: '#e0e0e0' } } } };
                const lightLineOptions = { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#333' } }, title: { display: false } }, scales: { y: { reverse: true, min: 1, title: { display: true, text: 'Posici√≥n', color: '#333' }, ticks: { color: '#666', stepSize: 2 } }, x: { ticks: { color: '#666' }, title: { display: true, text: 'Jornada', color: '#333' } } } };

                const applyTheme = (theme) => {
                    if (theme === 'light') {
                        body.classList.add('light-mode');
                        themeToggleButton.textContent = 'üåô';
                    } else {
                        body.classList.remove('light-mode');
                        themeToggleButton.textContent = '‚òÄÔ∏è';
                    }
                    // Volver a cargar/dibujar los elementos din√°micos
                    if (partidoParam) {
                        cargarAlineacionLocal(partidoParam);
                        cargarAlineacionVisitante(partidoParam);
                        if(equiposEvolucion.local && equiposEvolucion.visitante){
                           cargarEvolucionEquipos(equiposEvolucion.local, equiposEvolucion.visitante, equiposEvolucion.total);
                        }
                    }
                };

                const savedTheme = localStorage.getItem('theme') || 'dark';
                if (savedTheme === 'light') { body.classList.add('light-mode'); themeToggleButton.textContent = 'üåô'; } 
                else { body.classList.remove('light-mode'); themeToggleButton.textContent = '‚òÄÔ∏è'; }

                themeToggleButton.addEventListener('click', () => {
                    const newTheme = body.classList.contains('light-mode') ? 'dark' : 'light';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                });
                
                const FORMACIONES = {
                    "4-4-2": [
                        [0.5, 0.9],   // Portero
                        // Defensas: LD, DFC, DFC, LI
                        [0.9, 0.7], [0.63, 0.7], [0.37, 0.7], [0.1, 0.7], 
                        // Medios: MD, MC, MC, MI
                        [0.9, 0.45], [0.63, 0.45], [0.37, 0.45], [0.1, 0.45], 
                        // Delanteros
                        [0.63, 0.2], [0.37, 0.2]  
                    ],
                    "4-2-3-1": [
                        [0.5, 0.9],   // Portero
                        // Defensas: LD, DFC, DFC, LI
                        [0.9, 0.7], [0.63, 0.7], [0.37, 0.7], [0.1, 0.7],
                        // Medios defensivos (2)
                        [0.63, 0.55], [0.37, 0.55], 
                        // Medios ofensivos: MD, MCO, MI
                        [0.85, 0.35], [0.5, 0.35], [0.15, 0.35], 
                        // Delantero
                        [0.5, 0.15]   
                    ],
                    "4-3-3": [
                        [0.5, 0.9],   // Portero
                        // Defensas: LD, DFC, DFC, LI
                        [0.9, 0.7], [0.63, 0.7], [0.37, 0.7], [0.1, 0.7], 
                        // Medios: Interior Derecho, Pivote, Interior Izquierdo
                        [0.75, 0.5], [0.5, 0.45], [0.25, 0.5], 
                        // Delanteros: Extremo Derecho, DC, Extremo Izquierdo
                        [0.8, 0.2], [0.5, 0.15], [0.2, 0.2]  
                    ],
                    "3-5-2": [
                        [0.5, 0.9], // Portero
                        // Defensas (3): Central Derecho, L√≠bero, Central Izquierdo
                        [0.75, 0.7], [0.5, 0.7], [0.25, 0.7], 
                        // Medios (5): Carrilero Derecho, Interior, Pivote, Interior, Carrilero Izquierdo
                        [0.9, 0.45], [0.7, 0.5], [0.5, 0.4], [0.3, 0.5], [0.1, 0.45], 
                        // Delanteros (2)
                        [0.63, 0.2], [0.37, 0.2] 
                    ],
                    "3-4-2-1": [
                        [0.5, 0.9], // Portero
                        // Defensas (3): Central Derecho, L√≠bero, Central Izquierdo
                        [0.75, 0.7], [0.5, 0.7], [0.25, 0.7], 
                        // Medios (4): Carrilero Derecho, Pivote Derecho, Pivote Izquierdo,  Carrilero Izquierdo
                        [0.9, 0.45], [0.63, 0.50], [0.37, 0.50], [0.1, 0.45],  
                        //Medios Ofensivos(2)
                        [0.63, 0.3], [0.37, 0.3],
                        // Delanteros (1)
                        [0.50, 0.2] 
                    ]

                };
                
                let nombreLocal = 'Equipo Local';
                let nombreVisitante = 'Equipo Visitante';
                function cargarInfoPartido(partido){
                    fetch(`/info-prepartido/${partido}`).then(r => r.json()).then(data => {
                        if (!data) return;
                        // Guardamos los IDs para poder redibujar el gr√°fico de evoluci√≥n al cambiar de tema
                        equiposEvolucion = { local: data.id_local, visitante: data.id_visitante, total: data.total_equipos_liga };
                        // El resto de la funci√≥n...
                        let infoPrincipal = document.getElementById("info-general");
                        const fechaParaMostrar = new Date(data.fecha).toISOString().split('T')[0];
                        const arbitro = data.arbitro_nombre || 'No asignado';
                        let momiosHTML = data.momio_local ? `${data.momio_local} | ${data.momio_empate} | ${data.momio_visitante}`: 'No disponibles';
                        
                        infoPrincipal.innerHTML = `
                            <div class="equipo"><img src="${data.escudo_local}" id="clubImgLocal"></div>
                            <div class="info-partido">
                                <p>${fechaParaMostrar}</p>
                                <p>${data.estadio_nombre}</p> 
                                <p>${arbitro}</p>
                                <p>${momiosHTML}</p> 
                            </div> 
                            <div class="equipo"><img src="${data.escudo_visitante}" id="clubImgVisitante"></div>`;
                        
                        document.getElementById("clubImgLocal").addEventListener("click", () => window.location.href = `club.html?id=${data.id_local}`);
                        document.getElementById("clubImgVisitante").addEventListener("click", () => window.location.href = `club.html?id=${data.id_visitante}`);

                        cargarEvolucionEquipos(data.id_local, data.id_visitante, data.total_equipos_liga);
                        cargarComparacionStats(data.id_local, data.id_visitante);
                    });  

                    
                }

                function cargarAlineacionLocal(partido){
                    fetch(`/alineaciones/${partido}`)
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('id-alineacion-local-container');
                        if (!data || !data.nombre1) {
                            console.warn("Los datos de la alineaci√≥n no est√°n disponibles.");
                            // Reemplazamos el contenido del div con un mensaje
                            container.innerHTML = `
                                <h2>Posible Alineaci√≥n Local</h2>
                                <p style="padding: 40px 0; color: #a0a0c0;">
                                    Las alineaciones a√∫n no est√°n disponibles.
                                </p>
                            `;
                            return; // Detenemos la ejecuci√≥n aqu√≠
                        }
                        const canvas = document.getElementById('campo-local');
                        if (!canvas.getContext) return;
                        const ctx = canvas.getContext('2d');

                        const jugadores = [];
                        for (let i = 1; i <= 11; i++) {
                            const dorsal = data[`dorsal${i}`] || data[`drosal${i}`];
                            jugadores.push({
                                nombre: data[`nombre${i}`],
                                imgUrl: data[`img${i}`]
                            });
                        }

                        // --- L√ìGICA DIN√ÅMICA DE FORMACI√ìN ---
                        // 1. Obtener la formaci√≥n del JSON. Usar "4-4-2" como fallback.
                        const formacionKey = data.formacion_local || "4-4-2";

                        // 2. Actualizar el t√≠tulo en la p√°gina
                        document.getElementById('formacion-local-titulo').innerText = `Formaci√≥n: ${formacionKey}`;

                        // 3. Seleccionar las coordenadas del diccionario. Si no existe, usar "4-4-2".
                        const formacionCoordenadas = FORMACIONES[formacionKey] || FORMACIONES["4-4-2"];

                        precargarImagenesYDibujar(ctx, jugadores, formacionCoordenadas);
                    })
                    .catch(error => console.error('Error al cargar las alineaciones:', error));
                }


                function precargarImagenesYDibujar(ctx, jugadores, formacion) {
                    // Creamos un array de promesas, una para cada imagen
                    const promesasDeImagenes = jugadores.map(jugador => {
                        return new Promise((resolve, reject) => {
                            const img = new Image();
                            img.crossOrigin = "Anonymous"; // Necesario para cargar im√°genes de otros dominios
                            img.onload = () => resolve(img);
                            img.onerror = () => reject(new Error(`No se pudo cargar: ${jugador.imgUrl}`));
                            img.src = jugador.imgUrl;
                        });
                    });

                    // Promise.all espera a que todas las promesas se resuelvan
                    Promise.all(promesasDeImagenes)
                        .then(imagenesCargadas => {
                            // Una vez cargadas, a√±adimos el objeto de imagen a cada jugador
                            jugadores.forEach((jugador, index) => {
                                jugador.imagenCargada = imagenesCargadas[index];
                            });
                            
                            // ¬°Ahora s√≠! Dibujamos todo en el canvas
                            dibujarAlineacion(ctx, jugadores, formacion);
                        })
                        .catch(error => {
                            console.error("Error al cargar las im√°genes de los jugadores:", error);
                            // Opcional: Aqu√≠ podr√≠as dibujar los c√≠rculos azules como fallback
                        });
                }
                
                

                function cargarAlineacionVisitante(partido){
                    fetch(`/alineaciones/${partido}`)
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('id-alineacion-visitante-container');
                        if (!data || !data.nombre1) {
                            console.warn("Los datos de la alineaci√≥n no est√°n disponibles.");
                            // Reemplazamos el contenido del div con un mensaje
                            container.innerHTML = `
                                <h2>Posible Alineaci√≥n Local</h2>
                                <p style="padding: 40px 0; color: #a0a0c0;">
                                    Las alineaciones a√∫n no est√°n disponibles.
                                </p>
                            `;
                            return; // Detenemos la ejecuci√≥n aqu√≠
                        }
                        const canvas = document.getElementById('campo-visitante');
                        if (!canvas.getContext) return;
                        const ctx = canvas.getContext('2d');

                        const jugadores = [];
                        for (let i = 12; i <= 22; i++) {
                            const dorsal = data[`dorsal${i}`] || data[`drosal${i}`];
                            jugadores.push({
                                nombre: data[`nombre${i}`],
                                imgUrl: data[`img${i}`]
                            });
                        }

                        // --- L√ìGICA DIN√ÅMICA DE FORMACI√ìN ---
                        // 1. Obtener la formaci√≥n del JSON. Usar "4-4-2" como fallback.
                        const formacionKey = data.formacion_visitante || "4-4-2";

                        // 2. Actualizar el t√≠tulo en la p√°gina
                        document.getElementById('formacion-visitante-titulo').innerText = `Formaci√≥n: ${formacionKey}`;

                        // 3. Seleccionar las coordenadas del diccionario. Si no existe, usar "4-4-2".
                        const formacionCoordenadas = FORMACIONES[formacionKey] || FORMACIONES["4-4-2"];
                        precargarImagenesYDibujar(ctx, jugadores, formacionCoordenadas);
                    })
                    .catch(error => console.error('Error al cargar las alineaciones:', error));
                }
                

                function dibujarAlineacion(ctx, jugadores, formacion) {
                    const canvas = ctx.canvas;
                    const width = canvas.width, height = canvas.height;
                    const isLight = body.classList.contains('light-mode');
                    ctx.fillStyle = isLight ? '#d4e9d4' : '#2a5f2a';
                    ctx.fillRect(0, 0, width, height);
                    ctx.strokeStyle = isLight ? 'rgba(0, 0, 0, 0.3)' : 'rgba(255, 255, 255, 0.3)';
                    // ... el resto de tu c√≥digo de dibujo de campo ...
                    jugadores.forEach((jugador, index) => {
                        if (formacion[index]) {
                            const x = formacion[index][0] * width;
                            const y = formacion[index][1] * height;
                            dibujarJugador(ctx, x, y, jugador);
                        }
                    });
                }

                function dibujarJugador(ctx, x, y, jugador) {
                    const radio = 22;
                    const isLight = body.classList.contains('light-mode');
                    ctx.save();
                    ctx.beginPath(); ctx.arc(x, y, radio, 0, 2 * Math.PI); ctx.clip();
                    if (jugador.imagenCargada) {
                        ctx.drawImage(jugador.imagenCargada, x - radio, y - radio, radio * 2, radio * 2);
                    }
                    ctx.restore();
                    ctx.beginPath(); ctx.arc(x, y, radio, 0, 2 * Math.PI);
                    ctx.strokeStyle = isLight ? '#333' : '#FFFFFF';
                    ctx.lineWidth = 2; ctx.stroke();
                    ctx.fillStyle = isLight ? '#333' : '#FFFFFF';
                    ctx.font = 'bold 14px Poppins';
                    ctx.textAlign = 'center';
                    ctx.shadowColor = isLight ? 'rgba(255,255,255,0.5)' : 'black';
                    ctx.shadowBlur = 4;
                    ctx.fillText(jugador.nombre, x, y + radio + 14);
                    ctx.shadowBlur = 0;
                }

                function cargarUltimosEnfrentamientos(partido){
                    const ultimosEnfrentamientos = document.getElementById('ultimos-enfrentamientos');
                    ultimosEnfrentamientos.innerHTML="";
                    fetch(`/ultimos-enfrentamientos/${partido}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach((partido) => {
                            const fechaPartidoNormalizada = new Date(partido.fecha);
                            fechaPartidoNormalizada.setHours(0, 0, 0, 0);
                            const anio = fechaPartidoNormalizada.getFullYear();
                            const mesFormateado = String(fechaPartidoNormalizada.getMonth() + 1).padStart(2, '0');
                            const diaFormateado = String(fechaPartidoNormalizada.getDate()).padStart(2, '0');
                            const fechaParaMostrar = `${anio}-${mesFormateado}-${diaFormateado}`;
                            const match = document.createElement("div");
                            match.innerHTML=`
                                <p>
                                    <img src="${partido.escudo_local}" alt="Escudo">
                                    ${partido.goles_local} - ${partido.goles_visitante}  
                                    <img src="${partido.escudo_visitante}" alt="Escudo">
                                    ${fechaParaMostrar}
                                </p>    
                            `;
                            ultimosEnfrentamientos.appendChild(match);
                        })
                    })
                }

                function cargarComparacionStats(equipoLocal, equipoVisitante){
                    fetch(`/comparacion-estadisticas-equipos/${equipoLocal}/${equipoVisitante}`)
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('stats-comparison-container');
                        if (!data || data.length < 2) {
                            container.innerHTML = "<h2>Comparativa de Estad√≠sticas</h2><p>Estad√≠sticas no disponibles.</p>";
                            return;
                        }

                        const localStats = data[0];
                        const visitorStats = data[1];

                        const statsToShow = [
                            { key: 'goles_anotados', label: 'Goles Anotados' },
                            { key: 'disparos', label: 'Disparos' },
                            { key: 'disparos_a_puerta', label: 'Disparos a Puerta' },
                            { key: 'pases_completados', label: 'Pases Completados' },
                            { key: 'tiros_de_esquina', label: 'Tiros de Esquina' },
                            { key: 'faltas', label: 'Faltas' },
                            { key: 'tarjetas_amarillas', label: 'Tarjetas Amarillas' },
                            { key: 'tarjetas_rojas', label: 'Tarjetas Rojas' }
                        ];

                        let finalHTML = '<h2>Comparativa de Estad√≠sticas</h2>';
                        statsToShow.forEach(stat => {
                            const localValue = parseFloat(localStats[stat.key]) || 0;
                            const visitorValue = parseFloat(visitorStats[stat.key]) || 0;
                            const total = localValue + visitorValue;

                            // Calculamos el porcentaje para la barra (con fallback para evitar divisi√≥n por cero)
                            let localPercentage = 50;
                            if (total > 0) {
                                localPercentage = (localValue / total) * 100;
                            }
                            
                            // Creamos el bloque HTML para esta estad√≠stica
                            finalHTML += `
                                <div class="stat-comparison">
                                    <div class="stat-header">
                                        <span class="stat-value-local">${localValue}</span>
                                        <span class="stat-label">${stat.label}</span>
                                        <span class="stat-value-visitor">${visitorValue}</span>
                                    </div>
                                    <div class="stat-bar-container">
                                        <div class="stat-bar-local" style="width: ${localPercentage}%;"></div>
                                    </div>
                                </div>
                            `;
                        });
                        container.innerHTML = finalHTML;


                    })
                    .catch(error => {
                        console.error("Error al cargar las estad√≠sticas comparativas:", error);
                        document.getElementById('stats-comparison-container').innerHTML = "<h2>Comparativa de Estad√≠sticas</h2><p>No se pudieron cargar las estad√≠sticas.</p>";
                    });
                }
                
                function cargarEvolucionEquipos(equipoLocal, equipoVisitante, totalEquiposLiga){
                    fetch(`/comparacion-evoluciones/${equipoLocal}/${equipoVisitante}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data || data.length < 2) {
                            console.warn("Datos de evoluci√≥n insuficientes.");
                            return;
                        }
                        const evolucionLocal = data.find(e => e.equipo === equipoLocal);
                        const evolucionVisitante = data.find(e => e.equipo === equipoVisitante);

                        if (!evolucionLocal || !evolucionVisitante) {
                            console.warn("No se encontraron los datos de evoluci√≥n para ambos equipos.");
                            return;
                        }
                        const datosLocal = [];
                        const datosVisitante = [];
                        let ultimaJornadaValida = 0;

                        
                        for (let i = 1; i <= 38; i++) {
                            const posLocal = evolucionLocal[`jornada${i}`];
                            const posVisitante = evolucionVisitante[`jornada${i}`];

                            // Si al menos uno de los equipos tiene una posici√≥n v√°lida (no es 0), la contamos.
                            if (posLocal > 0 || posVisitante > 0) {
                                ultimaJornadaValida = i;
                            }
                            datosLocal.push(posLocal > 0 ? posLocal : null); // null crea un corte en la gr√°fica
                            datosVisitante.push(posVisitante > 0 ? posVisitante : null);
                        }
                        const labels = [];
                        for (let i = 1; i <= ultimaJornadaValida; i++) {
                            labels.push(`J${i}`);
                        }
                        const datosLocalRecortados = datosLocal.slice(0, ultimaJornadaValida);
                        const datosVisitanteRecortados = datosVisitante.slice(0, ultimaJornadaValida);

                        const ctx = document.getElementById('evolucionChart').getContext('2d');
                        const currentOptions = body.classList.contains('light-mode') ? lightLineOptions : darkLineOptions;
                        currentOptions.scales.y.max = totalEquiposLiga;
                        if (evolucionChartInstance) evolucionChartInstance.destroy();
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: nombreLocal, // Usamos el nombre que guardamos antes
                                    data: datosLocalRecortados,
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    tension: 0.3,
                                    fill: false
                                }, {
                                    label: nombreVisitante, // Usamos el nombre que guardamos antes
                                    data: datosVisitanteRecortados,
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    tension: 0.3,
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true, 
                                plugins: {
                                    legend: { position: 'top', labels: { color: '#e0e0e0' } },
                                    title: { display: false } // Ya tenemos un H2, no necesitamos otro t√≠tulo
                                },
                                scales: {
                                    y: {
                                        reverse: true, // ¬°Importante! La posici√≥n 1 debe estar arriba
                                        min: 1,
                                        max: totalEquiposLiga,
                                        title: {
                                            display: true,
                                            text: 'Posici√≥n',
                                            color: '#e0e0e0'
                                        },
                                        ticks: { color: '#a0a0c0', stepSize: 2 },
                                    },
                                    x: {
                                        ticks: { color: '#a0a0c0' },
                                        title: {
                                            display: true,
                                            text: 'Jornada',
                                            color: '#e0e0e0'
                                        }
                                    }
                                }
                            }
                        });
                    })
                }
                cargarInfoPartido(partidoParam);
                cargarAlineacionLocal(partidoParam);
                cargarAlineacionVisitante(partidoParam);
                cargarUltimosEnfrentamientos(partidoParam);


            });
            
            
        </script>
    </body>
</html>