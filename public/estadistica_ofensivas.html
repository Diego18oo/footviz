<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estadisticas Ofensivas</title>
    <style>
        table {
            width: 80%;
            margin: 0 auto;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            border: 1px solid #aaa;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        img {
            width: 32px;
            height: auto;
            vertical-align: middle;
            margin-right: 10px;
        }
    </style>
    <body>
        <h1>Estadisticas Ofensivas Inidividuales</h1>
        <form action="#">
            <label for="liga">Selecciona una Liga</label>
            <select id="liga">
                <option value="premierleague" selected>Premier League</option>
                <option value="laliga">La Liga</option>
                <option value="seriea">Serie A</option>
                <option value="bundesliga">Bundesliga</option>
                <option value="ligueone">Ligue 1</option>
            </select>
        </form> 
        <div>
            <button id="prev">Anterior</button>
            <span id="page-info"></span>
            <button id="next">Siguiente</button>
        </div>
        <table id="estadisticas-ofensivas">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Jugador</th>
                    <th>Minutos</th>
                    <th>Goles</th>
                    <th>Disparos</th>
                    <th>Disparos a puerta</th>
                    <th>Porcentaje disparos a puerta</th>
                    <th>Disparos por 90</th>
                    <th>Goles por disparo</th>
                    <th>Distancia promedio de disparos</th>
                    <th>Tiros Libres</th>
                    <th>Penales</th>
                    <th>xG</th>
                    

                </tr>
            </thead>
            <tbody>
                
            </tbody>
        </table>
        <h3>Comparacion Jugadores</h3>
        

        
        <input type="text" id="searchInput1" placeholder="Buscar jugador 1..." />
        <div id="searchResults1"></div>
        <input type="text" id="searchInput2" placeholder="Buscar jugador 2..." />
        <div id="searchResults2"></div>     
        <div id="searchResults"></div>
        <div id="detalleJugador"></div>
        <div style="width: 800px; height: 800px;">
            <canvas id="radarChart"></canvas>
        </div>
        <div style="width: 800px; height: 800px;">
            <table id="mejores-goles">
                <thead>
                    <tr>
                        <th colspan="4">Mejores Goles</th>
                    </tr>
                    <tr>
                        <th>Jugador</th>
                        <th>xG</th>
                        <th>Partido</th>                        
                    </tr>
                </thead>
                <tbody>
                    
                </tbody>

            </table>
        </div>

        


        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script>
            function cargarMejoresGoles (ligaSeleccionada){  
                let endpoints = {
                    "premierleague": "1",
                    "laliga": "2",
                    "seriea": "3", 
                    "bundesliga": "4",
                    "ligueone": "5"

                }                  
                fetch(`/mejores-goles/${endpoints[ligaSeleccionada]}`)
                .then(response => response.json())
                .then(data => {
                    const tbodyMejoresGoles = document.querySelector("#mejores-goles tbody");
                    tbodyMejoresGoles.innerHTML="";
                    const goles = data;
                    goles.forEach(gol => {
                        const fila = document.createElement("tr");
                        fila.innerHTML = `
                            <td><img src="${gol.url_imagen}">${gol.nombre_jugador}</td>
                            <td>${gol.xg}</td>
                            <td>
                                <img src="${gol.escudo_local}" alt="Local">${gol.equipo_local || ""}
                                ${gol.goles_local} - ${gol.goles_visitante}
                                <img src="${gol.escudo_visitante}" alt="Visitante">${gol.equipo_visitante || ""}
                            </td>
                        `;
                        tbodyMejoresGoles.appendChild(fila);
                    });

                })
                

            }
            
            function setupSearch(inputID, jugadorNum){
                const input = document.getElementById(inputID);
                input.addEventListener("input", async (e) => {
                    const query = e.target.value;
                    const resultsDiv = document.getElementById(`searchResults${jugadorNum}`);
                    resultsDiv.innerHTML ="";
                    if (query.length < 2) return;
                    const res = await fetch(`/buscar-jugadores?nombre=${query}`);
                    const jugador = await res.json();
                    jugador.forEach(jugador => {
                        const div = document.createElement("div");
                        div.innerHTML = `
                            <img src="${jugador.imagen_equipo}" width="30" />
                            <img src="${jugador.imagen_jugador}" width="30" />
                            ${jugador.nombre_jugador}
                        `;

                        div.style.cursor = "pointer";
                        div.addEventListener("click", async () => {
                            resultsDiv.innerHTML="";
                            const res = await fetch(`/estadisticas-jugador/${jugador.id_jugador}`);
                            const data = await res.json();
                            const maximos = await getMaxStats();

                            function normalizar(valor, maximo) {
                                return maximo > 0 ? (valor/maximo) * 100 : 0;
                            }
                            const normalizados = {
                                nombre_jugador: data.nombre_jugador,
                                goles: normalizar(data.total_goles, maximos.max_goles),
                                disparos: normalizar(data.disparos, maximos.max_disparos),
                                asistencias: normalizar(data.asistencias, maximos.max_asistencias),
                                acciones_creadas: normalizar(data.acciones_creadas, maximos.max_acciones_creadas),
                                pases: normalizar(data.pases, maximos.max_pases),
                                porcentaje_de_efectividad_de_pases: normalizar(data.porcentaje_de_efectividad_de_pases, maximos.max_porcentaje_de_efectividad_de_pases),
                                pases_progresivos: normalizar(data.pases_progresivos, maximos.max_pases_progresivos),
                                acarreos_progresivos: normalizar(data.acarreos_progresivos, maximos.max_acarreos_progresivos),
                                regates_efectivos: normalizar(data.regates_efectivos, maximos.max_regates_efectivos),
                                toques_de_balon: normalizar(data.toques_de_balon, maximos.max_toques_de_balon),
                                entradas: normalizar(data.entradas, maximos.max_entradas),
                                intercepciones: normalizar(data.intercepciones, maximos.max_intercepciones),
                                bloqueos: normalizar(data.bloqueos, maximos.max_bloqueos),
                                despejes: normalizar(data.despejes, maximos.max_despejes),
                                duelos_aereos_ganados: normalizar(data.duelos_aereos_ganados, maximos.max_duelos_aereos_ganados)
                            };

                            

                            renderRadarChart(normalizados, data, jugadorNum);
                        });
                        resultsDiv.appendChild(div);

                    });
                })
            }
            
            

            var liga = document.getElementById('liga');
            var tbody = document.querySelector("#estadisticas-ofensivas tbody");
            var endpoints = {
                "premierleague": "/estadisticas-ofensivas-premier-league",
                "laliga": "/estadisticas-ofensivas-la-liga",
                "seriea": "/estadisticas-ofensivas-serie-a", 
                "bundesliga": "/estadisticas-ofensivas-bundesliga",
                "ligueone": "/estadisticas-ofensivas-ligue-one"
            };
            let allData = [];
            let currentPage = 1;
            const pageSize = 10;
            function renderPage() {
                tbody.innerHTML = "";
                const start = (currentPage - 1) * pageSize;
                const end = start + pageSize;
                const pageData = allData.slice(start, end);

                pageData.forEach((estadistica_ofensiva, index) => {
                    const fila = document.createElement("tr");
                    fila.innerHTML = `
                        <td>${start + index + 1}</td>
                        <td><img src="${estadistica_ofensiva.imagen_jugador}" width="30"> ${estadistica_ofensiva.nombre_jugador} <img src="${estadistica_ofensiva.imagen_equipo}" width="30"></td>
                        <td>${estadistica_ofensiva.minutos}</td>
                        <td>${estadistica_ofensiva.total_goles}</td>
                        <td>${estadistica_ofensiva.disparos}</td>
                        <td>${estadistica_ofensiva.disparos_a_puerta}</td>
                        <td>${estadistica_ofensiva.porcentaje_disparos_a_puerta}</td>
                        <td>${estadistica_ofensiva.disparos_por_90}</td>
                        <td>${estadistica_ofensiva.goles_por_disparo}</td>
                        <td>${estadistica_ofensiva.distancia_promedio_de_disparos}</td>
                        <td>${estadistica_ofensiva.tiros_libres}</td>
                        <td>${estadistica_ofensiva.penales}</td>
                        <td>${estadistica_ofensiva["SUM(ejp.goles_esperados)"]}</td>

                    `;
                    tbody.appendChild(fila);
                });

                // Actualizar info de página
                document.getElementById("page-info").textContent = 
                    `Página ${currentPage} de ${Math.ceil(allData.length / pageSize)}`;
            }

            function cargarTabla(ligaSeleccionada){
                
                if (endpoints[ligaSeleccionada]){
                    var url = endpoints[ligaSeleccionada];
                    fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        allData = data;
                        currentPage = 1;
                        renderPage();
                    })
                    .catch(error => {
                        console.error("Error al cargar la pagina: ", error);
                    });
                }
            }

            document.getElementById("prev").addEventListener("click", () => {
                if(currentPage > 1) {
                    currentPage --;
                    renderPage();
                }
            })

            document.getElementById("next").addEventListener("click", () => {
                if(currentPage < Math.ceil(allData.length / pageSize)) {
                    currentPage++;
                    renderPage();
                }
            })
            
            cargarTabla(liga.value);
            cargarMejoresGoles(liga.value);
            liga.addEventListener("change", function(){
                cargarTabla(this.value);
                cargarMejoresGoles(this.value)
            });
            
            const params = new URLSearchParams(window.location.search);
            const ligaParam = params.get("liga");

            if (ligaParam) {
                liga.value = ligaParam;
                cargarTabla(ligaParam);
                cargarMejoresGoles(ligaParam);
            } else {
                cargarTabla(liga.value);
                cargarMejoresGoles(liga.value);
            }
            

            function renderRadarChart(stats, rawStats, jugadorNum) {
                if (!window.radarChartInstance) {
                    const ctx = document.getElementById('radarChart').getContext('2d');
                    window.radarChartInstance = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: ["goles", "disparos", "asistencias", 
                            "acciones_creadas", "pases", "porcentaje_de_efectividad_de_pases",
                            "pases_progresivos", "acarreos_progresivos", "regates_efectivos", 
                            "toques_de_balon", "entradas", "intercepciones",
                            "bloqueos", "despejes", "duelos_aereos_ganados"],
                            datasets: []
                        },
                        options: {
                            responsive: true,
                            scales: {
                                r: {
                                    min: 0,
                                    max: 100
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const dataset = context.dataset;
                                            const statName = context.chart.data.labels[context.dataIndex];
                                            const realValue = dataset.customStats[statName];
                                            return `${dataset.label} - ${statName}: ${realValue}`; 
                                        }
                                    }
                                }
                            }
                            
                        }
                    });
                }

                const colores = [
                    { bg: "rgba(0,123,255,0.2)", border: "rgba(0,123,255,1)" },
                    { bg: "rgba(255,99,132,0.2)", border: "rgba(255,99,132,1)" }
                ];

                window.radarChartInstance.data.datasets[jugadorNum - 1] = {
                    label: stats.nombre_jugador,
                    data: [
                        stats.goles,   
                        stats.disparos,   
                        stats.asistencias,   
                        stats.acciones_creadas,   
                        stats.pases,
                        stats.porcentaje_de_efectividad_de_pases,
                        stats.pases_progresivos,
                        stats.acarreos_progresivos,
                        stats.regates_efectivos,
                        stats.toques_de_balon,
                        stats.entradas,
                        stats.intercepciones,
                        stats.bloqueos,
                        stats.despejes,
                        stats.duelos_aereos_ganados    
                    ],
                    customStats: {
                        goles: rawStats.total_goles,
                        disparos: rawStats.disparos,
                        asistencias: rawStats.asistencias,
                        acciones_creadas: rawStats.acciones_creadas,
                        pases: rawStats.pases,
                        porcentaje_de_efectividad_de_pases: rawStats.porcentaje_de_efectividad_de_pases,
                        pases_progresivos: rawStats.pases_progresivos,
                        acarreos_progresivos: rawStats.acarreos_progresivos,
                        regates_efectivos: rawStats.regates_efectivos,
                        toques_de_balon: rawStats.toques_de_balon,
                        entradas: rawStats.entradas,
                        intercepciones: rawStats.intercepciones,
                        bloqueos: rawStats.bloqueos,
                        despejes: rawStats.despejes,
                        duelos_aereos_ganados: rawStats.duelos_aereos_ganados
                    },
                    fill: true,
                    backgroundColor: colores[jugadorNum - 1].bg,
                    borderColor: colores[jugadorNum - 1].border,
                    pointBackgroundColor: colores[jugadorNum - 1].border
                };
                window.radarChartInstance.update();               
            }
            async function getMaxStats() {
                const res = await fetch("/max-stats");
                return await res.json();
            }
            setupSearch("searchInput1", 1);
            setupSearch("searchInput2", 2);
            

        </script>
    </body>
</head> 