<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Estadisticas Ofensivas</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Poppins', sans-serif;
                background-color: #1a1a2e; /* Fondo oscuro principal */
                color: #e0e0e0; /* Texto claro */
                padding: 20px;
            }
            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                max-width: 1400px;
                margin: 0 auto 30px auto;
                padding-bottom: 20px;
                border-bottom: 1px solid #2a2a4a;
            }

            .header h1 {
                font-size: 2rem;
                color: #ffffff;
                font-weight: 700;
            }

            .header .controls-container {
                display: flex;
                align-items: center;
                gap: 20px;
            }

            .header select, .header button {
                background-color: #2a2a4a;
                color: #e0e0e0;
                border: 1px solid #4a4a6a;
                border-radius: 8px;
                padding: 10px 15px;
                font-family: 'Poppins', sans-serif;
                font-size: 0.9rem;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            
            .header select:hover, .header button:hover {
                background-color: #3a3a5a;
            }

            .dashboard-wrapper {
                display: flex;
                gap: 30px;
                max-width: 1400px;
                margin: 0 auto;
                align-items: flex-start;
            }

            .dashboard-column-left {
                flex: 3;
            }

            .dashboard-column-right {
                flex: 2;
                display: flex;
                flex-direction: column;
                gap: 30px;
            }
            
            /* --- Estilo de Tarjeta para cada Contenedor --- */
            .card {
                background-color: #1e1e3f;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                width: 100%;
            }
            
            .card-title {
                font-size: 1.2rem;
                font-weight: 600;
                color: #ffffff;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 1px solid #4a4a6a;
            }

            /* --- Estilos de Tablas --- */
            table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed; /* Ayuda a controlar el ancho de las columnas */
            }

            th, td {
                padding: 10px;
                text-align: center;
                white-space: nowrap; /* Evita que el texto se rompa en varias líneas */
                overflow: hidden;
                text-overflow: ellipsis; /* Añade '...' si el texto no cabe */
            }
            
            #estadisticas-ofensivas th:nth-child(2),
            #estadisticas-ofensivas td:nth-child(2) {
                text-align: left; /* Alinear el nombre del jugador a la izquierda */
                width: 200px; /* Ancho fijo para la columna del jugador */
            }

            thead tr {
                border-bottom: 2px solid #4a4a6a;
            }

            th {
                font-weight: 600;
                color: #ffffff;
                font-size: 0.75rem;
                text-transform: uppercase;
            }

            tbody tr {
                border-bottom: 1px solid #2a2a4a;
            }
            
            tbody tr:last-child { border-bottom: none; }

            img {
                width: 28px;
                height: 28px;
                vertical-align: middle;
                margin: 0 8px;
                border-radius: 50%;
            }
            
            .table-container {
                overflow-x: auto; /* Permite scroll horizontal si la tabla es muy ancha */
            }

            /* --- Controles de Paginación --- */
            .pagination-controls {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 20px;
                padding-top: 15px;
                border-top: 1px solid #2a2a4a;
            }
            .pagination-controls button {
                background-color: #2a2a4a;
                border: 1px solid #4a4a6a;
                color: #e0e0e0;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            .pagination-controls button:hover {
                background-color: #3a3a5a;
            }
            .pagination-controls span {
                font-size: 0.9rem;
                font-weight: 300;
            }

            /* --- Comparación de Jugadores --- */
            .search-container {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
            }
            .search-player {
                flex: 1;
                position: relative;
            }
            .search-player input {
                width: 100%;
                padding: 10px;
                background-color: #2a2a4a;
                border: 1px solid #4a4a6a;
                border-radius: 8px;
                color: #e0e0e0;
                font-family: 'Poppins', sans-serif;
            }
            .search-results {
                position: absolute;
                width: 100%;
                background-color: #2a2a4a;
                border: 1px solid #4a4a6a;
                border-radius: 8px;
                margin-top: 5px;
                z-index: 100;
                max-height: 200px;
                overflow-y: auto;
            }
            .search-results div {
                padding: 10px;
                cursor: pointer;
                border-bottom: 1px solid #1e1e3f;
            }
            .search-results div:hover {
                background-color: #3a3a5a;
            }
            .chart-container {
                position: relative;
                height: 400px; /* Altura flexible */
                width: 100%;
            }

            #estadisticas-ofensivas th {
                font-size: 0.65rem; /* Reducimos el tamaño de los títulos de columna */
                padding: 8px 5px;   /* Reducimos el espacio interno */
            }
            #estadisticas-ofensivas td {
                font-size: 0.8rem;  /* Reducimos el tamaño de los números y datos */
                padding: 8px 5px;   /* Reducimos el espacio interno */
            }

            #estadisticas-ofensivas tbody tr:hover {
                background-color: #2a2a4a;
                cursor: pointer;
            }

            #mejores-goles tbody tr:hover {
                background-color: #2a2a4a;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <header class="header">
            <h1>FootViz</h1>
            <div class="controls-container">
                <select id="liga">
                    <option value="premierleague" selected>Premier League</option>
                    <option value="laliga">La Liga</option>
                    <option value="seriea">Serie A</option>
                    <option value="bundesliga">Bundesliga</option>
                    <option value="ligueone">Ligue 1</option>
                </select>
                <button id="tipo-de-estadistica">Estadísticas por Equipo</button>
            </div>
        </header>
        
        <main class="dashboard-wrapper">
            <div class="dashboard-column-left">
                <div class="card">
                    <div class="table-container">
                        <table id="estadisticas-ofensivas">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Jugador</th>
                                    <th>Min</th>
                                    <th>G</th>
                                    <th>Disp</th>
                                    <th>Disp P.</th>
                                    <th>% Disp P.</th>
                                    <th>Disp/90</th>
                                    <th>G/Disp</th>
                                    <th>Dist. Disp</th>
                                    <th>TL</th>
                                    <th>Pen</th>
                                    <th>xG</th>
                                </tr>
                            </thead>
                            <tbody id="maximos-goleadores-jugadores">
                                </tbody>
                        </table>
                    </div>
                    <div class="pagination-controls">
                        <button id="prev">Anterior</button>
                        <span id="page-info"></span>
                        <button id="next">Siguiente</button>
                    </div>
                </div>
            </div>

            <div class="dashboard-column-right">
                <div class="card">
                    <h2 class="card-title">Comparación de Jugadores</h2>
                    <div class="search-container">
                        <div class="search-player">
                            <input type="text" id="searchInput1" placeholder="Buscar jugador 1..." />
                            <div class="search-results" id="searchResults1"></div>
                        </div>
                        <div class="search-player">
                            <input type="text" id="searchInput2" placeholder="Buscar jugador 2..." />
                            <div class="search-results" id="searchResults2"></div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Goles con Menor xG</h2>
                    <table id="mejores-goles">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>xG</th>
                                <th>Partido</th>
                            </tr>
                        </thead>
                        <tbody id="mejores-goles-jugadores">
                            </tbody>
                    </table>
                </div>
            </div>

        </main>

       
        
        


        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            let jugador1Id = null;
            let jugador2Id = null;
            let jugador1Stats = null;
            let jugador2Stats = null;

            function cargarMejoresGoles (ligaSeleccionada){  
                let endpoints = {
                    "premierleague": "1", "laliga": "2", "seriea": "3", "bundesliga": "4", "ligueone": "5"
                };
                fetch(`/mejores-goles/${endpoints[ligaSeleccionada]}`)
                    .then(response => response.json())
                    .then(data => {
                        const tbodyMejoresGoles = document.querySelector("#mejores-goles-jugadores");
                        tbodyMejoresGoles.innerHTML="";
                        const goles = data;
                        goles.forEach(gol => {
                            const fila = document.createElement("tr");
                            fila.dataset.idJugador = gol.id_jugador; 
                            fila.innerHTML = `
                                <td><img src="${gol.url_imagen}">${gol.nombre_jugador}</td>
                                <td>${gol.xg}</td>
                                <td>
                                    <img src="${gol.escudo_local}">
                                    ${gol.goles_local} - ${gol.goles_visitante}
                                    <img src="${gol.escudo_visitante}">
                                </td>
                            `;
                            tbodyMejoresGoles.appendChild(fila);
                        });
                    });
            }
            
            function setupSearch(inputID, jugadorNum){
                const input = document.getElementById(inputID);
                input.addEventListener("input", async (e) => {
                    const query = e.target.value;
                    const resultsDiv = document.getElementById(`searchResults${jugadorNum}`);
                    resultsDiv.innerHTML ="";
                    if (query.length < 2) return;
                    const res = await fetch(`/buscar-jugadores?nombre=${query}`);
                    const jugadores = await res.json();
                    jugadores.forEach(jugador => {
                        const div = document.createElement("div");
                        div.innerHTML = `
                            <img src="${jugador.imagen_equipo}" width="30" />
                            <img src="${jugador.imagen_jugador}" width="30" />
                            ${jugador.nombre_jugador}
                        `;
                        div.style.cursor = "pointer";
                        div.addEventListener("click", async () => {
                            input.value = jugador.nombre_jugador;
                            resultsDiv.innerHTML="";
                            if (jugadorNum === 1) {
                                jugador1Id = jugador.id_jugador;
                                const res = await fetch(`/estadisticas-jugador/${jugador.id_jugador}`);
                                jugador1Stats = await res.json();
                            } else {
                                jugador2Id = jugador.id_jugador;
                                const res = await fetch(`/estadisticas-jugador/${jugador.id_jugador}`);
                                jugador2Stats = await res.json();
                            }
                            if (jugador1Id && jugador2Id) {
                                const maximos = await getMaxStats(jugador1Id, jugador2Id);
                                actualizarRadar(maximos);
                            }
                        });
                        resultsDiv.appendChild(div);
                    });
                });
            }

            function actualizarRadar(maximos) {
                // ... (Tu código de actualizarRadar sin cambios)
            }
            
            function renderRadarChart(stats, rawStats, jugadorNum) {
                // ... (Tu código de renderRadarChart sin cambios)
            }
            
            let tipoDeStat = document.getElementById('tipo-de-estadistica');
            var liga = document.getElementById('liga');
            var tbody = document.querySelector("#estadisticas-ofensivas tbody");
            var endpoints = {
                "premierleague": "/estadisticas-ofensivas-premier-league",
                "laliga": "/estadisticas-ofensivas-la-liga",
                "seriea": "/estadisticas-ofensivas-serie-a", 
                "bundesliga": "/estadisticas-ofensivas-bundesliga",
                "ligueone": "/estadisticas-ofensivas-ligue-one"
            };
            let allData = [];
            let currentPage = 1;
            const pageSize = 10;

            function renderPage() {
                tbody.innerHTML = "";
                const start = (currentPage - 1) * pageSize;
                const end = start + pageSize;
                const pageData = allData.slice(start, end);

                pageData.forEach((estadistica_ofensiva, index) => {
                    const fila = document.createElement("tr");
                    
                    // --- 1. AÑADIMOS EL ID DEL JUGADOR A LA FILA ---
                    // Asegúrate que tu JSON de estadísticas ofensivas incluye 'id_jugador'
                    fila.dataset.idJugador = estadistica_ofensiva.id_jugador; 

                    fila.innerHTML = `
                        <td>${start + index + 1}</td>
                        <td><img src="${estadistica_ofensiva.imagen_jugador}" width="30"> ${estadistica_ofensiva.nombre_jugador} <img src="${estadistica_ofensiva.imagen_equipo}" width="30"></td>
                        <td>${estadistica_ofensiva.minutos}</td>
                        <td>${estadistica_ofensiva.total_goles}</td>
                        <td>${estadistica_ofensiva.disparos}</td>
                        <td>${estadistica_ofensiva.disparos_a_puerta}</td>
                        <td>${estadistica_ofensiva.porcentaje_disparos_a_puerta}</td>
                        <td>${estadistica_ofensiva.disparos_por_90}</td>
                        <td>${estadistica_ofensiva.goles_por_disparo}</td>
                        <td>${estadistica_ofensiva.distancia_promedio_de_disparos}</td>
                        <td>${estadistica_ofensiva.tiros_libres}</td>
                        <td>${estadistica_ofensiva.penales}</td>
                        <td>${estadistica_ofensiva["SUM(ejp.goles_esperados)"]}</td>
                    `;
                    tbody.appendChild(fila);
                });

                document.getElementById("page-info").textContent = 
                    `Página ${currentPage} de ${Math.ceil(allData.length / pageSize)}`;
            }

            function cargarTabla(ligaSeleccionada){
                if (endpoints[ligaSeleccionada]){
                    fetch(endpoints[ligaSeleccionada])
                    .then(response => response.json())
                    .then(data => {
                        allData = data;
                        currentPage = 1;
                        renderPage();
                    })
                    .catch(error => console.error("Error al cargar la pagina: ", error));
                }
            }

            // --- 2. AÑADIMOS EL NUEVO LISTENER ---
            document.getElementById('maximos-goleadores-jugadores').addEventListener('click', function(event) {
                const filaClickeada = event.target.closest('tr');
                if (filaClickeada && filaClickeada.dataset.idJugador) {
                    const jugadorId = filaClickeada.dataset.idJugador;
                    window.location.href = `jugador.html?id=${jugadorId}`;
                }
            });

            document.getElementById('mejores-goles-jugadores').addEventListener('click', function(event) {
                const filaClickeada = event.target.closest('tr');
                if (filaClickeada && filaClickeada.dataset.idJugador) {
                    const jugadorId = filaClickeada.dataset.idJugador;
                    window.location.href = `jugador.html?id=${jugadorId}`;
                }
            });

            document.getElementById("prev").addEventListener("click", () => {
                if(currentPage > 1) { currentPage--; renderPage(); }
            });

            document.getElementById("next").addEventListener("click", () => {
                if(currentPage < Math.ceil(allData.length / pageSize)) { currentPage++; renderPage(); }
            });
            
            liga.addEventListener("change", function(){
                cargarTabla(this.value);
                cargarMejoresGoles(this.value);
            });

            tipoDeStat.addEventListener("click", function(){
                window.location = "estadisticas-ofensivas-equipo.html?liga=" + liga.value;
            });
            
            // --- Carga Inicial ---
            const params = new URLSearchParams(window.location.search);
            const ligaParam = params.get("liga");
            if (ligaParam) {
                liga.value = ligaParam;
            }
            
            cargarTabla(liga.value);
            cargarMejoresGoles(liga.value);
            
            async function getMaxStats(id1, id2) {
                const res = await fetch(`/max-stats/${id1}/${id2}`);
                return await res.json();
            }
            setupSearch("searchInput1", 1);
            setupSearch("searchInput2", 2);
        </script>
    </body>
</html>
