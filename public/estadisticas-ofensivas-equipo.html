<!DOCTYPE html>
<html>
    <head>
        <title>Estadisticas Ofensivas Por Equipo</title>
        <h3>Estadisticas Ofensivas Por Equipo</h3>
        <style>
            th, td {
                padding: 10px;
                border: 1px solid #aaa;
                text-align: center;
            }
            img {
                width: 32px;
                height: auto;
                vertical-align: middle;
                margin-right: 10px;
            }
        </style>
    </head>
    <body> 
        <div>
            <form action="#" style="display: inline;">
                <label for="liga">Selecciona una Liga</label>
                <select id="liga">
                    <option value="premierleague" selected>Premier League</option>
                    <option value="laliga">La Liga</option>
                    <option value="seriea">Serie A</option>
                    <option value="bundesliga">Bundesliga</option>
                    <option value="ligueone">Ligue 1</option>
                </select>
            </form> 
            <button id="tipo-de-estadistica">Ver Estadisticas Individuales</button> 
        </div>
        <div>
            <div style="width: 1000px;">
                <table id="estadisticas-ofensivas-equipo">
                    <thead>
                        <tr>
                            <th>Club</th>
                            <th>Partidos Jugados</th>
                            <th>Goles</th>
                            <th>Disparos</th>
                            <th>Disparos a Puerta</th>
                            <th>% Disparos a Puerta</th>
                            <th>xG</th>
                            <th>Disparos/PJ</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
            
            <div style="width: 800px; height: 800px;">
                <canvas id="lineChart"></canvas>
            </div>
            <div style="width: 800px; height: 500px;">
                <p id="label-equipo"></p>
                <canvas id="campoCanvas" width="800" height="500" ></canvas>
            </div>
            <div id="tooltip" 
                style="position: absolute; display: none; 
                        background: rgba(0,0,0,0.8); color: #fff; 
                        padding: 5px; border-radius: 5px; font-size: 14px;">
            </div>
            <div style="width: 900px; height: 700px; margin-top: 230px;">
                
                <canvas id="porteriaCanvas" width="900" height="700"></canvas>
            </div>

            
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script>
            let tipoDeStat = document.getElementById('tipo-de-estadistica');
            tipoDeStat.addEventListener("click", function(){
                window.location = "estadistica_ofensivas.html?liga=" + liga.value;
            });

            let liga = document.getElementById('liga');
            
            function cargarTablaStats(ligaSeleccionada){
                let endpoints = {
                    "premierleague": "1",
                    "laliga": "2",
                    "seriea": "3", 
                    "bundesliga": "4",
                    "ligueone": "5"

                } 
                fetch(`/estadisticas-ofensivas-equipo/${endpoints[ligaSeleccionada]}`)
                .then(response => response.json())
                .then(data => {
                    const tbodyStatsOfensivas = document.querySelector("#estadisticas-ofensivas-equipo tbody");
                    tbodyStatsOfensivas.innerHTML="";
                    const stats = data;
                    stats.forEach(stat => {
                        const fila = document.createElement("tr");
                        fila.innerHTML = `
                            <td><img src="${stat.url_imagen}">${stat.nombre}</td>
                            <td>${stat.partidos_jugados}</td>
                            <td>${stat.goles_anotados}</td>
                            <td>${stat.disparos}</td>
                            <td>${stat.disparos_a_puerta}</td>
                            <td>${stat.porcentaje_disparos_a_puerta}</td>
                            <td>${stat.xg}</td>
                            <td>${stat.disparos_por_90}</td>
                            <td><button class="btn-estadisticas" data-equipo="${stat.id_equipo}">🥅</button></td>
                        `;
                        tbodyStatsOfensivas.appendChild(fila);
                        
                        
                    });
                    renderChart();

                })

                

            }
            
            
            function dibujarCampo(ctx) { 
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); 
                // Fondo verde 
                ctx.fillStyle = "#3a5f0b"; 
                ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height); 
                // Límites del campo 
                ctx.strokeStyle = "#fff"; 
                ctx.lineWidth = 2; 
                ctx.strokeRect(50, 50, 700, 400); 
                // Línea de medio campo 
                ctx.beginPath(); 
                ctx.moveTo(400, 50); 
                ctx.lineTo(400, 450); 
                ctx.stroke(); 
                // Círculo central 
                ctx.beginPath(); 
                ctx.arc(400, 250, 60, 0, Math.PI * 2); 
                ctx.stroke(); 
                // Áreas grandes 
                ctx.strokeRect(50, 150, 100, 200); 
                ctx.strokeRect(650, 150, 100, 200); 
                // Áreas chicas 
                ctx.strokeRect(50, 200, 50, 100); 
                ctx.strokeRect(700, 200, 50, 100); 
                // Puntos de penalti 
                ctx.beginPath(); 
                ctx.arc(150, 250, 3, 0, Math.PI * 2); 
                ctx.fillStyle = "#fff"; 
                ctx.fill(); 
                ctx.beginPath(); 
                ctx.arc(650, 250, 3, 0, Math.PI * 2); 
                ctx.fill(); 
            }

            function dibujarPorteria(ctx) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

                // Césped debajo de la portería
                ctx.fillStyle = "#3a5f0b";
                ctx.fillRect(0, 350, ctx.canvas.width, 50);

                // Fondo de la portería
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(100, 50, 400, 300);

                // Borde de la portería
                ctx.strokeStyle = "#000";
                ctx.lineWidth = 3;
                ctx.strokeRect(200, 150, 500, 200);

                
            }

            let disparosPorteriaGuardados = [];
            function plotearDisparosPorteria(ctx, disparos) {
                disparosPorteriaGuardados = [];
                disparos.forEach(d => {
                    
                    const x = 2910 - (d.goal_mouth_y / 100) * 4950; 
                    const y = 350 - (d.goal_mouth_z * 5.25);

                    const radio = 11;
                    ctx.beginPath();
                    ctx.arc(x, y, radio, 0, Math.PI * 2);
                    ctx.fillStyle = d.resultado === "goal" ? "red" : "blue";
                    ctx.fill();
                    ctx.strokeStyle = "#000";
                    ctx.stroke();

                    disparosPorteriaGuardados.push({
                        x, y, radio,
                        jugador: d.nombre,
                        resultado: d.resultado
                    });
                });
            }

            const porteriaCanvas = document.getElementById("porteriaCanvas");
            porteriaCanvas.addEventListener("mousemove", (e) => {
                const rect = porteriaCanvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                let encontrado = null;
                for (let d of disparosPorteriaGuardados) {
                    const dist = Math.sqrt((mouseX - d.x) ** 2 + (mouseY - d.y) ** 2);
                    if (dist <= d.radio) {
                        encontrado = d;
                        break;
                    }
                }

                if (encontrado) {
                    tooltip.style.display = "block";
                    tooltip.style.left = e.pageX + 10 + "px";
                    tooltip.style.top = e.pageY + 10 + "px";
                    tooltip.innerHTML = `<b>${encontrado.jugador}</b><br>
                    Resultado: ${encontrado.resultado}`;
                } else {
                    tooltip.style.display = "none";
                }
            });

            let disparosGuardados = [];
            function plotearDisparos(ctx, disparos) { 
                disparosGuardados = [];
                disparos.forEach(d => {
                    const x = 50 + (d.pitch_x / 100) * 700; 
                    const y = (50 + (1-d.pitch_y / 100) * 400); 
                    const radio = Math.max(4, Math.min(15, d.xg * 20));
                    ctx.beginPath();
                    ctx.arc(x, y, radio, 0, Math.PI * 2);
                    ctx.fillStyle = d.resultado === "goal" ? "red" : "yellow"; 
                    ctx.fill();
                    ctx.strokeStyle = "#000";
                    ctx.stroke();

                    disparosGuardados.push({
                        x, y, radio,
                        jugador: d.nombre,
                        xg: d.xg,
                        resultado: d.resultado
                    });
                }); 
                ctx.restore();
            }

            const canvas = document.getElementById("campoCanvas");
            const tooltip = document.getElementById("tooltip");

            canvas.addEventListener("mousemove", (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                let encontrado = null;
                for (let d of disparosGuardados) {
                    const dist = Math.sqrt((mouseX - d.x) ** 2 + (mouseY - d.y) ** 2);
                    if (dist <= d.radio) {
                        encontrado = d;
                        break;
                    }
                }

                if (encontrado) {
                    tooltip.style.display = "block";
                    tooltip.style.left = e.pageX + 10 + "px";
                    tooltip.style.top = e.pageY + 10 + "px";
                    tooltip.innerHTML = `<b>${encontrado.jugador}</b><br>
                     xG: ${encontrado.xg}<br>
                     Resultado: ${encontrado.resultado}`;
                } else {
                    tooltip.style.display = "none";
                }
            });

            canvas.addEventListener("mouseleave", () => {
                tooltip.style.display = "none";
            });


            



            function renderChart(){
                
                document.querySelectorAll(".btn-estadisticas").forEach(button => {
                    button.addEventListener("click", function(){
                        const equipoId = this.getAttribute("data-equipo");
                        const canvas = document.getElementById("campoCanvas");
                        const ctxCampo = canvas.getContext("2d");
                        console.log ("Equipo ID:", equipoId);
                        fetch(`/goles-esperados-equipo/${equipoId}`)
                            .then(response => response.json())
                            .then(info => {
                                const jornadas = info.map(item => `Jornada ${item.jornada}`);
                                const xgEquipo = info.map(item => item.xg_equipo);
                                const xgRival = info.map(item => item.xg_rival);

                                const ctx = document.getElementById('lineChart').getContext('2d');

                                if (window.lineChartInstance) {
                                    window.lineChartInstance.destroy();
                                }

                                window.lineChartInstance = new Chart(ctx, {
                                    type: 'line',
                                    data: {
                                        labels: jornadas,
                                        datasets: [
                                            {
                                                label: 'xG Equipo',
                                                data: xgEquipo,
                                                borderColor: 'rgba(54, 162, 235, 1)',
                                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                                tension: 0.3
                                            },
                                            {
                                                label: 'xG Rival',
                                                data: xgRival,
                                                borderColor: 'rgba(255, 99, 132, 1)',
                                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                                
                                                tension: 0.3
                                            }
                                        ]
                                    },
                                    options: {
                                        responsive: true,
                                        plugins: {
                                            legend: {
                                                position: 'top',
                                            },
                                            title: {
                                                display: true,
                                                text: 'xG por Jornada'
                                            }
                                        }
                                    }
                                });

                            });

                        fetch(`/mapa-disparos/${equipoId}`)
                            
                            .then(response => response.json())
                            .then(data => {
                                const nombreEquipo = data[0].nombre_equipo;
                                labelEquipo = document.getElementById("label-equipo");
                                labelEquipo.innerHTML=`<p>Mapa de disparos de equipo: ${nombreEquipo}</p>`
                                dibujarCampo(ctxCampo);
                                plotearDisparos(ctxCampo, data);
                                const ctxPorteria = document.getElementById("porteriaCanvas").getContext("2d");
                                
                                dibujarPorteria(ctxPorteria);
                                plotearDisparosPorteria(ctxPorteria, data);

                            })

                    })
                })
              
            }
            const params = new URLSearchParams(window.location.search);
            const ligaParam = params.get("liga");
            if (ligaParam) { 
                liga.value = ligaParam;
                cargarTablaStats(ligaParam);
            } else {
                cargarTablaStats(liga.value);
            }
            liga.addEventListener("change", function(){
                cargarTablaStats(this.value);
            })


        </script> 

    </body>
</html>