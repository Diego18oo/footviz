<!DOCTYPE html>
<html>
    <head>
        <title>FootViz - Estadisticas Ofensivas Por Equipo</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
   
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: 'Poppins', sans-serif;
                background-color: #1a1a2e;
                color: #e0e0e0;
                padding: 20px;
                transition: background-color 0.3s, color 0.3s;
            }
            /* --- Cabecera --- */
            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                max-width: 1400px;
                margin: 0 auto 30px auto;
                padding-bottom: 20px;
                border-bottom: 1px solid #2a2a4a;
                transition: border-bottom-color 0.3s;
            }
            .header h1 { font-size: 2rem; color: #ffffff; font-weight: 700; }
            .header .controls-container { display: flex; align-items: center; gap: 20px; }
            .header select, .header button {
                background-color: #2a2a4a;
                color: #e0e0e0;
                border: 1px solid #4a4a6a;
                border-radius: 8px;
                padding: 10px 15px;
                font-family: 'Poppins', sans-serif;
                font-size: 0.9rem;
                cursor: pointer;
                transition: background-color 0.2s, color 0.3s, border-color 0.3s;
            }
            .header select:hover, .header button:hover { background-color: #3a3a5a; }
            /* --- BOT√ìN PARA CAMBIAR TEMA --- */
            .theme-toggle-button {
                background: #2a2a4a;
                border: 1px solid #4a4a6a;
                color: #fff;
                width: 42px;
                height: 42px;
                padding: 10px;
                border-radius: 50%;
                font-size: 1.2rem;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .theme-toggle-button:hover { background: #3a3a5a; transform: scale(1.1); }
            /* --- Contenedor Principal --- */
            .dashboard-wrapper { display: flex; gap: 30px; max-width: 1400px; margin: 0 auto; align-items: flex-start; }
            .dashboard-column-left { flex: 2; }
            .dashboard-column-right { flex: 2; display: flex; flex-direction: column; gap: 30px; }
            .full-width-wrapper { max-width: 750px; margin: 30px auto 0 auto; }
            /* --- Estilo de Tarjeta --- */
            .card {
                background-color: #1e1e3f;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                width: 100%;
                transition: background-color 0.3s, box-shadow 0.3s;
            }
            .card-title {
                font-size: 1.2rem;
                font-weight: 600;
                color: #ffffff;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid #4a4a6a;
                transition: color 0.3s, border-bottom-color 0.3s;
            }
            /* --- Estilos de Tablas --- */
            .table-container { overflow-x: auto; }
            table { width: 100%; border-collapse: collapse; }
            th, td { padding: 12px 10px; text-align: center; white-space: nowrap; }
            thead tr { border-bottom: 2px solid #4a4a6a; transition: border-bottom-color 0.3s; }
            th { font-weight: 600; color: #ffffff; font-size: 0.8rem; text-transform: uppercase; }
            tbody tr { border-bottom: 1px solid #2a2a4a; transition: background-color 0.2s ease, border-bottom-color 0.3s; }
            tbody tr:last-child { border-bottom: none; }
            tbody tr:hover { background-color: #2a2a4a; }
            #estadisticas-ofensivas-equipo th:first-child, 
            #estadisticas-ofensivas-equipo td:first-child { text-align: left; }
            img { width: 28px; height: 28px; vertical-align: middle; margin-right: 12px; border-radius: 50%; }
            .btn-estadisticas { background-color: #4a4a6a; border: none; color: white; padding: 8px; font-size: 1rem; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; transition: background-color 0.2s; }
            .btn-estadisticas:hover { background-color: #007bff; }
            /* --- Visualizaciones --- */
            .chart-container, .pitch-container, .goal-container { position: relative; width: 100%; }
            .chart-container { height: 300px; }
            .pitch-container { height: 300px; margin-top: 15px; }
            .goal-container { height: 250px; margin-top: 15px; }
            canvas { width: 100%; height: 100%; }
            #label-equipo { font-weight: 600; color: #ffffff; padding-bottom: 10px; margin-bottom: 15px; border-bottom: 1px solid #4a4a6a; transition: color 0.3s, border-bottom-color 0.3s; }
            #tooltip { position: absolute; display: none; background: rgba(40, 40, 74, 0.9); color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; pointer-events: none; border: 1px solid #4a4a6a; }
            
            /* ------------------------- */
            /* --- ESTILOS MODO LUZ --- */
            /* ------------------------- */
            body.light-mode { background-color: #f4f4f9; color: #333333; }
            body.light-mode .header { border-bottom-color: #e0e0e0; }
            body.light-mode .header h1, body.light-mode .card-title, body.light-mode th, body.light-mode #label-equipo { color: #1a1a2e; }
            body.light-mode .header select, body.light-mode .header button { background-color: #ffffff; border-color: #d1d1d1; color: #333333; }
            body.light-mode .header select:hover, body.light-mode .header button:hover { background-color: #f0f0f0; }
            body.light-mode .theme-toggle-button { background: #ffffff; border-color: #d1d1d1; color: #333; }
            body.light-mode .theme-toggle-button:hover { background: #f0f0f0; }
            body.light-mode .card { background-color: #ffffff; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
            body.light-mode .card-title, body.light-mode #label-equipo { border-bottom-color: #e0e0e0; }
            body.light-mode thead tr { border-bottom-color: #d1d1d1; }
            body.light-mode tbody tr { border-bottom-color: #e0e0e0; }
            body.light-mode tbody tr:hover { background-color: #e9e9f3; }
            body.light-mode .btn-estadisticas { background-color: #e9e9f3; color: #333; }
            body.light-mode .btn-estadisticas:hover { background-color: #007bff; color: white; }
            body.light-mode #tooltip { background: rgba(255, 255, 255, 0.95); color: #333; border-color: #d1d1d1; }
            .sortable-header {
                cursor: pointer;
                transition: color 0.2s ease;
            }
            .sortable-header:hover {
                color: #4a69ff; /* Un color de realce al pasar el mouse */
            }
            /* Estilos para las flechas que indican el ordenamiento */
            .sortable-header::after {
                content: '';
                display: inline-block;
                width: 10px;
                height: 10px;
                margin-left: 5px;
                opacity: 0.4;
            }
            /* Flecha descendente (‚ñº) */
            .sortable-header.sort-desc::after {
                content: ' ‚ñº';
                opacity: 1;
                font-size: 0.7em;
            }
            /* Flecha ascendente (‚ñ≤) */
            .sortable-header.sort-asc::after {
                content: ' ‚ñ≤';
                opacity: 1;
                font-size: 0.7em;
            }

            /* Para el modo claro */
            body.light-mode .sortable-header:hover {
                color: #4a69ff;
            }
            body.light-mode .sortable-header.sort-desc::after,
            body.light-mode .sortable-header.sort-asc::after {
                color: #1a1a2e; /* Color oscuro para las flechas en modo claro */
            }
        </style>
    </head>
    <body> 
        <header class="header">
            <h1>FootViz</h1>
            <div class="controls-container">
                <select id="liga">
                    <option value="premierleague" selected>Premier League</option>
                    <option value="laliga">La Liga</option>
                    <option value="seriea">Serie A</option>
                    <option value="bundesliga">Bundesliga</option>
                    <option value="ligueone">Ligue 1</option>
                </select>
                <button id="tipo-de-estadistica">Estad√≠sticas Individuales</button>
                <button id="theme-toggle" class="theme-toggle-button">‚òÄÔ∏è</button>
            </div>
        </header>

        <main>
            <div class="dashboard-wrapper">
                <div class="dashboard-column-left">
                    <div class="card">
                        <div class="table-container">
                            <table id="estadisticas-ofensivas-equipo">
                                <thead>
                                    <tr>
                                        <th class="sortable-header" data-sort-key="nombre">Club</th>
                                        <th class="sortable-header" data-sort-key="partidos_jugados">PJ</th>
                                        <th class="sortable-header" data-sort-key="goles_anotados">Goles</th>
                                        <th class="sortable-header" data-sort-key="disparos">Disparos</th>
                                        <th class="sortable-header" data-sort-key="disparos_a_puerta">Disp. Puerta</th>
                                        <th class="sortable-header" data-sort-key="porcentaje_disparos_a_puerta">% Disp. Puerta</th>
                                        <th class="sortable-header" data-sort-key="xg">xG</th>
                                        <th class="sortable-header" data-sort-key="disparos_por_90">Disp./PJ</th>
                                        <th>Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="dashboard-column-right">
                    <div class="card">
                        <h2 class="card-title">Diferencias de xG</h2>
                        <div class="chart-container">
                            <canvas id="lineChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="card-title">Mapa de Disparos (Porter√≠a)</h2>
                        <div class="goal-container">
                            <canvas id="porteriaCanvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="full-width-wrapper">
                <div class="card">
                    <h2 class="card-title">Mapa de Disparos</h2>
                    <p id="label-equipo">Selecciona un equipo de la tabla para ver sus disparos</p>
                    <div class="pitch-container">
                        <canvas id="campoCanvas"></canvas>
                    </div>
                </div>
            </div>
        </main>

        <div id="tooltip"></div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                let allStatsData = []; 
                let sortColumn = 'goles_anotados'; 
                let sortDirection = 'desc';
                
                const ligaSelect = document.getElementById('liga');
                const tipoDeStatBtn = document.getElementById('tipo-de-estadistica');
                const tooltip = document.getElementById("tooltip");
                let disparosGuardados = [];
                let disparosPorteriaGuardados = [];
                let lineChartInstance = null;
                
                const themeToggleButton = document.getElementById('theme-toggle');
                const body = document.body;

                const darkLineOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: '#e0e0e0' }, grid: { color: 'rgba(224, 224, 224, 0.1)' } }, x: { ticks: { color: '#e0e0e0' }, grid: { color: 'rgba(224, 224, 224, 0.1)' } } }, plugins: { legend: { labels: { color: '#e0e0e0' } } } };
                const lightLineOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: '#666' }, grid: { color: 'rgba(0, 0, 0, 0.1)' } }, x: { ticks: { color: '#666' }, grid: { color: 'rgba(0, 0, 0, 0.1)' } } }, plugins: { legend: { labels: { color: '#333' } } } };

                const applyTheme = (theme) => {
                    if (theme === 'light') {
                        body.classList.add('light-mode');
                        themeToggleButton.textContent = 'üåô';
                        if (lineChartInstance) { lineChartInstance.options = lightLineOptions; lineChartInstance.update(); }
                    } else {
                        body.classList.remove('light-mode');
                        themeToggleButton.textContent = '‚òÄÔ∏è';
                        if (lineChartInstance) { lineChartInstance.options = darkLineOptions; lineChartInstance.update(); }
                    }
                    if (document.querySelectorAll(".btn-estadisticas").length > 0) {
                        const activeButton = document.querySelector(".btn-estadisticas[data-active='true']");
                        if(activeButton) activeButton.click();
                    }
                };

                const savedTheme = localStorage.getItem('theme') || 'dark';
                applyTheme(savedTheme);

                themeToggleButton.addEventListener('click', () => {
                    const newTheme = body.classList.contains('light-mode') ? 'dark' : 'light';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                });
                
                
                tipoDeStatBtn.addEventListener("click", function() {
                    window.location = "estadistica_ofensivas.html?liga=" + ligaSelect.value;
                });

                function sortStatsData() {
                    allStatsData.sort((a, b) => {
                        const valA = a[sortColumn];
                        const valB = b[sortColumn];

                        const numA = parseFloat(valA);
                        const numB = parseFloat(valB);

                        let comparison = 0;
                        
                        if (!isNaN(numA) && !isNaN(numB)) {
                            comparison = numA - numB;
                        } else {
                            comparison = valA.toString().localeCompare(valB.toString());
                        }

                        return (sortDirection === 'desc') ? (comparison * -1) : comparison;
                    });
                }
                

                // RQF2
                function handleHeaderClick(event) {
                    const clickedKey = event.currentTarget.dataset.sortKey;

                    if (sortColumn === clickedKey) {
                        sortDirection = (sortDirection === 'desc') ? 'asc' : 'desc';
                    } else {
                        sortColumn = clickedKey;
                        sortDirection = 'desc';
                    }
                    
                    sortStatsData(); 
                    renderTablaStats(); 
                    updateHeaderArrows(); 
                }

                function updateHeaderArrows() {
                    document.querySelectorAll('#estadisticas-ofensivas-equipo th[data-sort-key]').forEach(th => {
                        th.classList.remove('sort-asc', 'sort-desc');
                        if (th.dataset.sortKey === sortColumn) {
                            th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                        }
                    });
                }

                // RQF1 
                function renderTablaStats() {
                    const tbodyStatsOfensivas = document.querySelector("#estadisticas-ofensivas-equipo tbody");
                    tbodyStatsOfensivas.innerHTML = "";
                    
                    allStatsData.forEach(stat => {
                        const fila = document.createElement("tr");
                        fila.innerHTML = `
                            <td><img src="${stat.url_imagen}">${stat.nombre}</td>
                            <td>${stat.partidos_jugados}</td> <td>${stat.goles_anotados}</td>
                            <td>${stat.disparos}</td> <td>${stat.disparos_a_puerta}</td>
                            <td>${stat.porcentaje_disparos_a_puerta}</td> <td>${stat.xg}</td>
                            <td>${stat.disparos_por_90}</td>
                            <td><button class="btn-estadisticas" data-equipo-id="${stat.id_equipo}" data-equipo-nombre="${stat.nombre}">ü•Ö</button></td>
                        `;
                        tbodyStatsOfensivas.appendChild(fila);
                    });
                    addEventListenersToButtons();
                }

                function cargarTablaStats(ligaSeleccionada){
                    let endpoints = { "premierleague": "1", "laliga": "2", "seriea": "3", "bundesliga": "4", "ligueone": "5" };
                    fetch(`/api/estadisticas-ofensivas-equipo/${endpoints[ligaSeleccionada]}`).then(r => r.json()).then(data => {
                        allStatsData = data; 

               
                        sortColumn = 'goles_anotados'; 
                        sortDirection = 'desc';
                        sortStatsData(); 
                        updateHeaderArrows(); 

                        renderTablaStats();


                        // RQNF2
                        const primerBoton = document.querySelector("#estadisticas-ofensivas-equipo tbody tr .btn-estadisticas");

                        if (primerBoton) {
                            primerBoton.click();
                            primerBoton.dataset.active = "true";
                        }
                    });
                    

                }
                
                
                function dibujarCampo(ctx) {
                    const w = ctx.canvas.width, h = ctx.canvas.height;
                    const isLight = body.classList.contains('light-mode');
                    ctx.clearRect(0, 0, w, h);
                    ctx.fillStyle = isLight ? "#d4e9d4" : "#2a5f2a"; 
                    ctx.fillRect(0, 0, w, h);
                    ctx.strokeStyle = isLight ? "rgba(0, 0, 0, 0.4)" : "rgba(255, 255, 255, 0.5)";
                    ctx.lineWidth = 2;
                    const marginX = w * 0.05, marginY = h * 0.05;
                    const fieldW = w - 2 * marginX, fieldH = h - 2 * marginY;
                    ctx.strokeRect(marginX, marginY, fieldW, fieldH);
                    ctx.beginPath(); ctx.moveTo(w / 2, marginY); ctx.lineTo(w / 2, h - marginY); ctx.stroke();
                    ctx.beginPath(); ctx.arc(w / 2, h / 2, fieldW * 0.1, 0, Math.PI * 2); ctx.stroke();
                    ctx.strokeRect(marginX, h / 2 - fieldH * 0.3, fieldW * 0.15, fieldH * 0.6);
                    ctx.strokeRect(w - marginX - fieldW * 0.15, h / 2 - fieldH * 0.3, fieldW * 0.15, fieldH * 0.6);
                }

                function dibujarPorteria(ctx) {
                    const w = ctx.canvas.width, h = ctx.canvas.height;
                    const isLight = body.classList.contains('light-mode');
                    ctx.clearRect(0, 0, w, h);
                    ctx.strokeStyle = isLight ? "rgba(0, 0, 0, 0.7)" : "rgba(255, 255, 255, 0.8)";
                    ctx.lineWidth = 4;
                    const goalW = w * 0.8, goalH = h * 0.8;
                    const startX = (w - goalW) / 2, startY = (h - goalH) / 2;
                    ctx.strokeRect(startX, startY, goalW, goalH);
                }
                

                function plotearDisparos(ctx, disparos) {
                    disparos.sort((a, b) => (a.resultado === 'goal') - (b.resultado === 'goal'));
                    disparosGuardados.length = 0;
                    const w = ctx.canvas.width, h = ctx.canvas.height;
                    const marginX = w * 0.05, marginY = h * 0.05;
                    const fieldW = w - 2 * marginX, fieldH = h - 2 * marginY;

                    disparos.forEach(d => {
                        const x = marginX + (d.pitch_x / 100) * fieldW;
                        const y = marginY + (1 - d.pitch_y / 100) * fieldH;
                        const radio = Math.max(4, Math.min(15, d.xg * 20));

                        ctx.beginPath();
                        ctx.arc(x, y, radio, 0, Math.PI * 2);
                        ctx.fillStyle = d.resultado === "goal" ? "#ff4d4d" : "#ffd700"; 
                        ctx.fill();
                        ctx.strokeStyle = "rgba(0, 0, 0, 0.5)";
                        ctx.stroke();

                        disparosGuardados.push({ x, y, radio, jugador: d.nombre, xg: d.xg, resultado: d.resultado });
                    });
                }

                function plotearDisparosPorteria(ctx, disparos) {
                    disparos.sort((a, b) => (a.resultado === 'goal') - (b.resultado === 'goal'));
                    
                    disparosPorteriaGuardados.length = 0;
                    const w = ctx.canvas.width, h = ctx.canvas.height;
                    
                    const frameW = w * 0.8, frameH = h * 0.65;
                    const frameStartX = (w - frameW) / 2, frameStartY = (h - frameH) / 2;

                    
                    const plotWidth = frameW * 10;   
                    const plotHeight = frameH * 3;  

                    disparos.forEach(d => {
                        
                        const x = (w / 2) - ((d.goal_mouth_y - 50) / 105 * plotWidth);

                        const y = (frameStartY + frameH) - (d.goal_mouth_z / 100 * plotHeight);

                        const radio = 8;

                        ctx.beginPath();
                        ctx.arc(x, y, radio, 0, Math.PI * 2);
                        ctx.fillStyle = d.resultado === "goal" ? "#ff4d4d" : "#007bff";
                        ctx.fill();
                        ctx.strokeStyle = "rgba(255, 255, 255, 0.8)";
                        ctx.stroke();

                        disparosPorteriaGuardados.push({ x, y, radio, jugador: d.nombre, resultado: d.resultado });
                    });
                }

                // RQF3
                function addEventListenersToButtons() {
                    document.querySelectorAll(".btn-estadisticas").forEach(button => {
                        button.addEventListener("click", function() {
                            document.querySelectorAll(".btn-estadisticas").forEach(btn => btn.dataset.active = "false");
                            this.dataset.active = "true";

                            const equipoId = this.getAttribute("data-equipo-id");
                            const equipoNombre = this.getAttribute("data-equipo-nombre");
                            
                            fetch(`/api/goles-esperados-equipo/${equipoId}`).then(r => r.json()).then(info => {
                                const ctx = document.getElementById('lineChart').getContext('2d');
                                if (lineChartInstance) lineChartInstance.destroy();
                                const currentOptions = body.classList.contains('light-mode') ? lightLineOptions : darkLineOptions;
                                lineChartInstance = new Chart(ctx, { type: 'line', data: { labels: info.map(item => `J${item.jornada}`), datasets: [{ label: 'xG a Favor', data: info.map(item => item.xg_equipo), borderColor: 'rgba(54, 162, 235, 1)', backgroundColor: 'rgba(54, 162, 235, 0.2)', fill: true, tension: 0.4 }, { label: 'xG en Contra', data: info.map(item => item.xg_rival), borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', fill: true, tension: 0.4 }] }, options: currentOptions });
                            });
                            

                            
                            fetch(`/api/mapa-disparos/${equipoId}`).then(r => r.json()).then(data => {
                                document.getElementById("label-equipo").textContent = `Mapa de disparos de: ${equipoNombre}`;
                                const campoCanvas = document.getElementById("campoCanvas");
                                const ctxCampo = campoCanvas.getContext("2d");
                                campoCanvas.width = campoCanvas.offsetWidth; campoCanvas.height = campoCanvas.offsetHeight;
                                // RQF5
                                dibujarCampo(ctxCampo);
                                plotearDisparos(ctxCampo, data);

                                const porteriaCanvas = document.getElementById("porteriaCanvas");
                                const ctxPorteria = porteriaCanvas.getContext("2d");
                                porteriaCanvas.width = porteriaCanvas.offsetWidth; porteriaCanvas.height = porteriaCanvas.offsetHeight;

                                // RQF6
                                dibujarPorteria(ctxPorteria);
                                plotearDisparosPorteria(ctxPorteria, data);
                            });
                        });
                    });   
                }

                function setupTooltip(canvas, shotsArray) {
                    canvas.addEventListener("mousemove", (e) => {
                        const rect = canvas.getBoundingClientRect();
                        const mouseX = e.clientX - rect.left;
                        const mouseY = e.clientY - rect.top;
                        let encontrado = null;
                        for (let d of shotsArray) {
                            if (Math.sqrt((mouseX - d.x) ** 2 + (mouseY - d.y) ** 2) <= d.radio) {
                                encontrado = d; break;
                            }
                        }
                        if (encontrado) {
                            tooltip.style.display = "block";
                            tooltip.style.left = e.pageX + 10 + "px";
                            tooltip.style.top = e.pageY + 10 + "px";
                            tooltip.innerHTML = `<b>${encontrado.jugador}</b><br>Resultado: ${encontrado.resultado}${encontrado.xg ? `<br>xG: ${encontrado.xg}` : ''}`;
                        } else {
                            tooltip.style.display = "none";
                        }
                    });
                    canvas.addEventListener("mouseleave", () => tooltip.style.display = "none");
                }

                setupTooltip(document.getElementById("campoCanvas"), disparosGuardados);
                setupTooltip(document.getElementById("porteriaCanvas"), disparosPorteriaGuardados);

                const params = new URLSearchParams(window.location.search);
                const ligaParam = params.get("liga");
                if (ligaParam) ligaSelect.value = ligaParam;
                
                cargarTablaStats(ligaSelect.value);
                ligaSelect.addEventListener("change", function() {
                    cargarTablaStats(this.value);
                });


                document.querySelectorAll('#estadisticas-ofensivas-equipo th[data-sort-key]').forEach(header => {
                    header.addEventListener('click', handleHeaderClick);
                });
            });
            

        </script> 

    </body>
</html>