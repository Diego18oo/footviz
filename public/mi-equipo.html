<!DOCTYPE html>
<html>
    <head>
        <title>FootViz - Mi Equipo Fantasy</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
        <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
        <style>
            /* --- Estilos Base y Layout --- */
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: 'Poppins', sans-serif;
                background-color: #0f172a;
                color: #e0e0e0;
                padding: 20px;
            }
            .container { max-width: 1400px; margin: 0 auto; }

            /* --- Cabecera --- */
            .fantasy-header {
                display: flex; justify-content: space-between; align-items: center;
                background-color: #1e293b; padding: 15px 25px; border-radius: 12px; margin-bottom: 20px;
            }
            .img-club-rival {
                width: 40px;
                height: 40px;
            }
            .user-profile-summary { display: flex; align-items: center; gap: 15px; }
            .user-level-xp { text-align: right; }
            .user-icons { display: flex; gap: 10px; font-size: 1.5rem; }
            .user-icons ion-icon { cursor: pointer; }

            /* --- √Årea Principal --- */
            .team-management-grid {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 20px;
            }

            /* --- Visualizaci√≥n del Equipo (Campo y Banca) --- */
            .team-display-area .card { background-color: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
            h2, h3 { color: #fff; margin-bottom: 15px; }
            .pitch-display {
                background-color: #047857; border-radius: 8px; padding: 20px; aspect-ratio: 7 / 5; /* M√°s horizontal */
                display: grid; grid-template-rows: repeat(4, 1fr); gap: 10px; position: relative; margin-bottom: 20px;
            }
            .pitch-row { display: flex; justify-content: space-around; align-items: center; }
            .player-slot {
                display: flex; flex-direction: column; align-items: center; cursor: pointer;
                padding: 5px; border-radius: 4px; transition: background-color 0.2s; position: relative;
            }
            .player-slot img { width: 40px; height: auto; margin-bottom: 3px; }
            .player-name { font-size: 0.7rem; color: #fff; background-color: rgba(0,0,0,0.6); padding: 1px 4px; border-radius: 3px; white-space: nowrap; max-width: 70px; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
            .player-points { font-size: 0.8rem; font-weight: 600; color: #fff; }
            .captain-badge { position: absolute; top: 0; right: 0; background-color: #f59e0b; color: #000; font-size: 0.6rem; font-weight: 700; border-radius: 50%; width: 16px; height: 16px; display: flex; justify-content: center; align-items: center; }

            .bench-display { display: flex; justify-content: space-around; align-items: center; background-color: #334155; padding: 10px; border-radius: 8px; }
            .bench-display .player-slot { background-color: transparent; } /* Quitar fondo extra en banca */

            /* --- Barra Lateral Derecha --- */
            .sidebar-area { display: flex; flex-direction: column; gap: 20px; }
            .sidebar-area .card { background-color: #1e293b; border-radius: 12px; padding: 20px; }
            .team-status span, .team-status p { display: block; margin-bottom: 8px; font-size: 0.9rem; }
            .team-status strong { color: #fff; }
            .action-buttons button { background-color: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-right: 10px; font-size: 0.9rem; }
            #chips-list button { background-color: #4f46e5; margin-bottom: 5px; display: block; width: 100%; }
            #chips-list button:disabled { background-color: #475569; cursor: not-allowed; }
            #upcoming-fixtures li { list-style: none; margin-bottom: 8px; font-size: 0.9rem; border-bottom: 1px solid #334155; padding-bottom: 5px; }

            /* --- Modal Oculto para Info del Jugador --- */
            .player-modal {
                display: none; /* Oculto por defecto */
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.7);
                justify-content: center; align-items: center; z-index: 1000;
            }
            .modal-content {
                background-color: #1e293b; 
                padding: 30px; 
                border-radius: 12px;
                max-width: 700px; /* Ya lo tienes, perfecto */
                width: 90%;
                text-align: center; 
                position: relative;
                
                /* üëá A√ëADE ESTO üëá */
                display: flex;
                flex-direction: column;
                max-height: 90vh;
            }
            .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.8rem; color: #94a3b8; background: none; border: none; cursor: pointer; }
            #modal-player-img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; }
            #modal-player-club { width: 40px; height: 40px;  }
            #modal-points-breakdown { max-height: 150px; overflow-y: auto; margin-top: 15px; border-top: 1px solid #334155; padding-top: 10px; }
            /* A√±adir estilos para botones de acci√≥n dentro del modal (Sustituir, Capitan) */
            .point-breakdown-item {
                display: flex;         /* üëà ¬°La magia de Flexbox! Pone los elementos en l√≠nea */
                align-items: center;   /* Centra la imagen y el texto verticalmente */
                gap: 10px;             /* Espacio entre el texto y la imagen */
                padding: 8px 0;        /* Un poco de espacio vertical entre cada fila */
                border-bottom: 1px solid #334155; /* Un separador ligero */
                font-size: 0.9rem;
            }

            .point-breakdown-item:last-child {
                border-bottom: none;   /* Sin borde en el √∫ltimo elemento */
            }

            .rival-logo {
                width: 24px;           /* Tama√±o peque√±o para el logo */
                height: 24px;          /* Tama√±o peque√±o para el logo */
                border-radius: 50%;    /* Redondito, como en tu app */
                object-fit: cover;     /* Asegura que la imagen se vea bien */
            }

            .player-list-container {
                flex-grow: 1; /* Ocupa el espacio restante */
                overflow-y: auto; /* Permite scroll si hay muchos jugadores */
                max-height: 400px; /* Ya lo tienes, pero ahora funcionar√° */
            }
            #transfer-modal .player-list {
                width: 100%;
                border-collapse: collapse;
            }

            #transfer-player-list-body td {
                padding: 10px 8px;
                text-align: left;
                border-bottom: 1px solid #334155;
                font-size: 0.85rem;
                vertical-align: middle; /* Alinea el texto con las im√°genes */
            }

            #transfer-player-list-body img {
                width: 24px;  /* Tama√±o peque√±o */
                height: 24px; /* Tama√±o peque√±o */
                border-radius: 50%;
                object-fit: cover;
                vertical-align: middle; /* Alinea la imagen con el texto */
                margin-right: 8px;
            }

            #transfer-player-list-body tr:hover {
                background-color: #334155; /* Efecto hover */
            }
        </style>
    </head>
    <body>
        <div class="container">

            <header class="fantasy-header">
                <div class="user-profile-summary">
                    <ion-icon name="extension-puzzle-outline" title="Mis Piezas"></ion-icon>
                    <div class="user-level-xp">
                        <div>Nivel <strong id="user-level">--</strong></div>
                        <div><span id="user-xp">--</span> xp</div>
                    </div>
                    <h2 id="username-display">Usuario</h2>
                </div>
                <div class="user-icons">
                    <ion-icon name="trophy-outline" title="Mis Logros"></ion-icon>
                    <ion-icon name="person-circle-outline" title="Mi Perfil"></ion-icon>
                    </div>
            </header>

            <main class="team-management-grid">

                <div class="team-display-area">
                    <div class="card team-status">
                        <h3>Estado del Equipo</h3>
                        <span>Presupuesto: <strong id="budget-remaining">-- M</strong></span>
                        <span>Fichajes Restantes: <strong id="transfers-remaining">--</strong></span>
                        <p>Deadline Jornada: <span id="current-gameweek">Jueves 11:59 pm (hora centro de Mexico)</span></p>
                        
                    </div>

                    <div class="card pitch-container">
                        <h2>Alineaci√≥n Titular</h2>
                        <div class="pitch-display" id="pitch">
                            <div class="pitch-row" id="pitch-row-F"></div>
                            <div class="pitch-row" id="pitch-row-M"></div>
                            <div class="pitch-row" id="pitch-row-D"></div>
                            <div class="pitch-row" id="pitch-row-G"></div>
                        </div>
                    </div>

                    <div class="card bench-container">
                        <h3>Banca</h3>
                        <div class="bench-display" id="bench">
                            <div class="player-slot" data-player-id="123" data-position="G">
                                <img src="placeholder-player-face.png" alt="Jugador">
                                <span class="player-name">Jugador Banca 1</span>
                                <span class="player-points">0 Pts</span>
                            </div>
                            <div class="player-slot" data-player-id="124" data-position="D">
                                <img src="placeholder-player-face.png" alt="Jugador">
                                <span class="player-name">Jugador Banca 2</span>
                                <span class="player-points">0 Pts</span>
                            </div>
                            </div>
                    </div>
                </div>

                <div class="sidebar-area">
                    <div class="card action-buttons">
                        <button id="save-team-changes-btn" style="width: 100%; ">
                            Guardar Cambios
                        </button>
                    </div>
                    
                    <div class="card chips-section">
                        <h3>Fichas Disponibles</h3> <div id="chips-list">
                            <button id="chip-triple-captain" disabled>Triple Capit√°n</button>
                            <button id="chip-bench-boost" disabled>Banca Potenciada</button>
                            </div>
                    </div>
                    
                </div>
            </main>

            <div id="player-info-modal" class="player-modal">
                <div class="modal-content">
                    <button class="modal-close-btn" onclick="closePlayerModal()">&times;</button>
                    <img id="modal-player-img" src="placeholder-player-face.png" alt="Jugador">
                    <h3 id="modal-player-name">Nombre Jugador</h3>
                    <p><img src="" id="modal-player-club"> - <span id="modal-player-pos">POS</span></p>
                    <p>Valor: <strong id="modal-player-value">--M</strong> | Popularidad: <strong id="modal-player-popularity">--%</strong></p>
                    <p>Puntos Totales: <strong id="modal-player-total-points">--</strong></p>

                    <h4>Desglose de Puntos por Jornada:</h4>
                    <div id="modal-points-breakdown">
                        </div>

                    <h4>Pr√≥ximo Partido:</h4>
                    <p id="modal-next-fixture">
                        
                    </p>

                    <div class="modal-actions" style="margin-top: 20px;">
                        <button id="modal-substitute-btn">Sustituir</button>
                        <button id="modal-make-captain-btn">Hacer Capit√°n</button>
                        <button id="modal-transfer-out-btn" style="background-color: #dc2626;">Vender</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="transfer-modal" class="player-modal">
            <div class="modal-content" style="max-width: 700px;">
                <button class="modal-close-btn" onclick="closeTransferModal()">&times;</button>
                <h3>Fichar Reemplazo</h3>
                <p>Vendiendo a: <strong id="transfer-sell-player-name">...</strong></p>
                <p>Presupuesto actual: <strong id="transfer-current-budget">...</strong></p>
                
                <div class="filters">
                    <select id="transfer-position-filter">
                        </select>
                    <select id="transfer-team-filter">
                        <option value="ALL">Equipo: Todos</option>
                    </select>
                    <input type="text" id="transfer-search-player" placeholder="Buscar jugador...">
                </div>
                
                <div class="player-list-container" style="max-height: 400px;">
                    <table class="player-list">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>Precio</th>
                                <th>Pts</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="transfer-player-list-body">
                            </tbody>
                    </table>
                    <div class="pagination-controls" id="transfer-pagination">
                        <button id="transfer-prev-page" disabled>&laquo;</button>
                        <span id="transfer-page-numbers"></span>
                        <button id="transfer-next-page">&raquo;</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let fichajesBase = 0; 
            let fichajesRealizadosEnSesion = 0;
            let fichajesExtra = 0
            let activeChipId = null; 
            let extraTransferActive = false; 
            let doubleCaptainActive = false;
            let miPlantilla = []; 
            let allAvailablePlayers = []; 
            let transferFilteredPlayers = []; 
            let currentPlayerIdInModal = null;
            let draggedPlayerId = null;
            let playerToSell = null;
            let transferCurrentPage = 1;
            let retroCaptainActive = false;    
            let tripleCaptainActive = false;   
            let tacticalChangeActive = false;  
            let wildcardActive = false;        
            let freeHitActive = false;

            const CHIP_UNLOCK_LEVELS = {
                3: 9,  // Retro
                4: 10, // x3
                5: 11, // T√°ctico
                6: 12, // Comod√≠n
                7: 12  // Sin L√≠mites
            };
            const transferPlayersPerPage = 10;
            const saveChangesButton = document.getElementById('save-team-changes-btn');
            const playerModal = document.getElementById('player-info-modal');
            const transferModal = document.getElementById('transfer-modal');
            const pitchDisplay = document.getElementById('pitch');
            const benchDisplay = document.getElementById('bench');
            
            const transferTBody = document.getElementById('transfer-player-list-body');
            const transferPosFilter = document.getElementById('transfer-position-filter');
            const transferTeamFilter = document.getElementById('transfer-team-filter');
            const transferSearchInput = document.getElementById('transfer-search-player');
            const transferPrevButton = document.getElementById('transfer-prev-page');
            const transferNextButton = document.getElementById('transfer-next-page');
            const transferPageNumbers = document.getElementById('transfer-page-numbers');
            
            async function loadTeamData() {
                try {
                    const response = await fetch('/api/fantasy/mi-equipo');
                    if (response.status === 401 || response.status === 403) {
                        alert("Sesi√≥n expirada."); 
                        window.location.href = '/login.html'; 
                        return;
                    }
                    if (!response.ok) throw new Error('Error al cargar datos del equipo.');

                    const data = await response.json(); 
                    miPlantilla = data.plantillaConDetalles; 

                    document.getElementById('username-display').textContent = data.userInfo.username;
                    document.getElementById('user-level').textContent = data.userInfo.nivel;
                    document.getElementById('user-xp').textContent = data.userInfo.xp_total;

                    document.getElementById('budget-remaining').textContent = `${data.equipoInfo.presupuesto_restante} M`;
                    document.getElementById('transfers-remaining').textContent = data.equipoInfo.fichajes_jornada_restantes;
                    fichajesBase = parseInt(data.equipoInfo.fichajes_jornada_restantes);
                    actualizarContadorFichajes();
                    renderPitchAndBench(miPlantilla);
                    renderChips(data.fichas);


                } catch (error) {
                    console.error("Error en loadTeamData:", error);
                }
            }

            async function initializeTransferModal(positionToBuy, maxBudget) {
                try {
                    if (allAvailablePlayers.length === 0) {
                        console.log("Cargando lista de jugadores por primera vez...");
                        const response = await fetch('/api/fantasy/available-players'); 
                        if (!response.ok) throw new Error('Error al cargar jugadores');
                        allAvailablePlayers = await response.json();
                        console.log("Jugadores cargados:", allAvailablePlayers); 
                        populateTransferTeamFilter(); 
                    }

                    console.log(`Filtrando por: pos=${positionToBuy}, maxBudget=${maxBudget}`);
                    
                    transferFilteredPlayers = allAvailablePlayers.filter(p =>
                        p.posicion === positionToBuy && 
                        p.valor_actual <= maxBudget && 
                        !miPlantilla.find(mp => mp.id_jugador === p.id_jugador) 
                    );
                    
                    console.log("Jugadores filtrados:", transferFilteredPlayers); 

                    transferPosFilter.innerHTML = `<option value="${positionToBuy}">${positionToBuy}</option>`;
                    transferPosFilter.disabled = true;
                    transferTeamFilter.value = "ALL";
                    transferSearchInput.value = "";
                    
                    displayTransferPage(1); 

                } catch (error) {
                    console.error("Error en initializeTransferModal:", error);
                    alert("Error al cargar la lista de jugadores. Int√©ntalo de nuevo.");
                    return;
                }
            }

            function displayTransferPage(page) {
                transferCurrentPage = page;
                transferTBody.innerHTML = "";
                const startIndex = (page - 1) * transferPlayersPerPage;
                const endIndex = startIndex + transferPlayersPerPage;
                const playersToShow = transferFilteredPlayers.slice(startIndex, endIndex);

                playersToShow.forEach(jugador => {
                    const fila = document.createElement("tr");
                    fila.innerHTML = `
                        <td><img src="${jugador.url_imagen_jugador || 'placeholder-player-face.png'}" alt="Jugador"> ${jugador.nombre_jugador}</td>
                        <td><img src="${jugador.img_equipo || 'placeholder-player-face.png'}" alt="Equipo"></td>
                        <td>$${jugador.valor_actual}M</td>
                        <td>${jugador.total_puntos_fantasy}</td>
                        <td>
                            <button class="add-player-btn" title="Fichar jugador" onclick="executeTransfer(${jugador.id_jugador})">
                                <ion-icon name="add-circle-outline"></ion-icon>
                            </button>
                        </td>
                    `;
                    transferTBody.appendChild(fila);
                });
                updateTransferPaginationButtons();
                updateTransferPageNumbers();
            }

            function updateTransferPaginationButtons() {
                const totalPages = Math.ceil(transferFilteredPlayers.length / transferPlayersPerPage);
                transferPrevButton.disabled = transferCurrentPage === 1;
                transferNextButton.disabled = transferCurrentPage === totalPages;
            }
            function updateTransferPageNumbers() {
                const totalPages = Math.ceil(transferFilteredPlayers.length / transferPlayersPerPage);
                transferPageNumbers.textContent = `P√°g ${transferCurrentPage} de ${totalPages}`;
            }
            transferPrevButton.addEventListener('click', () => {
                if (transferCurrentPage > 1) displayTransferPage(transferCurrentPage - 1);
            });
            transferNextButton.addEventListener('click', () => {
                const totalPages = Math.ceil(transferFilteredPlayers.length / transferPlayersPerPage);
                if (transferCurrentPage < totalPages) displayTransferPage(transferCurrentPage + 1);
            });

            function populateTransferTeamFilter() {
                const teams = new Map();
                allAvailablePlayers.forEach(player => {
                    if (player.id_equipo && player.nombre_equipo) {
                        teams.set(player.id_equipo, player.nombre_equipo);
                    }
                });
                const sortedTeams = Array.from(teams.entries()).sort((a, b) => a[1].localeCompare(b[1]));
                sortedTeams.forEach(([id, name]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    transferTeamFilter.appendChild(option);
                });
            }

            async function executeTransfer(playerToBuyId) {
                if (!playerToSell) return;
                
                const playerToBuy = allAvailablePlayers.find(p => p.id_jugador === playerToBuyId);
                
                // --- Validaci√≥n de equipo (m√°x 2 por club) ---
                let countSameTeam = 0;
                miPlantilla.forEach(p => {
                    if (p.id_equipo === playerToBuy.id_equipo && p.id_jugador !== playerToSell.id_jugador) {
                        countSameTeam++;
                    }
                });
                if (countSameTeam >= 2 && !freeHitActive) { // Free Hit ignora l√≠mite de equipo
                    alert(`No puedes fichar a ${playerToBuy.nombre_jugador}, ya tienes 2 jugadores de ${playerToBuy.nombre_equipo}.`);
                    return;
                }

                // --- Validaci√≥n de Fichajes Restantes (con Comod√≠n/Free Hit) ---
                const fichajesRestantes = parseInt(document.getElementById('transfers-remaining').textContent);
                
                // Si NO tienes fichajes Y NO tienes fichas activas, pregunta por la penalizaci√≥n
                if (fichajesRestantes <= 0 && !wildcardActive && !freeHitActive) {
                     if (!confirm(`Ya no te quedan fichajes. ¬øDeseas hacer este fichaje con un costo de -5 puntos?`)) {
                        return;
                    }
                }

                // --- üëá C√ÅLCULO DEL PRESUPUESTO (AHORA EST√Å AQU√ç) üëá ---
                const budgetElement = document.getElementById('budget-remaining');
                const currentBudget = parseFloat(budgetElement.textContent.replace(' M', ''));
                
                // Calculamos: Presupuesto Actual + Venta - Compra
                const nuevoPresupuesto = currentBudget + parseFloat(playerToSell.precio_compra) - parseFloat(playerToBuy.valor_actual);
                // --- üëÜ ---------------------------------------- üëÜ ---

                // --- Validaci√≥n de Presupuesto (con Free Hit) ---
                if (nuevoPresupuesto < 0 && !freeHitActive) { 
                    alert(`Presupuesto insuficiente. Te faltan ${Math.abs(nuevoPresupuesto).toFixed(2)}M`); 
                    return;
                }

                // Confirmaci√≥n Final
                if (!confirm(`¬øConfirmar fichaje?\n\nVENDER: ${playerToSell.nombre_jugador}\nCOMPRAR: ${playerToBuy.nombre_jugador}`)) {
                    return;
                }

                // --- Llamada al Backend ---
                try {
                    const response = await fetch('/api/fantasy/hacer-fichaje', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jugadorSaleId: playerToSell.id_jugador,
                            jugadorEntraId: playerToBuyId,
                            id_ficha_activa: activeChipId 
                        })
                    });

                    if (!response.ok) {
                        const result = await response.json();
                        throw new Error(result.error || 'Error en el servidor');
                    }
                    
                    const result = await response.json();
                    alert(result.message);
                    
                    if (!wildcardActive && !freeHitActive) {
                        fichajesRealizadosEnSesion++; 
                        actualizarContadorFichajes();
                    }
                    
                    // Recargar para ver los cambios reflejados
                    window.location.reload(); 

                } catch (error) {
                    alert("Error al realizar el fichaje: " + error.message);
                }
            }

            //RQF1
            function renderPitchAndBench(plantilla) {
                document.getElementById('pitch-row-F').innerHTML = '';
                document.getElementById('pitch-row-M').innerHTML = '';
                document.getElementById('pitch-row-D').innerHTML = '';
                document.getElementById('pitch-row-G').innerHTML = '';
                document.getElementById('bench').innerHTML = '';

                const titulares = plantilla.filter(p => p.es_titular);
                const suplentes = plantilla.filter(p => !p.es_titular);

                titulares.forEach(player => {
                    const slotHTML = createPlayerSlotHTML(player);
                    document.getElementById(`pitch-row-${player.posicion}`).innerHTML += slotHTML;
                });

                suplentes.forEach(player => {
                    const slotHTML = createPlayerSlotHTML(player);
                    document.getElementById('bench').innerHTML += slotHTML;
                });
                
                addSlotClickListeners(); 
                addDragListeners();      
            }

            function createPlayerSlotHTML(player) {
                const now = new Date();
                const dayOfWeek = now.getDay(); 
                const allowedDays = [2, 3, 4, 5];
                let currentGameweekPoints = player.puntos_ultima_jornada_equipo || 0;
                if (allowedDays.includes(dayOfWeek)) {
                    currentGameweekPoints = 0;
                }
                
                let captainBadge = '';
                if (player.es_capitan) {
                    captainBadge = '<span class="captain-badge">C</span>';
                }
                
                return `
                    <div class="player-slot" data-player-id="${player.id_jugador}" data-position="${player.posicion}" draggable="true"> 
                        ${captainBadge}
                        <img src="${player.url_imagen_jugador || 'placeholder-player-face.png'}" alt="${player.nombre_jugador}">
                        <span class="player-name">${player.nombre_jugador}</span>
                        <span class="player-points">${currentGameweekPoints} Pts</span>
                    </div>
                `;
            }

            //RQF7
            function renderChips(fichas) {
                const chipsList = document.getElementById('chips-list');
                chipsList.innerHTML = ''; 
                const userLevel = parseInt(document.getElementById('user-level').textContent) || 1;
                fichas.forEach(ficha => {
                    const button = document.createElement('button');
                    button.dataset.id = ficha.id_ficha; 
                    button.textContent = ficha.nombre;
                    button.style.backgroundColor = "#3b82f6";
                    button.style.color = "white";
                    button.style.border = "none";
                    button.style.padding = "8px 12px";
                    button.style.borderRadius = "6px";
                    button.style.cursor = "pointer";
                    button.style.marginRight = "10px";
                    button.style.fontSize = "0.9rem";
                    
                    // 1. Verificar si est√° usada (prioridad m√°xima)
                    if (ficha.usada) {
                        button.disabled = true;
                        button.textContent += " (Usada)";
                        button.style.backgroundColor = "#475569";
                        if (ficha.id_ficha == 6) { 
                            wildcardActive = true;
                            activeChipId = 6; // Importante: Mantener el ID para enviarlo al backend
                            document.getElementById('transfers-remaining').textContent = "‚àû";
                        }
                        if (ficha.id_ficha == 7) {
                            freeHitActive = true;
                            activeChipId = 7;
                            document.getElementById('transfers-remaining').textContent = "‚àû";
                        }
                    } 
                    // 2. Verificar si tiene el nivel (solo para las nuevas)
                    else if (CHIP_UNLOCK_LEVELS[ficha.id_ficha] && userLevel < CHIP_UNLOCK_LEVELS[ficha.id_ficha]) {
                        button.disabled = true;
                        button.textContent += ` (Nvl ${CHIP_UNLOCK_LEVELS[ficha.id_ficha]})`;
                        button.style.backgroundColor = "#334155"; // Un gris diferente para bloqueado
                        button.style.opacity = "0.6";
                        button.title = "Sube de nivel para desbloquear";
                    }
                    // 3. Disponible
                    else {
                        button.onclick = () => toggleChip(ficha.id_ficha, button);
                    }
                    
                    chipsList.appendChild(button);
                });
            }

            

            //RQF4
            function openPlayerModal(playerId) {
                currentPlayerIdInModal = playerId;
                const player = miPlantilla.find(p => p.id_jugador === playerId);
                if (!player) return;
                
                fetch(`/api/fantasy/player-details/${playerId}`).then(res => res.json()).then(data => { 
                    playerData = data[0];
                    clubId = playerData.id_equipo_actual;
                    console.log(clubId);
                    puntosTotales = 0;
                    desglose = document.getElementById('modal-points-breakdown');
                    desglose.innerHTML = "";
                    for (let i = 0; i < data.length; i++){
                        puntosTotales += data[i].puntos_fantasy;
                        desglose.innerHTML += `<li>J${data[i].jornada}: ${data[i].puntos_fantasy} Pts vs <img src="${data[i].img_rival}" class="rival-logo"></li>`;
                    }
                    document.getElementById('modal-player-name').textContent = playerData.nombre_jugador;
                    document.getElementById('modal-player-img').src = playerData.url_imagen_jugador;
                    document.getElementById('modal-player-club').src = playerData.img_equipo_actual;
                    if (playerData.posicion == 'F'){
                        document.getElementById('modal-player-pos').textContent = "DEL";
                    } else if (playerData.posicion == 'M') {
                        document.getElementById('modal-player-pos').textContent = "MED";
                    } else if (playerData.posicion == 'D') {
                        document.getElementById('modal-player-pos').textContent = "DEF";
                    } else {
                        document.getElementById('modal-player-pos').textContent = "POR";
                    }
                    document.getElementById('modal-player-value').textContent = playerData.valor_actual;
                    document.getElementById('modal-player-popularity').textContent = playerData.popularidad;
                    document.getElementById('modal-player-total-points').textContent = puntosTotales;
                    
                    fetch(`/api/fantasy/proximo-partido/${clubId}`).then(res => res.json()).then(data => {
                        document.getElementById('modal-next-fixture').innerHTML = `
                        <img class="rival-logo" src="${data.img_local}" alt="Loca"> vs
                        <img class="rival-logo" src="${data.img_visitante}" alt="Visitante">`;
                    })
                    
                    playerModal.style.display = 'flex';

                }).catch(err => console.error("Error al cargar detalles del jugador:", err));
                
                

                const makeCaptainBtn = document.getElementById('modal-make-captain-btn');
                const substituteBtn = document.getElementById('modal-substitute-btn');

                if (player.es_titular && !player.es_capitan) {
                    makeCaptainBtn.disabled = false;
                    makeCaptainBtn.textContent = "Hacer Capit√°n";
                } else if (player.es_capitan) {
                    makeCaptainBtn.disabled = true;
                    makeCaptainBtn.textContent = "Ya es Capit√°n";
                } else {
                    makeCaptainBtn.disabled = true;
                    makeCaptainBtn.textContent = "Debe ser titular";
                }

                substituteBtn.textContent = player.es_titular ? "Mover a la Banca" : "Mover a Titulares";

                playerModal.style.display = 'flex';



            }

            function closePlayerModal() {
                playerModal.style.display = 'none';
            }

            function addSlotClickListeners() {
                document.querySelectorAll('.player-slot').forEach(slot => {
                    slot.removeEventListener('click', handleSlotClick); 
                    slot.addEventListener('click', handleSlotClick);
                });
            }
            
            function handleSlotClick(event) {
                const slot = event.currentTarget;
                if (slot.dataset.playerId) {
                    openPlayerModal(parseInt(slot.dataset.playerId));
                }
            }

            function addDragListeners() {
                const slots = document.querySelectorAll('.player-slot');
                
                slots.forEach(slot => {
                    slot.addEventListener('dragstart', (e) => {
                        draggedPlayerId = parseInt(e.currentTarget.dataset.playerId);
                        e.dataTransfer.effectAllowed = 'move';
                        e.currentTarget.style.opacity = '0.5'; 
                    });

                    slot.addEventListener('dragover', (e) => {
                        e.preventDefault(); 
                        e.dataTransfer.dropEffect = 'move';
                        e.currentTarget.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                    });

                    slot.addEventListener('dragleave', (e) => {
                        e.currentTarget.style.backgroundColor = 'transparent';
                    });

                    slot.addEventListener('drop', (e) => {
                        e.preventDefault();
                        e.currentTarget.style.backgroundColor = 'transparent';
                        const targetSlot = e.currentTarget;
                        const targetPlayerId = parseInt(targetSlot.dataset.playerId);

                        if (draggedPlayerId && draggedPlayerId !== targetPlayerId) {
                            handleSwap(draggedPlayerId, targetPlayerId);
                        }
                    });
                    
                    slot.addEventListener('dragend', (e) => {
                        e.currentTarget.style.opacity = '1';
                        draggedPlayerId = null; 
                    });
                });
            }

            function isFormationValid(plantilla) {
                const titulares = plantilla.filter(p => p.es_titular === 1);
                if (titulares.length !== 11) return false; 
                if (tacticalChangeActive) return true;

                const positions = { G: 0, D: 0, M: 0, F: 0 };
                titulares.forEach(p => {
                    if (positions.hasOwnProperty(p.posicion)) {
                        positions[p.posicion]++;
                    }
                });
                return positions['G'] == 1 && positions['D'] >= 3 && positions['M'] >= 2 && positions['F'] >= 1;
            }

            //RQF2
            function  handleSwap(player1_id, player2_id) {
                const fechaHoy = new Date();
                const diasNoPermitidos = [0,1,6];
                const diaHoy = fechaHoy.getDay();
                const player1 = miPlantilla.find(p => p.id_jugador === player1_id);
                const player2 = miPlantilla.find(p => p.id_jugador === player2_id);

                if (!player1 || !player2) {
                    console.error("No se encontr√≥ uno de los jugadores en la plantilla");
                    return;
                }

                


                const tempPlantilla = JSON.parse(JSON.stringify(miPlantilla)); 
                const tempP1 = tempPlantilla.find(p => p.id_jugador === player1_id);
                const tempP2 = tempPlantilla.find(p => p.id_jugador === player2_id);

                [tempP1.es_titular, tempP2.es_titular] = [tempP2.es_titular, tempP1.es_titular];

                if (isFormationValid(tempPlantilla)) {
                    [player1.es_titular, player2.es_titular] = [player2.es_titular, player1.es_titular];
                    console.log(diaHoy);
                    if (diasNoPermitidos.includes(diaHoy)){
                        alert("Solo se pueden hacer cambios los dias martes, miercoles y jueves.")
                        
                    } else{
                        if(player1.puntos_ultima_jornada_equipo > 0 || player2.puntos_ultima_jornada_equipo > 0 ){
                            alert("Cambio invalido, solo pueden entrar jugadores que no han jugado");
                            return;
                        }
                    }

                    
                    
                    if (player1.es_capitan && player1.es_titular === 0) player1.es_capitan = 0;
                    if (player2.es_capitan && player2.es_titular === 0) player2.es_capitan = 0;

                    renderPitchAndBench(miPlantilla);
                    showSaveChangesButton();
                } else {
                    alert("¬°Formaci√≥n inv√°lida! (M√≠n: 1-POR, 3-DEF, 2-CEN, 1-DEL)");
                }
            }

            function showSaveChangesButton() {
                saveChangesButton.style.display = 'block';
            }

            function closeTransferModal() {
                transferModal.style.display = 'none';
            }


            document.getElementById('modal-substitute-btn').addEventListener('click', handleSubstitute);
            document.getElementById('modal-make-captain-btn').addEventListener('click', handleMakeCaptain);
            document.getElementById('modal-transfer-out-btn').addEventListener('click', handleTransfer);
            document.getElementById('save-team-changes-btn').addEventListener('click', saveChangesToBackend);

            function showSaveChangesButton() {
                saveChangesButton.style.display = 'block';
            }

            function handleSubstitute() {
                const now = new Date();
                const dayOfWeek = now.getDay(); 
                const allowedDays = [2, 3, 4]; 

                if (!allowedDays.includes(dayOfWeek)) {
                    alert("¬°Mercado cerrado!\n\nLas sustituciones solo se pueden hacer los martes, mi√©rcoles y jueves antes de la fecha l√≠mite.");
                    closePlayerModal();
                    return; 
                }

                if (dayOfWeek === 4 && (now.getHours() >= 23 && now.getMinutes() >= 59)) {
                    alert("¬°Mercado cerrado!\n\nLa fecha l√≠mite (jueves 11:59 PM) ya ha pasado.");
                    closePlayerModal();
                    return;
                }
                

                const player1_id = currentPlayerIdInModal;
                const player1 = miPlantilla.find(p => p.id_jugador === currentPlayerIdInModal);

                const player2 = miPlantilla.find(p => 
                    p.posicion === player1.posicion && 
                    p.es_titular !== player1.es_titular
                );

                if (!player2) {
                    alert(`No hay espacio en la ${player1.es_titular ? 'banca' : 'cancha'} para un ${player1.posicion}.`);
                    return;
                }
                
                handleSwap(player1.id_jugador, player2.id_jugador);
                closePlayerModal();
            }
            
            
            //RQF5
            function handleMakeCaptain() {
                const lastCaptainChange = localStorage.getItem('lastCaptainChange');
                const now = new Date().getTime(); 
                

                const newCaptainId = currentPlayerIdInModal;
                const newCaptain = miPlantilla.find(p => p.id_jugador === newCaptainId);
                //RQNF3
                if (newCaptain.puntos_ultima_jornada_equipo > 0) {
                    alert('No puedes hacer capit√°n a un jugador que ya ha jugado esta jornada.');
                    closePlayerModal();
                    return;
                }
                const currentCaptains = miPlantilla.filter(p => p.es_capitan === 1);
                if (doubleCaptainActive) {
                    if (currentCaptains.length < 2) {
                        newCaptain.es_capitan = 1; 
                    } else {
                        
                        alert("Ya tienes 2 capitanes. Quita uno primero."); 
                        return; 
                    }
                } else {
                    if (currentCaptains.length > 0) {
                        currentCaptains[0].es_capitan = 0; 
                    }
                    newCaptain.es_capitan = 1;

                    const lastCaptainChange = localStorage.getItem('lastCaptainChange');
                    if (lastCaptainChange) {
                         const lastChangeTime = parseInt(lastCaptainChange);
                        const hoursPassed = (now - lastChangeTime) / (1000 * 60 * 60); 
                         if (hoursPassed < 24) {
                             alert("Ya tienes un capitan activo"); 
                             return;
                         }
                    }
                }

                if (!retroCaptainActive && newCaptain.puntos_ultima_jornada_equipo > 0) {
                    alert('No puedes hacer capit√°n a un jugador que ya ha jugado (necesitas la ficha Retro).');
                    return;
                }
                


                console.log(`Nuevo capit√°n: ${newCaptain.nombre_jugador}`);

                renderPitchAndBench(miPlantilla);
                closePlayerModal();
                showSaveChangesButton(); 
               
                localStorage.setItem('lastCaptainChange', now.toString());
            }
            
            // RQF3
            function handleTransfer() {
                const now = new Date();
                const dayOfWeek = now.getDay(); 
                const allowedDays = [2, 3, 4, 5]; 
                if (!allowedDays.includes(dayOfWeek)) {
                    alert("¬°Mercado de fichajes cerrado!\n\nSolo puedes realizar fichajes los martes, mi√©rcoles y jueves.");
                    closePlayerModal();
                    return; 
                }
                //RQNF2
                if (dayOfWeek === 4 && (now.getHours() >= 23 && now.getMinutes() >= 59)) {
                    alert("¬°Mercado de fichajes cerrado!\n\nLa fecha l√≠mite (jueves 11:59 PM) ya ha pasado.");
                    closePlayerModal();
                    return;
                }
                const playerId = currentPlayerIdInModal;
                playerToSell = miPlantilla.find(p => p.id_jugador === playerId); 

                if (!playerToSell) return;

                const fichajesRestantesElement = document.getElementById('transfers-remaining');
                const fichajesRestantes = parseInt(fichajesRestantesElement.textContent);
                //RQNF4
                if (fichajesRestantes <= 0 && !wildcardActive && !freeHitActive) {
                    if (!confirm(`Ya no te quedan fichajes. ¬øDeseas hacer este fichaje con un costo de -5 puntos?`)) {
                        return;
                    }
                }

                const budgetElement = document.getElementById('budget-remaining');
                const currentBudget = parseFloat(budgetElement.textContent.replace(' M', ''));
                const presupuestoDisponible = currentBudget + parseFloat(playerToSell.precio_compra); 
                console.log(playerToSell);
                document.getElementById('transfer-sell-player-name').textContent = playerToSell.nombre_jugador;
                document.getElementById('transfer-current-budget').textContent = `$${presupuestoDisponible.toFixed(1)}M`;
                
                closePlayerModal(); 
                transferModal.style.display = 'flex';
                
                initializeTransferModal(playerToSell.posicion, presupuestoDisponible);
            }
            
            function applyTransferFilters() {
                const positionToBuy = transferPosFilter.value;
                const selectedTeamId = transferTeamFilter.value;
                const searchTerm = transferSearchInput.value.toLowerCase().trim();
                
                const budgetElement = document.getElementById('budget-remaining');
                const currentBudget = parseFloat(budgetElement.textContent.replace(' M', ''));
                const maxBudget = currentBudget + parseFloat(playerToSell.precio_compra);

                transferFilteredPlayers = allAvailablePlayers.filter(p =>
                    p.posicion === positionToBuy && 
                    p.valor_actual <= maxBudget && 
                    !miPlantilla.find(mp => mp.id_jugador === p.id_jugador) &&
                    (selectedTeamId === "ALL" || p.id_equipo == selectedTeamId) &&
                    (searchTerm === "" || p.nombre_jugador.toLowerCase().includes(searchTerm))
                );

                displayTransferPage(1); 
            }

            transferTeamFilter.addEventListener('change', applyTransferFilters);
            transferSearchInput.addEventListener('input', applyTransferFilters);

            function activarFichajeExtra() {
                extraTransferActive = true;
                fichajesExtra = 1; 
                actualizarContadorFichajes();
                alert("¬°Fichaje Extra activado! Ahora tienes un traspaso adicional gratis.");
            }

            function desactivarFichajeExtra() {
                extraTransferActive = false;
                fichajesExtra = 0; 
                actualizarContadorFichajes(); 
            }

            function actualizarContadorFichajes() {
                
                const total = fichajesBase + fichajesExtra - fichajesRealizadosEnSesion; 
                document.getElementById('transfers-remaining').textContent = total;
            }

            function activarDobleCapitan() {
                doubleCaptainActive = true;
                alert("¬°Doble Capit√°n activado! Ahora puedes seleccionar un segundo capit√°n.");
            }

            function desactivarDobleCapitan() {
                doubleCaptainActive = false;
                const capitanes = miPlantilla.filter(p => p.es_capitan);
                if (capitanes.length > 1) {
                    
                    capitanes[1].es_capitan = 0; 
                    renderPitchAndBench(miPlantilla); 
                    alert("Se ha desactivado el segundo capit√°n.");
                }
            }
            function toggleChip(id, btn) {
                if (activeChipId === id) {
                    activeChipId = null;
                    resetChipEffects();
                    activeChipId = null;
                    btn.style.backgroundColor = "#4f46e5";
                    btn.textContent = btn.textContent.replace(" (Activa)", "");
                    
                    if (id === 1) desactivarFichajeExtra(); 
                    if (id === 2) desactivarDobleCapitan(); 
                    
                } else {
                    if (activeChipId !== null) {
                        const prevBtn = document.querySelector(`#chips-list button[data-id="${activeChipId}"]`);
                        if(prevBtn) toggleChip(activeChipId, prevBtn); 
                    }

                    activeChipId = id;
                    resetChipEffects();
                    switch(id) {
                        case 1: activarFichajeExtra(); break;
                        case 2: activarDobleCapitan(); break;
                        case 3: retroCaptainActive = true; alert("¬°Capit√°n Retro activo! Puedes elegir a quien ya jug√≥."); break;
                        case 4: tripleCaptainActive = true; alert("¬°Capit√°n x3 activo! Tus puntos valdr√°n triple."); break;
                        case 5: tacticalChangeActive = true; alert("¬°Cambio T√°ctico activo! Formaciones libres."); break;
                        case 6: 
                            wildcardActive = true; 
                            document.getElementById('transfers-remaining').textContent = "‚àû"; // Visualmente infinito
                            alert("¬°Comod√≠n activo! Fichajes ilimitados."); 
                            break;
                        case 7: freeHitActive = true; alert("¬°Sin L√≠mites activo! Presupuesto y fichajes ilimitados (solo por hoy)."); break;
                    }
                    btn.style.backgroundColor = "#059669"; 
                    btn.textContent += " (Activa)";

                }
                
                showSaveChangesButton();
            }

            function resetChipEffects() {
                extraTransferActive = false;
                doubleCaptainActive = false;
                retroCaptainActive = false;
                tripleCaptainActive = false;
                tacticalChangeActive = false;
                wildcardActive = false;
                freeHitActive = false;
                // Tambi√©n deber√≠as resetear el texto de fichajes si desactivas el extra/comod√≠n
            }

            async function saveChangesToBackend() {
                console.log("Guardando cambios en el servidor...");
                const plantillaActualizada = miPlantilla.map(p => ({
                    id_jugador: p.id_jugador,
                    es_titular: p.es_titular,
                    es_capitan: p.es_capitan
                }));
                try {
                    const response = await fetch('/api/fantasy/actualizar-plantilla', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            plantilla: plantillaActualizada,
                            id_ficha_activa: activeChipId 
                        })
                    });
                    if (!response.ok) throw new Error('Respuesta del servidor no fue OK');
                    const result = await response.json();
                    alert('¬°Cambios guardados con √©xito!');
                    activeChipId = null;
                    saveChangesButton.style.display = 'none';
                } catch (error) {
                    console.error("Error al guardar cambios:", error);
                    alert("Error al guardar cambios. Int√©ntalo de nuevo.");
                }
            }
            loadTeamData();

        </script>


    </body>
</html>