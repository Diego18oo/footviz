<!DOCTYPE html>
<html>
    <head>
        <title>Estadisticas Liga</title>
        <style>
            table {
                width: 80%;
                margin: 0 auto;
                border-collapse: collapse;
            }
            th, td {
                padding: 10px;
                border: 1px solid #aaa;
                text-align: center;
            }
            th {
                background-color: #f2f2f2;
            }
            img {
                width: 32px;
                height: auto;
                vertical-align: middle;
                margin-right: 10px;
            }
        </style>
    </head>
    <body>
        <form action="#">
            <label for="liga">Selecciona una Liga</label>
            <select id="liga">
                <option value="premierleague" selected>Premier League</option>
                <option value="laliga">La Liga</option>
                <option value="seriea">Serie A</option>
                <option value="bundesliga">Bundesliga</option>
                <option value="ligueone">Ligue 1</option>
            </select>
        </form> 
        <h1>Tabla</h1>
        <table id="tabla-equipos">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Equipo</th>
                    <th>PJ</th>
                    <th>V</th>
                    <th>E</th>
                    <th>D</th>
                    <th>Pts</th>
                    <th>DG</th>
                    <th>GA</th>
                    <th>GC</th>

                </tr>
            </thead>
            <tbody>
                
            </tbody>
        </table>

        <h3>Evolucion de los equipos</h3>
        <form action="#">
            <label for="equipo1">Selecciona un equipo</label>
            <select id="equipo1">
                
            </select>
        </form> 
        <form action="#">
            <label for="equipo2">Selecciona otro equipo</label>
            <select id="equipo2">
                
            </select>
        </form>
        <div style="width: 800px; height: 800px;">
            <canvas id="lineChart"></canvas>
        </div>
        
        <div style="width: 800px; height: 800px;">
            <form action="#">
                <label for="stat">Selecciona una Estadistica</label>
                <select id="stat">
                    <option value="goles" selected>Goles</option>
                    <option value="disparos">Disparos</option>
                    <option value="disparos_a_puerta">Disparos a puerta</option>
                    <option value="faltas">Faltas</option>
                    <option value="tiros_de_esquina">Tiros de esquina</option>
                </select>
            </form>
            <p>Todas las estadisticas son promedios por partido</p>
            <canvas id="barChart"></canvas>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script>
            let totalEquiposLiga = 20;
            var liga = document.getElementById('liga');
            var tbody = document.querySelector("#tabla-equipos tbody");
            
            var endpoints = {
                "premierleague": "/premier-league",
                "laliga": "/la-liga",
                "seriea": "/serie-a",
                "bundesliga": "/bundesliga",
                "ligueone": "/ligue-one"
            };

            function cargarGraficaEvo(equipoSeleccionado, nombreEquipo, color, slot){
                console.log(equipoSeleccionado)
                fetch(`/evolucion-equipos/${equipoSeleccionado}`)
                .then(response => response.json())
                .then(info => {
                    const evolucion = info[0];
                    const jornadas = [];
                    const posiciones = [];
                    for (let i = 1; i <= 38; i++) {
                        const pos = evolucion[`jornada${i}`];
                        if (pos !== 0 ) {   
                            jornadas.push(`J${i}`);
                            posiciones.push(pos);
                        }
                        else {
                            break;
                        }
                    }
                    const ctx = document.getElementById('lineChart').getContext('2d');

                    if (!window.lineChartInstance) {
                        window.lineChartInstance = new Chart(ctx, 
                        {
                            type: 'line',
                            data: {
                                labels: jornadas,
                                datasets: []
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: `Comparacion de equipos`
                                    }
                                },
                                scales: {
                                    y: {
                                        reverse: true, 
                                        min: 0,
                                        max: totalEquiposLiga,   // límite superior (20 equipos)
                                        ticks: {
                                            stepSize: 1 // opcional, para que se vean todos los enteros
                                        },
                                        title: {
                                            display: true,
                                            text: 'Posición'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Jornadas'
                                        }
                                    }
                                }
                                
                            }
                        });

                    }
                    

                    window.lineChartInstance.data.datasets[slot] = {
                        label: nombreEquipo,
                        data: posiciones,
                        borderColor: color,
                        backgroundColor: color,
                        tension: 0.3
                    }; 
                    window.lineChartInstance.update();

                    
                })
            }

            let barChartInstance = null;
            function cargarGraficaPromedios(ligaSeleccionada){
                let endpoints2 = {
                    "premierleague" : "1",
                    "laliga" : "2",
                    "seriea" : "3",
                    "bundesliga" : "4",
                    "ligueone" : "5",
                }

                let nombres = {
                    "premierleague" : "Premier League",
                    "laliga" : "La Liga",
                    "seriea" : "Serie A",
                    "bundesliga" : "Bundesliga",
                    "ligueone" : "Ligue 1",
                }

                fetch(`/promedios-liga/${endpoints2[ligaSeleccionada]}`)
                .then(response => response.json())
                .then(info => {
                    const loadImage = (src) => new Promise(resolve => {
                        const img = new Image();
                        img.src = src;
                        img.onload = () => resolve(img);
                    });

                    Promise.all(info.map(e => loadImage(e.url_imagen)))
                    .then(images => {
                        const teamLogos = {};
                        info.forEach((e, i) => {
                            teamLogos[e.nombre] = images[i];
                        });

                        function renderBarChart(statKey, label) {
                            const labels = info.map(e => e.nombre);
                            const valores = info.map(e => {
                                switch(statKey){
                                    case "goles": return e.goles_por_partido;
                                    case "disparos": return e.disparos_por_partido;
                                    case "disparos_a_puerta": return e.disparos_a_puerta_por_partido;
                                    case "faltas": return e.faltas_por_partido;
                                    case "tiros_de_esquina": return e.tiros_de_esquina_por_partido;
                                    default: return 0;
                                }
                            });

                            const ctx = document.getElementById('barChart').getContext('2d');

                            if (barChartInstance) {
                                barChartInstance.destroy();
                            }

                            barChartInstance = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: label,
                                        data: valores,
                                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    layout: {
                                        padding: {
                                            bottom: 90
                                        }
                                    },
                                    plugins: {
                                        legend: { display: true },
                                        title: {
                                            display: true,
                                            text: `Promedio de ${label} por partido (${nombres[ligaSeleccionada]})`
                                        },
                                        tooltip: {
                                            callbacks: {
                                                title: (tooltipItems) => labels[tooltipItems[0].dataIndex]
                                            }
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: `Promedio por partido`
                                            }
                                        },
                                        x: {
                                            ticks: { 
                                                display: false, 
                                                autoSkip: false, 
                                                maxRotation: 0, 
                                                minRotation:0 
                                            }
                                        }
                                    }
                                },
                                plugins: [{
                                    id: "logos",
                                    afterDatasetsDraw: chart => {
                                        const xAxis = chart.scales.x;
                                        const yAxis = chart.scales.y;
                                        chart.data.labels.forEach((label, index) => {
                                            const logo = teamLogos[label];
                                            if (logo) {
                                                const x = xAxis.getPixelForTick(index);
                                                const y = yAxis.bottom + 10;
                                                const size = 30;
                                                chart.ctx.drawImage(logo, x - size/2, y, size, size);
                                            }
                                        });
                                    }
                                }]
                            });
                        }

                        // inicial con goles
                        renderBarChart("goles", "Goles");

                        document.getElementById("stat").onchange = function(){
                            renderBarChart(this.value, this.options[this.selectedIndex].text);
                        };
                    });
                });
            }
            
            function cargarTabla(ligaSeleccionada){
                tbody.innerHTML = "";

                if(endpoints[ligaSeleccionada]){
                    var url = endpoints[ligaSeleccionada];
                    fetch(url)
                    
                        .then(response => response.json())
                        .then(data => { 
                            tbody.innerHTML = "";
                            const equipos = data.tabla_liga;
                            totalEquiposLiga = equipos.length;
                            equipos.sort((a,b) => {
                                if (b.puntos !== a.puntos) return b.puntos - a.puntos;
                                if (b.diferencia_de_goles !== a.diferencia_de_goles) return b.diferencia_de_goles - a.diferencia_de_goles;
                                return b.goles_anotados - a.goles_anotados;
                            });
                            equipos.forEach((equipo, index) => {
                                const fila = document.createElement("tr");
                             
                                fila.innerHTML = `
                                    <td>${index +1}</td> 
                                    <td><img src="${equipo.url_imagen}" alt="Escudo">${equipo.nombre_equipo}</td>
                                    <td>${equipo.partidos_jugados}</td>
                                    <td>${equipo.victorias}</td>
                                    <td>${equipo.empates}</td>
                                    <td>${equipo.derrotas}</td>
                                    <td>${equipo.puntos}</td>
                                    <td>${equipo.diferencia_de_goles}</td>
                                    <td>${equipo.goles_anotados}</td>
                                    <td>${equipo.goles_recibidos}</td>
                                `;
                                tbody.appendChild(fila);
                            });
                        })
                }
            }
            
            function cargarOpciones(ligaSeleccionada){
                let select1 = document.getElementById("equipo1");
                let select2 = document.getElementById("equipo2");
                
                if(endpoints[ligaSeleccionada]){
                    var url = endpoints[ligaSeleccionada];
                    fetch(url)
                    .then(response => response.json())
                    .then(data => { 
                        select1.innerHTML = "";
                        select2.innerHTML = "";
                        const equipos = data.tabla_liga;
                        equipos.forEach((equipo => {
                            const opcion1 = document.createElement("option");
                            opcion1.value = equipo.id_equipo;
                            opcion1.textContent = equipo.nombre_equipo;
                            const opcion2 = opcion1.cloneNode(true);
                            select1.appendChild(opcion1);
                            select2.appendChild(opcion2);
                            

                        }))
                        select1.addEventListener("change", function(){
                            const nombreEquipo = this.options[this.selectedIndex].text; 
                            cargarGraficaEvo(this.value, nombreEquipo, "blue", 0);

                        });

                        select2.addEventListener("change", function(){
                            const nombreEquipo = this.options[this.selectedIndex].text; 
                            cargarGraficaEvo(this.value, nombreEquipo, "red", 1);
                        });
                    })
                }
            }
            const params = new URLSearchParams(window.location.search);
            const ligaParam = params.get("liga");

            if(ligaParam){
                liga.value = ligaParam;
                cargarTabla(ligaParam);
                cargarOpciones(ligaParam);
                cargarGraficaPromedios(ligaParam);
            }
            else{
                cargarTabla(liga.value);
                cargarOpciones(liga.value);
                cargarGraficaPromedios(liga.value);
            }

            liga.addEventListener("change", function(){
                cargarTabla(this.value);
                cargarOpciones(this.value);
                cargarGraficaPromedios(this.value);
            });
            
        </script>
    </body>
</html>