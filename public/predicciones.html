<!DOCTYPE html>
<html>
    <head>
        <title>FootViz - Predicciones</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
        <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
        <style>
            /* --- Estilos Base y Layout --- */
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: 'Poppins', sans-serif;
                background-color: #1a1a2e;
                color: #e0e0e0;
                padding: 20px;
                transition: background-color 0.3s, color 0.3s;
            }
            .container { 
                max-width: 800px; /* Ancho m치ximo para una sola columna */
                margin: 0 auto; 
            }
            h2, h3 { color: #ffffff; margin-bottom: 15px; }

            /* --- Cabecera --- */
            .header {
                display: flex; justify-content: space-between; align-items: center;
                margin-bottom: 30px; padding-bottom: 20px;
                border-bottom: 1px solid #2a2a4a;
            }
            .header h1 { font-size: 2rem; color: #ffffff; font-weight: 700; }
            .theme-toggle-button {
                background: #2a2a4a; border: 1px solid #4a4a6a; color: #fff; width: 42px; height: 42px;
                padding: 10px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;
                display: flex; align-items: center; justify-content: center;
            }

            /* --- Estilo de Tarjeta --- */
            .card {
                background-color: #1e1e3f;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                width: 100%;
                margin-bottom: 20px; /* Espacio entre tarjetas */
            }

            /* --- Contenedor de Predicciones --- */
            .prediction-header { text-align: center; }
            .deadline-timer { font-size: 1.1rem; color: #f59e0b; font-weight: 600; }

            .prediction-card {
                border: 1px solid #2a2a4a;
                transition: box-shadow 0.3s;
            }
            .prediction-card:hover {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            }
            
            .match-header {
                display: flex;
                justify-content: space-around;
                align-items: center;
                text-align: center;
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 15px;
            }
            .match-header img {
                width: 50px;
                height: 50px;
                border-radius: 50%;
            }

            .team-form { /* RQF5 */
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.8rem;
                color: #a0a0c0;
                margin-bottom: 20px;
            }
            .form-streaks { display: flex; gap: 4px; }
            .form-streaks span {
                width: 20px; height: 20px; border-radius: 50%; display: inline-block;
                line-height: 20px; text-align: center; font-weight: 700;
            }
            .form-V { background-color: #16a34a; color: white; } /* Victoria */
            .form-E { background-color: #6b7280; color: white; } /* Empate */
            .form-D { background-color: #dc2626; color: white; } /* Derrota */

            .prediction-group { /* RQF1 */
                margin-bottom: 15px;
            }
            .prediction-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #a0a0c0;
            }
            .prediction-group select, .prediction-group input {
                width: 100%;
                background-color: #2a2a4a;
                color: #e0e0e0;
                border: 1px solid #4a4a6a;
                border-radius: 8px;
                padding: 10px 15px;
                font-family: 'Poppins', sans-serif;
                font-size: 0.9rem;
            }
            .result-buttons { display: flex; gap: 10px; }
            .result-buttons button {
                flex: 1;
                padding: 10px;
                border: 1px solid #4a4a6a;
                background-color: #2a2a4a;
                color: #e0e0e0;
                border-radius: 8px;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            .result-buttons button:hover { background-color: #3a3a5a; }
            .result-buttons button.selected {
                background-color: #4a69ff; /* Color de selecci칩n */
                border-color: #4a69ff;
                color: white;
                font-weight: 600;
            }

            .popular-picks { /* RQF6 */
                margin-top: 15px;
            }
            .popular-picks-bar {
                display: flex;
                height: 10px;
                border-radius: 5px;
                overflow: hidden;
                background-color: #1a1a2e;
            }
            .popular-picks-bar div {
                height: 100%;
                transition: width 0.5s;
            }
            .popular-local { background-color: #007bff; }
            .popular-empate { background-color: #6b7280; }
            .popular-visitante { background-color: #ff4d4d; }

            .save-prediction-btn {
                width: 100%;
                background-color: #059669; /* Verde */
                color: white;
                border: none;
                padding: 12px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 1rem;
                font-weight: 600;
                margin-top: 15px;
            }
            .save-prediction-btn:disabled {
                background-color: #475569;
                cursor: not-allowed;
            }
            .prediction-status {
                display: none; 
                text-align: center; 
                color: #059669; 
                margin-top: 10px;
                font-weight: 600;
            }
            
            /* --- 游녢 NUEVO: ESTILOS TABLA RECOMPENSAS 游녢 --- */
            .rewards-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
            }
            .rewards-table th, .rewards-table td {
                padding: 12px 15px;
                text-align: left;
                border-bottom: 1px solid #2a2a4a;
            }
            .rewards-table th {
                background-color: #2a2a4a;
                color: #ffffff;
                font-weight: 600;
                font-size: 0.9rem;
            }
            .rewards-table td {
                font-size: 0.9rem;
            }
            .rewards-table td:last-child {
                text-align: center;
                font-weight: 700;
                font-size: 1rem;
                color: #4a69ff;
            }
            .rewards-table tr:last-child td {
                border-bottom: none;
            }
            /* --- 游녡 FIN DE NUEVOS ESTILOS 游녡 --- */
            
            /* --- MODO LUZ --- */
            body.light-mode { background-color: #f4f4f9; color: #333333; }
            body.light-mode .header { border-bottom-color: #e0e0e0; }
            body.light-mode .header h1, body.light-mode h2, body.light-mode h3 { color: #1a1a2e; }
            body.light-mode .theme-toggle-button { background: #ffffff; border-color: #d1d1d1; color: #333; }
            body.light-mode .card { background-color: #ffffff; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
            body.light-mode .team-form { color: #666; }
            body.light-mode .prediction-group label { color: #555; }
            body.light-mode .prediction-group select, body.light-mode .prediction-group input { background-color: #f0f0f0; border-color: #d1d1d1; color: #333; }
            body.light-mode .result-buttons button { background-color: #e9e9f3; border-color: #d1d1d1; color: #333; }
            body.light-mode .result-buttons button:hover { background-color: #d1d1d1; }
            body.light-mode .result-buttons button.selected { background-color: #4a69ff; border-color: #4a69ff; color: white; }
            body.light-mode .popular-picks-bar { background-color: #e9e9f3; }
            body.light-mode .prediction-status { color: #059669; }

            /* 游녢 NUEVO: MODO LUZ PARA TABLA RECOMPENSAS 游녢 */
            body.light-mode .rewards-table th {
                background-color: #e9e9f3;
                color: #333;
            }
            body.light-mode .rewards-table td {
                border-color: #e0e0e0;
            }
            /* 游녡 FIN MODO LUZ 游녡 */
            .chart-container {
                position: relative;
                width: 100%;
                height: 250px; /* Altura para el gr치fico */
            }

        </style>
    </head>
    <body>
        <div class="container">

            <header class="header">
                <h1>Mis Predicciones</h1>
            </header>

            <main class="predictions-container">
                <div class="card">
                    <h2>Evolucion de Puntos</h2>
                    <div class="chart-container">
                        <canvas id="points-graph"></canvas>
                        <p id="points-graph-placeholder" style="display: none; text-align: center; padding-top: 50px;">
                            A칰n no hay datos de puntos para mostrar.
                        </p>
                    </div>
                </div>
                <div class="card prediction-header">
                    <h2>Jornada <span id="jornada-numero">X</span></h2>
                    <p>Fecha limite para predicciones: <strong id="deadline-timer" class="deadline-timer">Jueves 11:59 PM</strong></p>
                </div>
                
                <div id="prediction-matches-container">
                    
                    <div class="card prediction-card" data-match-id="1">
                        </div>
                    
                    <div class="card prediction-card" data-match-id="2">
                        </div>
                    
                    <div class="card prediction-card" data-match-id="3">
                        </div>
                    
                    <div class="card prediction-card" data-match-id="4">
                        </div>

                    <div class="card prediction-card" data-match-id="5">
                        </div>

                </div>
                
                <div class="card rewards-card">
                    <h2>Recompensas de XP</h2>
                    <table class="rewards-table">
                        <thead>
                            <tr>
                                <th>Acci칩n</th>
                                <th>Puntos de xp</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Adivina el ganador</td>
                                <td>3</td>
                            </tr>
                            <tr>
                                <td>Adivina correctamente el primer equipo en anotar</td>
                                <td>2</td>
                            </tr>
                            <tr>
                                <td>Adivina correctamente el primer jugador en anotar</td>
                                <td>5</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                </main>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            let pointsChartInstance = null;
            const imgLocal = document.getElementById('local-team-img-1');
            const imgVisitante = document.getElementById('visitante-team-img-1');
            const darkChartOptions = { 
                responsive: true, maintainAspectRatio: false,
                scales: { 
                    y: { ticks: { color: '#e0e0e0' }, grid: { color: 'rgba(224, 224, 224, 0.1)' }, title: { display: true, text: 'Puntos XP Acumulados', color: '#e0e0e0'} }, 
                    x: { ticks: { color: '#e0e0e0' }, grid: { color: 'rgba(224, 224, 224, 0.1)' }, title: { display: true, text: 'Jornada', color: '#e0e0e0'} } 
                }, 
                plugins: { legend: { display: false } } 
            };
            const lightChartOptions = { 
                responsive: true, maintainAspectRatio: false,
                scales: { 
                    y: { ticks: { color: '#666' }, grid: { color: 'rgba(0, 0, 0, 0.1)' }, title: { display: true, text: 'Puntos XP Acumulados', color: '#333'} }, 
                    x: { ticks: { color: '#666' }, grid: { color: 'rgba(0, 0, 0, 0.1)' }, title: { display: true, text: 'Jornada', color: '#333'} } 
                }, 
                plugins: { legend: { display: false } } 
            };
            async function cargarPagina() {
                try {
                    // 1. Iniciar ambas peticiones en paralelo
                    const partidosPromise = fetch('/api/fantasy/partidos-prediccion').then(res => res.json());
                    const historialPromise = fetch('/api/fantasy/historial-predicciones').then(res => {
                        if (res.status === 401 || res.status === 403) {
                            alert("Tu sesi칩n ha expirado.");
                            window.location.href = '/login.html';
                            return Promise.reject('Sesi칩n expirada');
                        }
                        if (!res.ok) return []; // Si falla (ej. 404), devuelve array vac칤o
                        return res.json();
                    });

                    // 2. Esperar a que ambas terminen
                    const [partidos, historial] = await Promise.all([partidosPromise, historialPromise]);

                    // 3. Renderizar las tarjetas de predicci칩n
                    if (partidos && partidos.length > 0) {
                        document.getElementById('jornada-numero').textContent = partidos[0].jornada;
                        // Pasamos un array vac칤o por ahora para 'misPredicciones'
                        renderPredictionCards(partidos, []); 
                    } else {
                        document.getElementById('prediction-matches-container').innerHTML = "<p>No hay partidos de predicci칩n disponibles.</p>";
                    }
                    
                    // 4. Renderizar el gr치fico de historial (RQF4)
                    renderPointsGraph(historial);

                    // 5. A침adir listeners a los botones de guardar
                    addSaveButtonListeners();

                } catch (error) {
                    console.error("Error al cargar la p치gina de predicciones:", error);
                    if (error !== 'Sesi칩n expirada') {
                        document.getElementById('prediction-matches-container').innerHTML = "<p>Error al cargar la p치gina.</p>";
                    }
                }
            }
            
            function renderPointsGraph(historial) {
                const ctx = document.getElementById('points-graph').getContext('2d');
                const placeholder = document.getElementById('points-graph-placeholder');

                // RQF4 Condici칩n: Si no hay datos, mostrar placeholder
                if (!historial || historial.length === 0) {
                    placeholder.style.display = 'block';
                    ctx.canvas.style.display = 'none';
                    
                    // L칩gica de 1 de Agosto (opcional, pero como lo pediste)
                    const hoy = new Date();
                    if (hoy.getMonth() == 7 && hoy.getDay() < 10) { // 7 es Agosto (0-11)
                        placeholder.textContent = "La temporada de predicciones a칰n no ha comenzado.";
                    } else {
                        placeholder.textContent = "춰Empieza a predecir para ver tu historial de puntos!";
                    }
                    return;
                }
                
                placeholder.style.display = 'none';
                ctx.canvas.style.display = 'block';

                let labels = [];
                let cumulativeData = [];
                let totalAcumulado = 0;

                // Calcular puntos acumulados
                historial.forEach(item => {
                    totalAcumulado += parseInt(item.puntos_jornada, 10); // Suma los puntos de esta jornada
                    labels.push(`J${item.jornada}`);
                    cumulativeData.push(totalAcumulado); // A침ade el total acumulado
                });

                if (pointsChartInstance) {
                    pointsChartInstance.destroy(); // Destruir gr치fico anterior si existe
                }

                const currentOptions = body.classList.contains('light-mode') ? lightChartOptions : darkChartOptions;

                pointsChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Puntos XP Acumulados',
                            data: cumulativeData,
                            borderColor: '#4a69ff',
                            backgroundColor: 'rgba(74, 105, 255, 0.2)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: currentOptions
                });
            }
            
            function renderPredictionCards(partidos, misPredicciones) {
                const container = document.getElementById('prediction-matches-container');
                container.innerHTML = ''; // Limpiar los placeholders

                partidos.forEach((partido, index) => {
                    const card = document.createElement('div');
                    card.className = 'card prediction-card';
                    card.dataset.matchId = partido.id_partido;
                    
                    const cardIndex = index + 1; // Para los IDs 칰nicos (1 a 5)

                    // 1. Buscar si hay una predicci칩n guardada para ESTE partido
                    const miPrediccion = misPredicciones.find(p => p.id_partido === partido.id_partido);

                    // 2. Preparar los valores guardados (si existen)
                    const savedResult = miPrediccion?.resultado_predicho || '';
                    const savedTeam = miPrediccion?.primer_equipo_anotar_id || '';
                    const savedPlayer = miPrediccion?.primer_jugador_anotar_id || '';

                    card.innerHTML = `
                        <div class="match-header">
                            <img src="${partido.escudo_local}" alt="${partido.nombre_local}">
                            <span>
                                <span id="local-team-name-${cardIndex}">${partido.nombre_local}</span> vs 
                                <span id="visitante-team-name-${cardIndex}">${partido.nombre_visitante}</span>
                            </span>
                            <img src="${partido.escudo_visitante}" alt="${partido.nombre_visitante}">
                        </div>
                        <div class="team-form">
                            <div class="form-streaks" id="local-form-${cardIndex}"></div>
                            <span>Forma (칔lt. 5)</span>
                            <div class="form-streaks" id="visitante-form-${cardIndex}"></div>
                        </div>
                        <div class="popular-picks">
                            <label>Predicciones Populares</label>
                            <div class="popular-picks-bar">
                                <div class="popular-local" id="pop-local-${cardIndex}" title="Local"></div>
                                <div class="popular-empate" id="pop-empate-${cardIndex}" title="Empate"></div>
                                <div class="popular-visitante" id="pop-visitante-${cardIndex}" title="Visitante"></div>
                            </div>
                        </div>
                        <hr style="border-color: #2a2a4a; margin: 20px 0;">
                        <div class="prediction-group">
                            <label>Resultado Final</label>
                            <div class="result-buttons">
                                <button data-prediction="L" class="${savedResult === 'L' ? 'selected' : ''}">Local</button>
                                <button data-prediction="E" class="${savedResult === 'E' ? 'selected' : ''}">Empate</button>
                                <button data-prediction="V" class="${savedResult === 'V' ? 'selected' : ''}">Visitante</button>
                            </div>
                        </div>
                        <div class="prediction-group">
                            <label for="first-to-score-${cardIndex}">Primer Equipo en Anotar</label>
                            <select id="first-to-score-${cardIndex}">
                                <option value="">Seleccionar...</option>
                                <option value="${partido.id_local}" ${savedTeam == partido.id_local ? 'selected' : ''}>${partido.nombre_local}</option>
                                <option value="${partido.id_visitante}" ${savedTeam == partido.id_visitante ? 'selected' : ''}>${partido.nombre_visitante}</option>
                            </select>
                        </div>
                        <div class="prediction-group">
                            <label for="first-player-to-score-${cardIndex}">Primer Jugador en Anotar</label>
                            <select id="first-player-to-score-${cardIndex}">
                                <option value="">Seleccionar Jugador...</option>
                                </select>
                        </div>
                        <button class="save-prediction-btn" data-match-id="${partido.id_partido}">Guardar Predicci칩n</button>
                        <p class="prediction-status">춰Predicci칩n Guardada!</p>
                    `;
                    
                    container.appendChild(card);

                    // --- Cargar datos as칤ncronos para la tarjeta ---
                    cargarEstadoDeForma(partido.id_local, `local-form-${cardIndex}`);
                    cargarEstadoDeForma(partido.id_visitante, `visitante-form-${cardIndex}`);
                    
                    // 5. Pasamos el ID del jugador guardado a la funci칩n que carga el select
                    cargarJugadoresParaSelect(partido.id_partido, `first-player-to-score-${cardIndex}`, savedPlayer);
                    
                    cargarPronosticosPopulares(partido.id_partido, cardIndex);
                });
            }
            
            function addSaveButtonListeners() {
                document.querySelectorAll('.save-prediction-btn').forEach(button => {
                    button.addEventListener('click', handleSavePrediction);
                });
            }
            
            async function handleSavePrediction(event) {
                const saveButton = event.target;
                const card = saveButton.closest('.prediction-card');
                const status = card.querySelector('.prediction-status');

                // --- RQF2: Validar la fecha l칤mite ---
                try {
                    const now = new Date(new Date().toLocaleString("en-US", { timeZone: "America/Mexico_City" }));
                    const dayOfWeek = now.getDay(); // 0=Dom, 1=Lun, 2=Mar, 3=Mi칠, 4=Jue, 5=Vie, 6=S치b
                    
                    // D칤as en que el mercado est치 CERRADO
                    const closedDays = [0, 1, 5, 6]; // Dom, Lun, Vie, S치b

                    if (closedDays.includes(dayOfWeek)) {
                        alert("춰Mercado de predicciones cerrado!\n\nLas predicciones se abren de martes a jueves.");
                        return;
                    }
                    
                    // (Tu l칩gica de Jueves 23:59 ya est치 cubierta, ya que el Viernes (5) est치 en closedDays)

                } catch (e) {
                    console.error("Error al validar la fecha:", e);
                    alert("No se pudo verificar la fecha l칤mite. Intenta de nuevo.");
                    return;
                }
                // --- Fin de Validaci칩n ---

                // 1. Recolectar datos
                const matchId = card.dataset.matchId;
                const result = card.querySelector('.result-buttons button.selected')?.dataset.prediction || null;
                const firstTeam = card.querySelector(`select[id^="first-to-score-"]`).value || null;
                const firstPlayer = card.querySelector(`select[id^="first-player-to-score-"]`).value || null;

                // Prevenir que se guarde si no ha seleccionado nada
                if (result === null && firstTeam === null && firstPlayer === null) {
                    alert("Debes seleccionar al menos una predicci칩n para guardar.");
                    return;
                }

                saveButton.disabled = true;
                saveButton.textContent = "Guardando...";

                // 2. Enviar datos al backend (POST a /api/fantasy/guardar-prediccion)
                try {
                    const response = await fetch('/api/fantasy/guardar-prediccion', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                            // El token (cookie) se env칤a autom치ticamente
                        },
                        body: JSON.stringify({
                            id_partido: matchId,
                            resultado_predicho: result,
                            primer_equipo_anotar_id: firstTeam,
                            primer_jugador_anotar_id: firstPlayer
                        })
                    });

                    if (response.status === 401 || response.status === 403) {
                        alert("Tu sesi칩n ha expirado. Inicia sesi칩n de nuevo.");
                        window.location.href = '/login.html';
                        return;
                    }

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error || "No se pudo guardar la predicci칩n.");
                    }

                    // 3. Mostrar confirmaci칩n
                    status.textContent = "춰Predicci칩n Guardada!";
                    status.style.color = "#059669";
                    status.style.display = 'block';
                    
                } catch (error) {
                    console.error("Error al guardar predicci칩n:", error);
                    status.textContent = `Error: ${error.message}`;
                    status.style.color = "#dc2626"; // Rojo
                    status.style.display = 'block';
                } finally {
                    saveButton.disabled = false;
                    saveButton.textContent = "Guardar Predicci칩n";
                    setTimeout(() => { status.style.display = 'none'; }, 3000);
                }
            }
            
            async function cargarEstadoDeForma(equipoId, containerId) {
                const container = document.getElementById(containerId);
                container.innerHTML = ""; // Limpiar
                try {
                    const response = await fetch(`/api/estado-forma/${equipoId}`);
                    if (!response.ok) throw new Error('Error al cargar forma');
                    const forma = await response.json(); // Espera el array [ {resultado: 'V'}, ... ]

                    // Tomamos solo los 칰ltimos 5
                    forma.slice(0, 5).forEach(partido => {
                        const span = document.createElement('span');
                        span.className = `form-${partido.resultado}`; // form-V, form-E, o form-L
                        span.textContent = partido.resultado;
                        container.appendChild(span);
                    });
                } catch (error) {
                    console.error(`Error cargando forma para ${containerId}:`, error);
                    container.innerHTML = "<span>?</span>".repeat(5); // Poner '?' si falla
                }
            }

            async function cargarJugadoresParaSelect(partidoId, selectId) {
                const select = document.getElementById(selectId);
                try {
                    const response = await fetch(`/api/plantillas-partido/${partidoId}`);
                    if (!response.ok) throw new Error('Error al cargar jugadores');
                    const jugadores = await response.json();

                    jugadores.forEach(jugador => {
                        const option = document.createElement('option');
                        option.value = jugador.id_jugador;
                        option.textContent = `(${jugador.posicion}) ${jugador.nombre_jugador} (${jugador.nombre_equipo})`;
                        
                        // 6. Si este es el jugador que el usuario ya hab칤a guardado, lo seleccionamos
                        
                        
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error(`Error cargando jugadores para ${selectId}:`, error);
                }
            }

            async function cargarPronosticosPopulares(partidoId, cardIndex) {
                try {
                    // 1. Hacemos el fetch
                    const response = await fetch(`/api/fantasy/predicciones-populares/${partidoId}`);
                    if (!response.ok) throw new Error('Error al cargar populares');
                    
                    const data = await response.json(); // { resultado: [...], primerEquipo: [...], ... }

                    // --- Parte A: Llenar la barra de Resultado Final ---

                    // 2. Objeto para guardar los votos
                    const votos = {
                        L: 0,
                        E: 0,
                        V: 0
                    };

                    // 3. Llenamos el objeto 'votos' desde el array 'data.resultado'
                    if (data.resultado) {
                        data.resultado.forEach(item => {
                            // item es { "resultado_predicho": "V", "total_votos": 2 }
                            if (votos.hasOwnProperty(item.resultado_predicho)) {
                                votos[item.resultado_predicho] = item.total_votos;
                            }
                        });
                    }

                    // 4. Calcular el total y los porcentajes
                    const totalVotos = votos.L + votos.E + votos.V;

                    let porcLocal = 0;
                    let porcEmpate = 0;
                    let porcVisitante = 0;

                    if (totalVotos > 0) {
                        porcLocal = (votos.L / totalVotos) * 100;
                        porcEmpate = (votos.E / totalVotos) * 100;
                        porcVisitante = (votos.V / totalVotos) * 100;
                    }

                    // 5. Aplicar al DOM (las barras de progreso)
                    const localBar = document.getElementById(`pop-local-${cardIndex}`);
                    const empateBar = document.getElementById(`pop-empate-${cardIndex}`);
                    const visitanteBar = document.getElementById(`pop-visitante-${cardIndex}`);

                    if (localBar) {
                        localBar.style.width = `${porcLocal}%`;
                        localBar.title = `Local: ${votos.L} votos (${porcLocal.toFixed(0)}%)`;
                    }
                    if (empateBar) {
                        empateBar.style.width = `${porcEmpate}%`;
                        empateBar.title = `Empate: ${votos.E} votos (${porcEmpate.toFixed(0)}%)`;
                    }
                    if (visitanteBar) {
                        visitanteBar.style.width = `${porcVisitante}%`;
                        visitanteBar.title = `Visitante: ${votos.V} votos (${porcVisitante.toFixed(0)}%)`;
                    }

                    // --- Parte B: (Opcional) Mostrar el jugador/equipo m치s popular ---
                    // (Tu HTML no tiene d칩nde poner esto, pero as칤 es como lo har칤as)

                    if (data.primerEquipo && data.primerEquipo.length > 0) {
                        const equipoPopular = data.primerEquipo[0];
                        console.log(`Popular (Equipo): ${equipoPopular.nombre_equipo} con ${equipoPopular.total_votos} votos`);
                        // Aqu칤 podr칤as a침adir un texto peque침o:
                        // const labelEquipo = document.querySelector(`label[for="first-to-score-${cardIndex}"]`);
                        // labelEquipo.innerHTML += ` <span style="font-size: 0.8rem; color: #a0a0c0;">(Pop: ${equipoPopular.nombre_equipo})</span>`;
                    }

                    if (data.primerJugador && data.primerJugador.length > 0) {
                        const jugadorPopular = data.primerJugador[0];
                        console.log(`Popular (Jugador): ${jugadorPopular.nombre_jugador} con ${jugadorPopular.total_votos} votos`);
                        // Y aqu칤 tambi칠n:
                        // const labelJugador = document.querySelector(`label[for="first-player-to-score-${cardIndex}"]`);
                        // labelJugador.innerHTML += ` <span style="font-size: 0.8rem; color: #a0a0c0;">(Pop: ${jugadorPopular.nombre_jugador})</span>`;
                    }

                } catch (error) {
                    console.error(`Error cargando populares para partido ${partidoId}:`, error);
                    // Ocultamos la barra si falla la carga
                    const popBar = document.getElementById(`pop-local-${cardIndex}`)?.closest('.popular-picks');
                    if (popBar) popBar.style.display = 'none';
                }
            }

            // L칩gica para botones de resultado (L/E/V)
            document.getElementById('prediction-matches-container').addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON' && e.target.closest('.result-buttons')) {
                    const buttons = e.target.closest('.result-buttons').querySelectorAll('button');
                    buttons.forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                }
            });

            // Carga inicial (descomentar cuando tengas los endpoints)
            cargarPagina();
        </script>

    </body>
</html>