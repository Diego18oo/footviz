<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>FootViz - Crea tu Equipo Fantasy</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
        <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
        <style>
            /* --- Estilos Base y Layout Principal --- */
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: 'Poppins', sans-serif;
                background-color: #0f172a; /* Azul muy oscuro, similar a la imagen */
                color: #e0e0e0;
                padding: 20px;
                display: flex;
                flex-direction: column;
                min-height: 100vh;
            }

            .team-creation-container {
                display: flex;
                gap: 20px;
                flex-grow: 1; /* Ocupa el espacio disponible */
                max-width: 1600px;
                margin: 20px auto;
                width: 100%;
            }

            /* --- Columna Izquierda: Campo y Equipo --- */
            .pitch-column {
                flex: 1; /* Ocupa la mitad izquierda */
                display: flex;
                flex-direction: column;
                background-color: #1e293b; /* Azul grisáceo oscuro */
                border-radius: 12px;
                padding: 20px;
            }
            .pitch-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }
            .pitch-header h2 { color: #fff; font-size: 1.3rem; }
            .auto-complete-btn {
                background-color: #3b82f6; /* Azul brillante */
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.9rem;
                display: flex;
                align-items: center;
                gap: 5px;
            }
            .pitch-advice { font-size: 0.8rem; color: #94a3b8; margin-bottom: 20px; }
            .pitch-display {
                background-color: #047857; /* Verde campo */
                border-radius: 8px;
                padding: 20px;
                aspect-ratio: 7 / 10; /* Proporción similar a un campo */
                display: grid;
                grid-template-rows: repeat(4, 1fr); /* 4 filas para POR, DEF, CEN, DEL */
                gap: 10px;
                position: relative; /* Para líneas si las añades */
            }
            .pitch-row { display: flex; justify-content: space-around; align-items: center; }
            .player-slot {
                display: flex;
                flex-direction: column;
                align-items: center;
                cursor: pointer;
                padding: 5px;
                border-radius: 4px;
                transition: background-color 0.2s;
            }
            .player-slot:hover { background-color: rgba(255, 255, 255, 0.1); }
            .player-slot img { width: 40px; height: auto; margin-bottom: 3px; } /* Camiseta */
            .player-name { font-size: 0.7rem; color: #fff; background-color: rgba(0,0,0,0.5); padding: 1px 4px; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60px; }
            .player-price { font-size: 0.6rem; color: #cbd5e1; }

            /* --- Columna Derecha: Selección de Jugadores --- */
            .player-selection-column {
                flex: 1; /* Ocupa la mitad derecha */
                background-color: #1e293b;
                border-radius: 12px;
                padding: 20px;
                display: flex;
                flex-direction: column;
            }
            .filters { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
            .filters select, .filters input[type="text"] {
                background-color: #334155;
                color: #e0e0e0;
                border: 1px solid #475569;
                border-radius: 6px;
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            .filters input[type="text"] { flex-grow: 1; max-width: 200px; } /* Campo de búsqueda */
            .player-list-container {
                flex-grow: 1; /* Ocupa el espacio restante */
                overflow-y: auto; /* Permite scroll si hay muchos jugadores */
            }
            .player-list table { width: 100%; border-collapse: collapse; }
            .player-list th, .player-list td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #334155; font-size: 0.85rem; }
            .player-list th { color: #94a3b8; font-weight: 400; }
            .player-list td img { width: 24px; height: 24px; border-radius: 50%; vertical-align: middle; margin-right: 8px; }
            .player-list tbody tr:hover { background-color: #334155; cursor: pointer; }
            .add-player-btn { background: none; border: none; color: #3b82f6; font-size: 1.2rem; cursor: pointer; } /* Botón '+' visual */

            /* --- Barra Inferior: Resumen y Continuar --- */
            .summary-bar {
                background-color: #1e293b;
                border-radius: 12px;
                padding: 15px 25px;
                margin-top: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .summary-info span { margin-right: 20px; font-size: 0.9rem; }
            .summary-info strong { color: #fff; }
            .continue-btn {
                background-color: #059669; /* Verde */
                color: white;
                border: none;
                padding: 10px 25px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1rem;
                font-weight: 600;
            }
            .continue-btn:disabled { background-color: #475569; cursor: not-allowed; } /* Estilo si no se puede continuar */
            .pagination-controls {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 15px 0;
                gap: 10px;
            }
            .pagination-controls button {
                background-color: #334155;
                color: #e0e0e0;
                border: 1px solid #475569;
                border-radius: 4px;
                padding: 5px 10px;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            .pagination-controls button:hover:not(:disabled) {
                background-color: #475569;
            }
            .pagination-controls button:disabled {
                cursor: not-allowed;
                opacity: 0.5;
            }
            .pagination-controls .page-number {
                padding: 5px 8px;
                cursor: pointer;
                border-radius: 4px;
                transition: background-color 0.2s;
            }
            .pagination-controls .page-number:hover {
                background-color: #475569;
            }
            .pagination-controls .page-number.active {
                background-color: #3b82f6;
                color: white;
                font-weight: 600;
            }

        </style>
    </head>
    <body>
        <div class="summary-bar">
            <div class="summary-info">
                <span>Jugadores Restantes: <strong id="players-remaining">15</strong>/15</span>
                <span>Presupuesto: <strong id="budget-display">$100m</strong></span>
            </div>
            <button class="continue-btn" id="continue-button" disabled>Continuar</button>
        </div>
        <div class= "team-creation-container">

            <div class="pitch-column">
                <div class="pitch-header">
                    <h2>Elige tu equipo</h2>
                    <button class="auto-complete-btn" id="auto-complete">
                        <ion-icon name="shuffle-outline"></ion-icon> Auto-completar
                    </button>
                </div>
                <p class="pitch-advice">CONSEJO: Puedes autocompletar tu plantilla ahora y afinarla antes del primer partido</p>

                <div class="pitch-display" id="pitch">
                    <div class="pitch-row">
                        <div class="player-slot" data-position="F" data-slot="1">
                            <ion-icon name="shirt-outline"></ion-icon>
                            <span class="player-name">(Vacío)</span>
                            <span class="player-price">--M</span>
                        </div>
                        <div class="player-slot" data-position="F" data-slot="2">
                            <ion-icon name="shirt-outline"></ion-icon>
                            <span class="player-name">(Vacío)</span>
                            <span class="player-price">--M</span>
                        </div>
                        <div class="player-slot" data-position="F" data-slot="3">
                            <ion-icon name="shirt-outline"></ion-icon>
                            <span class="player-name">(Vacío)</span>
                            <span class="player-price">--M</span>
                        </div>
                    </div>
                    <div class="pitch-row">
                        <div class="player-slot" data-position="M" data-slot="1">
                            <ion-icon name="shirt-outline"></ion-icon>
                            <span class="player-name">(Vacío)</span><span class="player-price">--M</span></div>
                        <div class="player-slot" data-position="M" data-slot="2"><ion-icon name="shirt-outline"></ion-icon><span class="player-name">(Vacío)</span><span class="player-price">--M</span></div>
                        <div class="player-slot" data-position="M" data-slot="3"><ion-icon name="shirt-outline"></ion-icon><span class="player-name">(Vacío)</span><span class="player-price">--M</span></div>
                        <div class="player-slot" data-position="M" data-slot="4"><ion-icon name="shirt-outline"></ion-icon><span class="player-name">(Vacío)</span><span class="player-price">--M</span></div>
                        <div class="player-slot" data-position="M" data-slot="5"><ion-icon name="shirt-outline"></ion-icon><span class="player-name">(Vacío)</span><span class="player-price">--M</span></div>
                    </div>
                    <div class="pitch-row">
                        <div class="player-slot" data-position="D" data-slot="1"><ion-icon name="shirt-outline"></ion-icon><span class="player-name">(Vacío)</span><span class="player-price">--M</span></div>
                        <div class="player-slot" data-position="D" data-slot="2"><ion-icon name="shirt-outline"></ion-icon><span class="player-name">(Vacío)</span><span class="player-price">--M</span></div>
                        <div class="player-slot" data-position="D" data-slot="3"><ion-icon name="shirt-outline"></ion-icon><span class="player-name">(Vacío)</span><span class="player-price">--M</span></div>
                        <div class="player-slot" data-position="D" data-slot="4"><ion-icon name="shirt-outline"></ion-icon><span class="player-name">(Vacío)</span><span class="player-price">--M</span></div>
                        <div class="player-slot" data-position="D" data-slot="5"><ion-icon name="shirt-outline"></ion-icon><span class="player-name">(Vacío)</span><span class="player-price">--M</span></div>
                    </div>
                    <div class="pitch-row">
                        <div class="player-slot" data-position="G" data-slot="1"><ion-icon name="shirt-outline"></ion-icon><span class="player-name">(Vacío)</span><span class="player-price">--M</span></div>
                    <div class="player-slot" data-position="G" data-slot="2"><ion-icon name="shirt-outline"></ion-icon><span class="player-name">(Vacío)</span><span class="player-price">--M</span></div>
                    </div>
                </div>
            </div>

            <div class="player-selection-column">
                <div class="filters">
                    <select id="position-filter">
                        <option value="ALL">Posición: Todos</option>
                        <option value="G">Porteros (POR)</option>
                        <option value="D">Defensas (DEF)</option>
                        <option value="M">Centrocampistas (CEN)</option>
                        <option value="F">Delanteros (DEL)</option>
                    </select>
                    <select id="team-filter">
                        <option value="ALL">Equipo: Todos</option>
                        </select>
                    <select id="price-filter">
                        <option value="ALL">Precio: Todos</option>
                        </select>
                    <input type="text" id="search-player" placeholder="Buscar jugador...">
                    <button id="search-btn"><ion-icon name="search-outline"></ion-icon></button>
                </div>

                <div class="player-list-container">
                    <table class="player-list" id="player-list-table">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>Precio</th>
                                <th>Popularidad</th> 
                                <th>Pts</th> 
                                <th></th> 
                            </tr>
                        </thead>
                        <tbody id="player-list-body">
                            
                        </tbody>
                    </table>
                    <div class="pagination-controls" id="pagination">
                        <button id="prev-page" disabled>&laquo; Anterior</button>
                        <span id="page-numbers"></span> <button id="next-page">Siguiente &raquo;</button>
                    </div>
                </div>
            </div>

        </div>

        
        
        <script>
            let allPlayers = [];
            let currentPage = 1;
            const playersPerPage = 15; 
            let filteredPlayers = [];
            let selectedPlayers = []; 
            let currentBudget = 100.0; 

            const autoCompleteButton = document.getElementById('auto-complete');
            const tbodyListaJugs = document.getElementById('player-list-body');
            const paginationContainer = document.getElementById('pagination');
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            const pageNumbersContainer = document.getElementById('page-numbers');
            const pitchSlots = document.querySelectorAll('.player-slot');
            const agregarBoton  = document.querySelectorAll('.add-player-btn');
            const positionFilter = document.getElementById('position-filter');
            const teamFilter = document.getElementById('team-filter');
            const priceFilter = document.getElementById('price-filter');
            const searchInput = document.getElementById('search-player');
            const searchButton = document.getElementById('search-btn'); 
            const playersRemainingDisplay = document.getElementById('players-remaining');
            const budgetDisplay = document.getElementById('budget-display');
            const continueButton = document.getElementById('continue-button');
            const pitchDisplay = document.getElementById('pitch');
            function applyFiltersAndDisplay() {
                const selectedPosition = positionFilter.value;
                const selectedTeamId = teamFilter.value; 
                const selectedPrice = priceFilter.value; 
                const searchTerm = searchInput.value.toLowerCase().trim();

                filteredPlayers = allPlayers;

                if (selectedPosition !== "ALL") {
                    filteredPlayers = filteredPlayers.filter(player => player.posicion === selectedPosition);
                }

                if (selectedTeamId !== "ALL") {
                    filteredPlayers = filteredPlayers.filter(player => player.id_equipo == selectedTeamId); 
                }

                if (selectedPrice !== "ALL") {
                    if (selectedPrice.includes('-')) {
                        const [min, max] = selectedPrice.split('-').map(Number);
                        filteredPlayers = filteredPlayers.filter(player => player.valor_actual >= min && player.valor_actual < max);
                    } else if (selectedPrice.endsWith('+')) {
                        const min = Number(selectedPrice.replace('+', ''));
                        filteredPlayers = filteredPlayers.filter(player => player.valor_actual >= min);
                    }
                }

                if (searchTerm !== "") {
                    filteredPlayers = filteredPlayers.filter(player =>
                        player.nombre_jugador.toLowerCase().includes(searchTerm)
                    );
                }

                displayPage(1);
            }

            function displayPage(page) {
                currentPage = page;
                tbodyListaJugs.innerHTML = "";

                const startIndex = (page - 1) * playersPerPage;
                const endIndex = startIndex + playersPerPage;
                const playersToShow = filteredPlayers.slice(startIndex, endIndex);
                playersToShow.forEach(jugador => {
                    const fila = document.createElement("tr");
                    fila.dataset.playerId = jugador.id_jugador;
                    fila.innerHTML = `
                        <td><img src="${jugador.url_imagen_jugador || 'placeholder-player-face.png'}" alt="Jugador"> ${jugador.nombre_jugador}</td>
                        <td><img src="${jugador.img_equipo || 'placeholder-player-face.png'}" alt="Equipo"> </td>
                        <td>$${jugador.valor_actual}M</td>
                        <td>${jugador.popularidad} %</td>
                        <td>${jugador.total_puntos_fantasy}</td>
                        <td><button class="add-player-btn" title="Añadir jugador"><ion-icon name="add-circle-outline"></ion-icon></button></td>
                    `;
                    tbodyListaJugs.appendChild(fila);
                });

                updatePaginationButtons();
                updatePageNumbers();
                updatePlayerListUI();
            }

            function updatePaginationButtons() {
                const totalPages = Math.ceil(filteredPlayers.length / playersPerPage);
                prevButton.disabled = currentPage === 1;
                nextButton.disabled = currentPage === totalPages;
            }

            function updatePageNumbers() {
                pageNumbersContainer.innerHTML = ""; 
                const totalPages = Math.ceil(filteredPlayers.length / playersPerPage);

                const maxPagesToShow = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
                let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

                if (endPage - startPage + 1 < maxPagesToShow) {
                    startPage = Math.max(1, endPage - maxPagesToShow + 1);
                }
                
                if (startPage > 1) {
                    const firstPage = document.createElement('span');
                    firstPage.textContent = '1';
                    firstPage.classList.add('page-number');
                    firstPage.onclick = () => displayPage(1);
                    pageNumbersContainer.appendChild(firstPage);
                    if (startPage > 2) pageNumbersContainer.appendChild(document.createTextNode(' ... '));
                }


                for (let i = startPage; i <= endPage; i++) {
                    const pageNumber = document.createElement('span');
                    pageNumber.textContent = i;
                    pageNumber.classList.add('page-number');
                    if (i === currentPage) {
                        pageNumber.classList.add('active');
                    }
                    pageNumber.onclick = () => displayPage(i);
                    pageNumbersContainer.appendChild(pageNumber);
                }
                
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) pageNumbersContainer.appendChild(document.createTextNode(' ... '));
                    const lastPage = document.createElement('span');
                    lastPage.textContent = totalPages;
                    lastPage.classList.add('page-number');
                    lastPage.onclick = () => displayPage(totalPages);
                    pageNumbersContainer.appendChild(lastPage);
                }

            }
            
            // RQF3
            async function cargarJugadoresDisponibles() {
                try {
                    const response = await fetch('/api/fantasy/available-players'); 
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert("Tu sesión ha expirado."); window.location.href = '/login.html'; return;
                        }
                        throw new Error('Error al cargar jugadores.');
                    }
                    allPlayers = await response.json(); 
                    console.log(allPlayers.length);
                    
                    allPlayers.sort((a, b) => {
                        const puntosDiff = b.total_puntos_fantasy - a.total_puntos_fantasy;
                        
                        if (puntosDiff !== 0) {
                            return puntosDiff;
                        }
                        
                        return parseFloat(a.valor_actual) - parseFloat(b.valor_actual);
                    });
                    populateTeamFilter();
                    populatePriceFilter();
                    filteredPlayers = [...allPlayers];

                    displayPage(1); 
                } catch (error) {
                    console.error("Error al cargar jugadores:", error);
                    tbodyListaJugs.innerHTML = `<tr><td colspan="5">Error al cargar jugadores. Intenta recargar.</td></tr>`;
                }
            }

            function populateTeamFilter() {
                const teams = new Map(); 
                allPlayers.forEach(player => {
                    if (player.id_equipo && player.nombre_equipo) {
                        teams.set(player.id_equipo, player.nombre_equipo);
                    }
                });

                const sortedTeams = Array.from(teams.entries()).sort((a, b) => a[1].localeCompare(b[1]));

                sortedTeams.forEach(([id, name]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    teamFilter.appendChild(option);
                });
            }

            function populatePriceFilter() {
                const priceRanges = ["0-5", "5-7", "7-9", "9-11", "11+"];
                priceRanges.forEach(range => {
                    const option = document.createElement('option');
                    option.value = range;
                    option.textContent = `€${range.replace('-', ' a €').replace('+', ' o más')}`;
                    priceFilter.appendChild(option);
                });
            }

            // RQF1
            function addPlayerToPitch(player) {
                const teamIdToAdd = player.id_equipo;
                let countSameTeam = 0;

                selectedPlayers.forEach(selectedPlayerId => {
                    const existingPlayer = allPlayers.find(p => p.id_jugador === selectedPlayerId);
                    if (existingPlayer && existingPlayer.id_equipo === teamIdToAdd) {
                        countSameTeam++;
                    }
                });

                if (countSameTeam >= 2) {
                    alert(`Ya tienes el máximo de 2 jugadores del equipo ${player.nombre_equipo}.`);
                    return;
                }
                const availableSlot = document.querySelector(
                    `.player-slot[data-position="${player.posicion}"]:not([data-player-id])`
                );

                //RQNF1
                if (availableSlot) {
                    const nameSpan = availableSlot.querySelector('.player-name');
                    const priceSpan = availableSlot.querySelector('.player-price');
                    const icon = availableSlot.querySelector('ion-icon');
                    if (icon) { 
                        const playerImage = document.createElement('img');
                        
                        playerImage.src = player.url_imagen_jugador || 'placeholder-player-face.png'; 
                        playerImage.alt = player.nombre_jugador;
                        
                       
                        icon.replaceWith(playerImage);
                    }

                    

                    nameSpan.textContent = player.nombre_jugador;
                    priceSpan.textContent = `$${player.valor_actual}M`;

                    availableSlot.dataset.playerId = player.id_jugador;

                    updateTeamState(player, 'add'); 

                    console.log(`Added ${player.nombre_jugador} to position ${player.posicion}`);

                } else {
                    alert(`Ya tienes el máximo de jugadores para la posición ${player.posicion}.`);
                }
            }

            function updateTeamState(player, action) {
                if (action === 'add' && player) {
                    selectedPlayers.push(player.id_jugador);
                    currentBudget -= parseFloat(player.valor_actual);
                } else if (action === 'remove' && player) {
                    selectedPlayers = selectedPlayers.filter(id => id !== player.id_jugador);
                    currentBudget += parseFloat(player.valor_actual);
                } else if (action === 'reset') { 
                    selectedPlayers = [];
                    currentBudget = 100.0;
                }

                const playersSelectedCount = selectedPlayers.length;
                playersRemainingDisplay.textContent = `${15 - playersSelectedCount}`;
                budgetDisplay.textContent = `$${currentBudget.toFixed(1)}m`;
                // RQNF2
                if (playersSelectedCount === 15 && currentBudget >= 0) {
                    continueButton.disabled = false;
                } else {
                    continueButton.disabled = true;
                }
                updatePlayerListUI();
            }
            

            function updatePlayerListUI() {
                const addButtons = tbodyListaJugs.querySelectorAll('.add-player-btn');
                addButtons.forEach(button => {
                    const row = button.closest('tr');
                    const playerId = parseInt(row.dataset.playerId);
                    button.disabled = selectedPlayers.includes(playerId);
                    const icon = button.querySelector('ion-icon');
                    if (selectedPlayers.includes(playerId)) {
                        icon.setAttribute('name', 'checkmark-circle-outline'); 
                        icon.style.color = '#059669'; 
                    } else {
                        icon.setAttribute('name', 'add-circle-outline');
                        icon.style.color = '#3b82f6'; 
                    }

                });
            }
            

            function resetPlayerSlot(slotElement) {
                const playerImage = slotElement.querySelector('img');

                if (playerImage) {
                    const shirtIcon = document.createElement('ion-icon');
                    shirtIcon.setAttribute('name', 'shirt-outline');

                    playerImage.replaceWith(shirtIcon);
                }

                const nameSpan = slotElement.querySelector('.player-name');
                const priceSpan = slotElement.querySelector('.player-price');
                nameSpan.textContent = "(Vacío)";
                priceSpan.textContent = "--M";

                delete slotElement.dataset.playerId;

                console.log("Slot reseteado.");
            }

            //RQF2
            function autoCompleteTeam() {
                console.log("Iniciando Auto-completar...");

                
                pitchSlots.forEach(slot => {
                    if (slot.dataset.playerId) { 
                        const playerToRemove = allPlayers.find(p => p.id_jugador === parseInt(slot.dataset.playerId));
                        if(playerToRemove) {
                            updateTeamState(playerToRemove, 'remove');
                            resetPlayerSlot(slot);
                        } else {
                            resetPlayerSlot(slot);
                        }
                    }
                });
                selectedPlayers = [];
                currentBudget = 100.0;
                updateTeamState(null, 'reset'); 
                const targetSquad = { 'G': 2, 'D': 5, 'M': 5, 'F': 3 };
                // RQNF3
                const maxPricePerPlayer = 8; 
                // RQNF4
                const maxPlayersPerTeam = 2;

                let availableCheapPlayers = allPlayers.filter(p => p.valor_actual <= maxPricePerPlayer);
                availableCheapPlayers.sort(() => 0.5 - Math.random());

                for (const position in targetSquad) {
                    const playersNeeded = targetSquad[position];
                    let playersAddedForPosition = 0;

                    for (const player of availableCheapPlayers) {
                        if (playersAddedForPosition >= playersNeeded) break;

                        if (
                            player.posicion === position &&                       
                            !selectedPlayers.includes(player.id_jugador) &&      
                            currentBudget >= player.valor_actual                 
                        ) {
                            const teamIdToAdd = player.id_equipo;
                            let countSameTeam = 0;
                            selectedPlayers.forEach(selectedPlayerId => {
                                const existingPlayer = allPlayers.find(p => p.id_jugador === selectedPlayerId);
                                if (existingPlayer && existingPlayer.id_equipo === teamIdToAdd) {
                                    countSameTeam++;
                                }
                            });

                            if (countSameTeam < maxPlayersPerTeam) {
                                addPlayerToPitch(player);
                                playersAddedForPosition++;
                            }
                        }
                    } 

                    if (playersAddedForPosition < playersNeeded) {
                        console.warn(`No se pudieron encontrar suficientes jugadores (${playersAddedForPosition}/${playersNeeded}) para la posición ${position} con el presupuesto y límite de equipo.`);
                        
                    }

                } 

                console.log("Auto-completar finalizado.");
            }

            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    displayPage(currentPage - 1);
                }
            });

            nextButton.addEventListener('click', () => {
                const totalPages = Math.ceil(allPlayers.length / playersPerPage);
                if (currentPage < totalPages) {
                    displayPage(currentPage + 1);
                }
            });
            
            
            pitchSlots.forEach(slot => {
                slot.addEventListener('click', () => {
                    const position = slot.dataset.position; 
                    const positionFilterSelect = document.getElementById('position-filter');

                    positionFilterSelect.value = position;

                    applyFiltersAndDisplay();

                    document.querySelector('.player-selection-column').scrollIntoView({ behavior: 'smooth' });
                });
            });
           
            tbodyListaJugs.addEventListener('click', (event) => {
                const addButton = event.target.closest('.add-player-btn');

                if (addButton) {
                    const playerRow = addButton.closest('tr');
                    const playerId = parseInt(playerRow.dataset.playerId); 
                    const playerToAdd = allPlayers.find(p => p.id_jugador === playerId);

                    if (playerToAdd) {
                        addPlayerToPitch(playerToAdd);
                    } else {
                        console.error("Couldn't find player data for ID:", playerId);
                    }
                }
            });

            pitchDisplay.addEventListener('click', (event) => {
                const clickedSlot = event.target.closest('.player-slot');

                if (clickedSlot && clickedSlot.dataset.playerId) {
                    const playerIdToRemove = parseInt(clickedSlot.dataset.playerId);

                    const playerToRemove = allPlayers.find(p => p.id_jugador === playerIdToRemove);

                    if (playerToRemove) {
                        resetPlayerSlot(clickedSlot);
                        updateTeamState(playerToRemove, 'remove'); 
                    } else {
                        console.error("Error: No se encontraron datos para el jugador a eliminar ID:", playerIdToRemove);
                    }
                }
            });

            

            cargarJugadoresDisponibles();

            positionFilter.addEventListener('change', applyFiltersAndDisplay);
            teamFilter.addEventListener('change', applyFiltersAndDisplay);
            priceFilter.addEventListener('change', applyFiltersAndDisplay);

            searchInput.addEventListener('input', applyFiltersAndDisplay);

            autoCompleteButton.addEventListener('click', () => {
                if (confirm('¿Estás seguro de que quieres autocompletar? Esto reemplazará tu selección actual.')) {
                    autoCompleteTeam();
                }
            });

            continueButton.addEventListener('click', async () => {
                
                const nombreEquipo = prompt("¡Tu equipo está listo! Dale un nombre:");
                if (!nombreEquipo || nombreEquipo.trim() === "") {
                    alert("Debes darle un nombre a tu equipo.");
                    return; 
                }

                const equipoData = {
                    nombreEquipo: nombreEquipo,
                    presupuestoRestante: currentBudget,
                    plantilla: selectedPlayers 
                };

                try {
                    // RQNF6
                    const response = await fetch('/api/fantasy/crear-equipo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(equipoData)
                    });

                    
                    if (response.status === 401 || response.status === 403) {
                        alert("Tu sesión ha expirado. Por favor, inicia sesión de nuevo.");
                        window.location.href = '/login.html';
                        return;
                    }

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Algo salió mal en el servidor.');
                    }

                    alert('¡Tu equipo ha sido creado con éxito!');
                    window.location.replace('/fantasy.html'); 

                } catch (error) {
                    alert('Error al crear tu equipo: ' + error.message);
                }
            });

        </script>

    </body>
</html>